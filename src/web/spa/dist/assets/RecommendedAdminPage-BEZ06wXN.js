import{u as ne,a as le,r as d,h as oe,j as a,L as W,c as A,i as de}from"./index-DYvV5D9I.js";import{A as G}from"./AdminPageHeader-DGBmdOnC.js";import{A as ce}from"./AdminTabs-D8VMsYk5.js";import{F as ue}from"./StarIcon-CXMenl6d.js";import"./ArrowLeftIcon-Cigvgpax.js";function P(){if(typeof window>"u")return null;const i=window.API_BASE_URL;return i?i.replace(/\/$/,""):null}function H(i){const l=i.trim();return l?l.toLowerCase().startsWith("http://")||l.toLowerCase().startsWith("https://")?l:`https://${l.replace(/^https?:\/\//i,"")}`:null}function z(i){try{return new URL(i.startsWith("http")?i:`https://${i}`).hostname}catch{return i}}const w=[{id:"highlights",label:"Highlights",fetchPath:"/admin/recommended/highlights/sites",savePath:"/admin/recommended/highlights/sites",generatePath:"/admin/recommended/highlights/generate",generateLabel:"Generate new cache",listLabel:"Highlights list",emptyMessage:"No highlights yet. Generate from the highlight category or add a URL above.",generateSuccessMessage:"Cache generated from sites in the highlight category.",saveSuccessMessage:"Highlights list saved.",buttonClass:"bg-violet-600 hover:bg-violet-500",viewPath:"/recommended/highlights"},{id:"highestRated",label:"Highest Rated",fetchPath:"/admin/recommended/highest-rated/sites",savePath:"/admin/recommended/highest-rated/sites",generatePath:"/admin/recommended/highest-rated/generate",generateLabel:"Generate new cache",listLabel:"Highest rated list",emptyMessage:"No items yet. Generate from top 12 by star rating or add a URL above.",generateSuccessMessage:"Cache generated from top 12 sites and media by star rating.",saveSuccessMessage:"Highest rated list saved.",buttonClass:"bg-amber-600 hover:bg-amber-500",viewPath:"/recommended/highest-rated"}],V=({config:i})=>{const[l,h]=d.useState([]),[g,f]=d.useState(null),[p,x]=d.useState(!1),[m,L]=d.useState("custom"),[c,j]=d.useState(null),[Z,R]=d.useState(null),[C,$]=d.useState(""),[b,D]=d.useState(null),[k,N]=d.useState(""),[E,U]=d.useState(!1),[K,S]=d.useState(null),[F,u]=d.useState(null),M=d.useRef([]);d.useEffect(()=>{M.current=l},[l]);const T=d.useCallback(async()=>{const e=P();if(e){u(null);try{const t=await A(`${e}${i.fetchPath}`);if(!t.ok){const r=await t.json().catch(()=>({}));throw new Error(r.error||"Failed to load")}const s=await t.json(),n=Array.isArray(s.sites)?s.sites:[];h(n.map(r=>typeof r=="string"?{type:"site",url:r,description:""}:(r.type||"site")==="media"?{type:"media",id:r.id||"",description:r.description||"",title:r.title,thumbnailKey:r.thumbnailKey,averageRating:r.averageRating}:{type:"site",url:r.url||"",description:r.description||"",title:r.title,logoKey:r.logoKey,averageRating:r.averageRating})),f(s.updatedAt??null)}catch(t){u((t==null?void 0:t.message)??"Failed to load sites.")}}},[A,i.fetchPath]);d.useEffect(()=>{T()},[T]);const _=async()=>{const e=P();if(e){x(!0),S(null),u(null);try{const t=await A(`${e}${i.generatePath}`,{method:"POST"}),s=await t.json();if(!t.ok)throw new Error(s.error||"Failed to generate");const n=Array.isArray(s.sites)?s.sites:[];h(n.map(r=>typeof r=="string"?{type:"site",url:r,description:""}:(r.type||"site")==="media"?{type:"media",id:r.id||"",description:r.description||"",title:r.title,thumbnailKey:r.thumbnailKey,averageRating:r.averageRating}:{type:"site",url:r.url||"",description:r.description||"",title:r.title,logoKey:r.logoKey,averageRating:r.averageRating})),f(s.updatedAt??null),S(i.generateSuccessMessage)}catch(t){u((t==null?void 0:t.message)??"Failed to generate cache.")}finally{x(!1)}}},y=async e=>{const t=P();if(t){U(!0),S(null),u(null);try{const s={sites:e.map(o=>o.type==="media"?{type:"media",id:o.id,description:o.description,...o.title&&{title:o.title},...o.thumbnailKey&&{thumbnailKey:o.thumbnailKey},...o.averageRating!=null&&{averageRating:o.averageRating}}:{type:"site",url:o.url,description:o.description,...o.title&&{title:o.title},...o.logoKey&&{logoKey:o.logoKey},...o.averageRating!=null&&{averageRating:o.averageRating}})},n=await A(`${t}${i.savePath}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}),r=await n.json();if(!n.ok)throw new Error(r.error||"Failed to save");h(e),S(i.saveSuccessMessage),f(r.updatedAt??null)}catch(s){u((s==null?void 0:s.message)??"Failed to save.")}finally{U(!1)}}},J=e=>{e.preventDefault();const t=H(C);if(t){if(l.some(s=>s.url===t)){u("URL already in list.");return}$(""),u(null),y([...l,{type:"site",url:t,description:""}])}},I=e=>e.type==="media"?(e.title||e.id||"").toLowerCase():z(e.url||"").toLowerCase(),v=d.useMemo(()=>{if(m==="custom")return[...l];const e=[...l];return e.sort((t,s)=>{const n=I(t),r=I(s);return m==="a-z"?n.localeCompare(r):r.localeCompare(n)}),e},[l,m]),q=e=>{const t=v[e];t.type!=="media"&&(D(e),N(t.url||""))},O=()=>{if(b===null)return;const e=H(k);if(!e){u("Invalid URL.");return}const t=v[b];if(t.type==="media")return;if(l.some(n=>n.type==="site"&&n.url===e&&n.url!==t.url)){u("URL already in list.");return}u(null);const s=l.map(n=>n.type==="site"&&n.url===t.url?{...n,url:e}:n);h(s),y(s),D(null),N("")},Q=()=>{D(null),N("")},X=(e,t)=>{h(s=>s.map(n=>(n.type==="media"?n.id===e.id:n.url===e.url)?{...n,description:t.slice(0,255)}:n))},Y=()=>{y(M.current)},ee=e=>j(e),te=(e,t)=>{e.preventDefault(),e.dataTransfer.dropEffect="move",R(t)},ae=()=>R(null),se=()=>{j(null),R(null)},re=(e,t)=>{if(e.preventDefault(),R(null),m!=="custom"||c===null||c===t){j(null);return}const s=[...v],[n]=s.splice(c,1);s.splice(t,0,n),h(s),y(s),j(null)},ie=e=>{u(null),y(l.filter(t=>t.type==="media"?t.id!==e.id:t.url!==e.url))},B=g?new Date(g).toLocaleString(void 0,{dateStyle:"medium",timeStyle:"short"}):null;return a.jsxs("section",{className:"rounded-xl border border-slate-800 bg-slate-950/60 p-4 space-y-4 max-w-2xl",children:[a.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[a.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[a.jsxs("h2",{className:"text-base font-semibold text-slate-200",children:[i.listLabel," (",l.length,")"]}),B&&a.jsxs("span",{className:"text-xs text-slate-500",children:["Cache was last updated ",B]})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(W,{to:i.viewPath,className:"text-sm text-slate-400 hover:text-slate-200",children:"View"}),a.jsx("button",{type:"button",onClick:_,disabled:p,className:`rounded-md px-4 py-2 text-sm font-medium text-white disabled:opacity-50 ${i.buttonClass}`,children:p?"Generating…":i.generateLabel})]})]}),a.jsx("div",{className:"flex flex-wrap items-center gap-3",children:a.jsx("div",{className:"inline-flex rounded-md border border-slate-700 bg-slate-950 p-0.5",children:["custom","a-z","z-a"].map(e=>a.jsx("button",{type:"button",onClick:()=>L(e),className:`rounded px-2 py-0.5 text-xs font-medium ${m===e?"bg-brand-orange text-slate-950":"text-slate-400 hover:text-slate-200"}`,children:e==="custom"?"Custom":e==="a-z"?"A–Z":"Z–A"},e))})}),a.jsxs("form",{onSubmit:J,className:"flex gap-2 flex-wrap items-end",children:[a.jsxs("div",{className:"flex-1 min-w-[12rem]",children:[a.jsx("label",{htmlFor:"newUrl",className:"block text-xs font-medium text-slate-400 mb-1",children:"Add URL"}),a.jsx("input",{id:"newUrl",type:"text",value:C,onChange:e=>$(e.target.value),placeholder:"https://example.com or example.com",className:"w-full rounded-md border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500 focus:border-brand-orange focus:outline-none focus:ring-1 focus:ring-brand-orange"})]}),a.jsx("button",{type:"submit",disabled:E||!C.trim(),className:"rounded-md bg-brand-orange px-4 py-2 text-sm font-medium text-slate-950 hover:bg-orange-500 disabled:opacity-50",children:"Add"})]}),a.jsx("ul",{className:"space-y-3",children:v.map((e,t)=>a.jsxs("li",{draggable:m==="custom"&&b===null,onDragStart:()=>ee(t),onDragOver:s=>te(s,t),onDragLeave:ae,onDragEnd:se,onDrop:s=>re(s,t),className:`flex flex-col gap-2 rounded-md border px-3 py-2 ${c===t?"border-brand-orange bg-slate-800 opacity-60":Z===t?"border-brand-orange/70 bg-slate-800/80":"border-slate-700 bg-slate-900"} ${m==="custom"&&b===null?"cursor-grab active:cursor-grabbing":""}`,children:[a.jsxs("div",{className:"flex items-center gap-2",children:[m==="custom"&&a.jsx(de,{className:"h-4 w-4 flex-shrink-0 text-slate-500","aria-hidden":!0}),b===t?a.jsx("input",{type:"text",value:k,onChange:s=>N(s.target.value),onBlur:O,onKeyDown:s=>{s.key==="Enter"&&O(),s.key==="Escape"&&Q()},autoFocus:!0,className:"flex-1 rounded-md border border-slate-600 bg-slate-900 px-2 py-1 text-sm text-slate-50 focus:border-brand-orange focus:outline-none focus:ring-1 focus:ring-brand-orange"}):e.type==="media"?a.jsx("span",{className:"font-medium text-slate-200 break-all flex-1",children:e.title||e.id}):a.jsx("button",{type:"button",onClick:()=>q(t),className:"font-medium text-slate-200 break-all flex-1 text-left hover:text-brand-orange hover:underline",children:z(e.url||"")}),i.id==="highestRated"&&e.averageRating!=null&&a.jsxs("span",{className:"flex items-center gap-0.5 text-amber-400 text-xs",children:[a.jsx(ue,{className:"h-3.5 w-3.5"}),e.averageRating]}),a.jsx("button",{type:"button",onClick:()=>ie(e),disabled:E||b!==null,className:"flex-shrink-0 rounded-md border border-red-500/60 bg-red-500/10 px-2 py-1 text-xs font-medium text-red-300 hover:bg-red-500/20 disabled:opacity-50",children:"Remove"})]}),a.jsxs("div",{children:[a.jsx("label",{htmlFor:`desc-${i.id}-${t}`,className:"block text-xs font-medium text-slate-400 mb-0.5",children:"Description"}),a.jsx("input",{id:`desc-${i.id}-${t}`,type:"text",value:e.description,onChange:s=>X(e,s.target.value),onBlur:Y,maxLength:255,placeholder:"One-line description (255 chars max)",disabled:E,className:"w-full rounded-md border border-slate-700 bg-slate-950 px-2 py-1 text-sm text-slate-50 placeholder:text-slate-500 focus:border-brand-orange focus:outline-none focus:ring-1 focus:ring-brand-orange disabled:opacity-50"}),a.jsxs("span",{className:"text-[10px] text-slate-500",children:[e.description.length,"/255"]})]})]},e.id||e.url||t))}),v.length===0&&a.jsx("p",{className:"text-sm text-slate-500",children:i.emptyMessage}),K&&a.jsx("div",{className:"rounded-md border border-emerald-500/60 bg-emerald-500/10 px-3 py-2 text-sm text-emerald-200",children:K}),F&&a.jsx("div",{className:"rounded-md border border-red-500/60 bg-red-500/10 px-3 py-2 text-sm text-red-200",children:F})]})},be=()=>{const{user:i}=ne(),[l,h]=le(),g=l.get("tab"),f=g==="highest-rated"||g==="highestRated"?"highestRated":"highlights",[p,x]=d.useState(f);d.useEffect(()=>{x(g==="highest-rated"||g==="highestRated"?"highestRated":"highlights")},[g]);const m=c=>{x(c),h({tab:c==="highestRated"?"highest-rated":c},{replace:!0})},L=oe(i??null,"manager");return w.find(c=>c.id===p)??w[0],L?a.jsxs("div",{className:"space-y-6",children:[a.jsx(G,{title:"Recommended Admin",description:"Manage highlighted and highest-rated site lists. Generate from categories or star ratings, or edit manually.",actions:a.jsx(W,{to:"/recommended/highlights",className:"btn-secondary text-sm !px-4 !py-2",children:"View highlights"})}),a.jsx(ce,{tabs:w.map(c=>({id:c.id,label:c.label})),activeId:p,onSelect:c=>m(c)}),p==="highlights"&&a.jsx(V,{config:w[0]}),p==="highestRated"&&a.jsx(V,{config:w[1]})]}):a.jsx("div",{className:"space-y-6",children:a.jsx(G,{title:"Recommended Admin",description:"Only Manager or SuperAdmin users can edit the recommended caches."})})};export{be as default};
