import{d as Me,u as Je,a as Ke,r as a,h as We,c as d,j as t}from"./index-Cx0qYlZr.js";import{A as _e}from"./AdminPageHeader-Dt-7-yNV.js";import{A as ze}from"./AdminTabs-Bl2sYCAF.js";import"./ArrowLeftIcon-Cn-75ax8.js";function p(){if(typeof window>"u")return null;const N=window.API_BASE_URL;return N?N.replace(/\/$/,""):null}const Ae=100,He=5*1024*1024,et=()=>{const N=Me(),{user:Te}=Je(),[X,Ue]=Ke(),A=X.get("tab"),De=A==="categories"?"categories":"add",[f,T]=a.useState(De);a.useEffect(()=>{T(A==="categories"?"categories":"add")},[A]);const Y=e=>{T(e);const s=new URLSearchParams(X);e==="categories"?s.set("tab","categories"):s.delete("tab"),Ue(s)},[h,v]=a.useState([]),[S,Z]=a.useState(""),[Q,V]=a.useState(""),[ee,U]=a.useState(""),[te,D]=a.useState(!1),[b,R]=a.useState(null),[g,P]=a.useState(null),[I,y]=a.useState(null),[O,se]=a.useState(""),[x,B]=a.useState([]),[F,ae]=a.useState(""),[$,ie]=a.useState(!1),[ne,re]=a.useState(!1),[oe,le]=a.useState(null),[ce,c]=a.useState(null),[de,ue]=a.useState(!1),G=a.useRef(null),[Re,C]=a.useState(!0),[me,u]=a.useState(null),[q,pe]=a.useState(""),[ge,xe]=a.useState(""),[fe,he]=a.useState(!1),[be,ye]=a.useState(null),[w,we]=a.useState(null),[k,M]=a.useState(""),[J,K]=a.useState(""),[je,Ne]=a.useState(!1),[ve,W]=a.useState(null),[E,Se]=a.useState(null),j=We(Te??null,"manager");a.useEffect(()=>{var r;if(!j)return;const e=p();if(!e)return;const s=window;(r=s.auth)!=null&&r.getAccessToken&&(async()=>{if(!await new Promise(l=>s.auth.getAccessToken(l)))return;const o=await d(`${e}/categories`);if(!o.ok)return;const n=((await o.json()).categories??[]).map(l=>({id:l.PK||l.id||"",name:l.name||l.PK||"",description:l.description}));v(n)})()},[j]),a.useEffect(()=>{function e(s){G.current&&!G.current.contains(s.target)&&ie(!1)}if($)return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[$]);const Ce=h.filter(e=>!x.includes(e.id)&&(!F.trim()||(e.name||"").toLowerCase().includes(F.toLowerCase()))),Pe=e=>{var o;const s=(o=e.target.files)==null?void 0:o[0];if(R(s??null),s&&se(""),y(null),g&&(URL.revokeObjectURL(g),P(null)),!s)return;if(s.size>He){y("Logo must be 5 MB or smaller.");return}const r=new Image;r.onload=()=>{if(r.naturalWidth<Ae||r.naturalHeight<Ae){y("Logo must be at least 100×100 pixels.");return}y(null),P(URL.createObjectURL(s))},r.onerror=()=>y("Please choose a valid image file."),r.src=URL.createObjectURL(s)},Ie=e=>{x.includes(e)||B([...x,e]),ae("")},Oe=e=>{B(x.filter(s=>s!==e))},ke=async()=>{var r;const e=p();if(!e){u("API URL not set."),C(!1);return}if(!((r=window.auth)!=null&&r.getAccessToken)){u("Sign in required."),C(!1);return}C(!0),u(null);try{const o=await d(`${e}/categories`);if(!o.ok)throw new Error(await o.text());const n=((await o.json()).categories??[]).map(l=>({id:l.PK||l.id||"",name:l.name||l.PK||"",description:l.description}));v(n)}catch(o){u((o==null?void 0:o.message)??"Failed to load categories.")}finally{C(!1)}};a.useEffect(()=>{j&&f==="categories"&&ke()},[j,f]);const Be=async()=>{var o;const e=S.trim();if(!e){c("Enter URL first.");return}const s=p();if(!s){c("API URL not set.");return}if(!((o=window.auth)!=null&&o.getAccessToken)){c("Sign in required.");return}ue(!0),c(null);try{const i=await d(`${s}/sites/generate-description`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:e})});if(!i.ok)throw new Error(await i.text());const n=await i.json();U(n.description??""),D(!0)}catch(i){c((i==null?void 0:i.message)??"Failed to generate description.")}finally{ue(!1)}},Fe=async e=>{var i;e.preventDefault();const s=S.trim();if(!s){c("URL is required.");return}const r=p();if(!r){c("API URL not set.");return}if(!((i=window.auth)!=null&&i.getAccessToken)){c("Sign in required.");return}if(!(b&&I)){re(!0),c(null),le(null);try{let n=null;if(O.trim()){const m=await d(`${r}/sites/logo-from-url`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({siteId:"new",imageUrl:O.trim()})});if(!m.ok){const H=await m.json().catch(()=>({}));throw new Error(H.error||await m.text())}const L=await m.json();L.key&&(n=L.key)}else if(b){const m=await d(`${r}/sites/logo-upload`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({siteId:"new",contentType:b.type||"image/png"})});if(!m.ok)throw new Error("Logo upload request failed");const{uploadUrl:L,key:H}=await m.json();if(!(await fetch(L,{method:"PUT",headers:{"Content-Type":b.type||"image/png"},body:b})).ok)throw new Error("Logo upload failed");n=H}const l={url:s,title:Q.trim()||s,description:ee.trim(),categoryIds:x};te&&(l.descriptionAiGenerated=!0),n&&(l.logoKey=n);const z=await d(`${r}/sites`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)});if(!z.ok)throw new Error(await z.text());const Le=await z.json();le(`Site added: ${Le.title||Le.url||s}`),Z(""),V(""),U(""),D(!1),R(null),g&&URL.revokeObjectURL(g),P(null),B([]),setTimeout(()=>N("/websites"),1500)}catch(n){c((n==null?void 0:n.message)??"Failed to add site.")}finally{re(!1)}}},$e=e=>{we(e.id),M(e.name),K(e.description??"")},_=()=>{we(null),M(""),K(""),W(null)},Ge=async e=>{var o;if(e.preventDefault(),!w)return;const s=p();if(!(!s||!((o=window.auth)!=null&&o.getAccessToken))){Ne(!0),W(null);try{const i=await d(`${s}/categories`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:w,name:k.trim(),description:J.trim()||void 0})});if(!i.ok)throw new Error(await i.text());v(n=>n.map(l=>l.id===w?{...l,name:k.trim(),description:J.trim()||void 0}:l)),_()}catch(i){W((i==null?void 0:i.message)??"Failed to update category.")}finally{Ne(!1)}}},Ee=async e=>{var o;if(!window.confirm("Delete this category? Sites using it will lose this category."))return;const s=p();if(!(!s||!((o=window.auth)!=null&&o.getAccessToken))){Se(e);try{const i=await d(`${s}/categories?id=${encodeURIComponent(e)}`,{method:"DELETE"});if(!i.ok)throw new Error(await i.text());v(n=>n.filter(l=>l.id!==e)),w===e&&_()}catch(i){u((i==null?void 0:i.message)??"Failed to delete category.")}finally{Se(null)}}},qe=async e=>{var i;e.preventDefault();const s=q.trim();if(!s)return;const r=p();if(!(!r||!((i=window.auth)!=null&&i.getAccessToken))){he(!0),ye(null),u(null);try{const n=await d(`${r}/categories`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:s,description:ge.trim()})});if(!n.ok)throw new Error(await n.text());pe(""),xe(""),ye("Category created."),ke()}catch(n){u((n==null?void 0:n.message)??"Failed to create category.")}finally{he(!1)}}};return j?t.jsxs("div",{className:"space-y-6",children:[t.jsx(_e,{title:"Websites",description:"Add sites and manage website categories."}),t.jsx(ze,{tabs:[{id:"add",label:"Add Site"},{id:"categories",label:"Website Categories"}],activeId:f,onSelect:e=>Y(e)}),f==="add"&&t.jsxs("form",{className:"card p-6 space-y-4 max-w-xl",onSubmit:Fe,children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"URL *"}),t.jsx("input",{type:"url",value:S,onChange:e=>Z(e.target.value),placeholder:"https://example.com",required:!0,className:"input-field"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"Title (optional)"}),t.jsx("input",{type:"text",value:Q,onChange:e=>V(e.target.value),placeholder:"Display title",className:"input-field"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"Description (optional)"}),t.jsx("textarea",{value:ee,onChange:e=>{U(e.target.value),D(!1)},placeholder:"Short description",rows:4,className:"input-field resize-y"}),t.jsx("button",{type:"button",onClick:Be,disabled:de||!S.trim(),className:"mt-2 btn-secondary text-sm !px-3 !py-1.5 disabled:opacity-50",children:de?"Generating…":"Generate AI description"}),te&&t.jsx("span",{className:"ml-2 text-xs uppercase tracking-wide text-slate-500",children:"AI summary"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"Logo (optional, min 100×100, max 5 MB)"}),t.jsx("input",{type:"file",accept:"image/png,image/jpeg,image/gif,image/webp",onChange:Pe,className:"block w-full text-xs text-slate-300 file:mr-3 file:rounded-md file:border-0 file:bg-slate-800 file:px-3 file:py-1.5 file:text-slate-100"}),t.jsx("p",{className:"mt-2 text-xs text-slate-500",children:"Or paste image URL (image will be copied to S3 on save):"}),t.jsx("input",{type:"url",value:O,onChange:e=>{se(e.target.value),e.target.value.trim()&&R(null)},placeholder:"https://example.com/logo.png",className:"input-field mt-1"}),g&&t.jsx("div",{className:"mt-2",children:t.jsx("img",{src:g,alt:"Preview",className:"h-16 w-16 rounded-lg border border-slate-700 object-cover"})}),I&&t.jsx("p",{className:"mt-1 text-xs text-red-400",children:I})]}),t.jsxs("div",{ref:G,className:"relative",children:[t.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"Categories (optional)"}),t.jsx("input",{type:"text",value:F,onChange:e=>ae(e.target.value),onFocus:()=>ie(!0),placeholder:"Search and select…",className:"input-field w-full",autoComplete:"off"}),$&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"absolute left-0 right-0 top-full z-10 mt-1 max-h-48 overflow-auto scrollbar-thin rounded-md border border-slate-700 bg-slate-900 shadow-lg",children:Ce.length?Ce.map(e=>t.jsx("button",{type:"button",onClick:()=>Ie(e.id),className:"block w-full px-3 py-2 text-left text-sm text-slate-200 hover:bg-slate-800",children:e.name},e.id)):t.jsx("p",{className:"px-3 py-2 text-xs text-slate-500",children:"No matches"})}),h.length===0&&t.jsxs("p",{className:"mt-1 text-xs text-slate-500",children:["No categories."," ",t.jsx("button",{type:"button",onClick:()=>Y("categories"),className:"text-brand-orange hover:underline",children:"Create categories"})]})]}),t.jsx("div",{className:"mt-2 flex flex-wrap gap-1",children:x.map(e=>{const s=h.find(r=>r.id===e);return t.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-slate-800 px-2 py-0.5 text-xs text-slate-200",children:[(s==null?void 0:s.name)??e,t.jsx("button",{type:"button",onClick:()=>Oe(e),className:"hover:text-red-400","aria-label":"Remove",children:"×"})]},e)})})]}),t.jsx("button",{type:"submit",disabled:ne,className:"btn-primary disabled:opacity-50",children:ne?"Adding…":"Add Site"}),oe&&t.jsx("div",{className:"rounded-md border border-emerald-500/60 bg-emerald-500/10 px-3 py-2 text-sm text-emerald-200",children:oe}),ce&&t.jsx("div",{className:"rounded-md border border-red-500/60 bg-red-500/10 px-3 py-2 text-sm text-red-200",children:ce})]}),f==="categories"&&t.jsxs(t.Fragment,{children:[t.jsxs("form",{className:"card p-6 space-y-3 max-w-md",onSubmit:qe,children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"New category name"}),t.jsx("input",{type:"text",value:q,onChange:e=>pe(e.target.value),placeholder:"e.g. Developer tools",className:"input-field w-full"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"Description (optional)"}),t.jsx("input",{type:"text",value:ge,onChange:e=>xe(e.target.value),placeholder:"Optional description",className:"input-field w-full"})]}),t.jsx("button",{type:"submit",disabled:fe||!q.trim(),className:"btn-primary disabled:opacity-50",children:fe?"Creating…":"Create category"}),be&&t.jsx("div",{className:"rounded-md border border-emerald-500/60 bg-emerald-500/10 px-3 py-2 text-sm text-emerald-200",children:be}),me&&t.jsx("div",{className:"rounded-md border border-red-500/60 bg-red-500/10 px-3 py-2 text-sm text-red-200",children:me})]}),t.jsxs("section",{className:"card p-6 mt-6",children:[t.jsx("h2",{className:"text-sm font-medium text-slate-300 mb-2",children:"Existing categories"}),Re?t.jsx("p",{className:"text-sm text-slate-500",children:"Loading…"}):h.length===0?t.jsx("p",{className:"text-sm text-slate-500",children:"No categories yet. Create one above."}):t.jsx("ul",{className:"space-y-2",children:h.map(e=>t.jsx("li",{className:"rounded-lg border border-slate-800 bg-slate-950/60 px-3 py-2 text-sm",children:w===e.id?t.jsxs("form",{onSubmit:Ge,className:"space-y-2",children:[t.jsx("input",{type:"text",value:k,onChange:s=>M(s.target.value),placeholder:"Name",required:!0,className:"input-field w-full",autoFocus:!0}),t.jsx("input",{type:"text",value:J,onChange:s=>K(s.target.value),placeholder:"Description (optional)",className:"input-field w-full"}),t.jsxs("div",{className:"flex gap-2 flex-wrap",children:[t.jsx("button",{type:"submit",disabled:je||!k.trim(),className:"btn-primary text-sm !px-3 !py-1.5 disabled:opacity-50",children:je?"Saving…":"Save"}),t.jsx("button",{type:"button",onClick:_,className:"btn-secondary text-sm !px-3 !py-1.5",children:"Cancel"}),t.jsx("button",{type:"button",onClick:()=>Ee(e.id),disabled:E===e.id,className:"rounded-md border border-red-500/60 px-3 py-1.5 text-xs font-medium text-red-400 hover:bg-red-500/20 disabled:opacity-50",children:E===e.id?"Deleting…":"Delete"})]}),ve&&t.jsx("p",{className:"text-xs text-red-400",children:ve})]}):t.jsxs("div",{className:"flex items-center justify-between gap-2",children:[t.jsxs("button",{type:"button",onClick:()=>$e(e),className:"flex-1 min-w-0 text-left hover:bg-slate-800/50 rounded px-1 -mx-1 py-1 -my-1 transition-colors",children:[t.jsx("span",{className:"font-medium text-slate-200",children:e.name}),e.description&&t.jsx("span",{className:"text-slate-500 truncate max-w-xs ml-2",children:e.description})]}),t.jsx("button",{type:"button",onClick:()=>Ee(e.id),disabled:E===e.id,className:"rounded px-2 py-1 text-xs font-medium text-red-400 hover:bg-red-500/20 disabled:opacity-50 shrink-0","aria-label":"Delete category",children:E===e.id?"…":"Delete"})]})},e.id))})]})]})]}):t.jsxs("div",{className:"space-y-4",children:[t.jsx("h1",{className:"text-2xl font-semibold tracking-tight text-slate-50",children:"Websites"}),t.jsx("p",{className:"text-sm text-slate-400",children:"Manager or SuperAdmin access is required."})]})};export{et as default};
