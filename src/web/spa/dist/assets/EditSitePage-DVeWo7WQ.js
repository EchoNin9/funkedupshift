import{b as ve,d as Ne,u as Se,r as a,h as Ce,c as p,j as e,L as ke}from"./index-DYvV5D9I.js";import{A as C}from"./AdminPageHeader-DGBmdOnC.js";import"./ArrowLeftIcon-Cigvgpax.js";function k(){if(typeof window>"u")return null;const b=window.API_BASE_URL;return b?b.replace(/\/$/,""):null}const ce=100,Le=5*1024*1024,Ie=()=>{const{id:b}=ve(),M=Ne(),{user:de}=Se(),[ue,v]=a.useState(!0),[g,_]=a.useState(""),[L,J]=a.useState(""),[K,U]=a.useState(""),[R,N]=a.useState(!1),[y,A]=a.useState([]),[z,E]=a.useState(""),[H,W]=a.useState(""),[V,me]=a.useState(null),[I,X]=a.useState(!1),[j,T]=a.useState(null),[D,O]=a.useState(""),[m,P]=a.useState(null),[$,w]=a.useState(null),[Y,pe]=a.useState([]),[x,G]=a.useState([]),[B,Z]=a.useState(""),[ge,Q]=a.useState(!1),[F,ee]=a.useState(!1),[te,se]=a.useState(!1),[ae,ne]=a.useState(!1),[ie,le]=a.useState(null),[S,o]=a.useState(null),q=Ce(de??null,"manager"),c=b?decodeURIComponent(b):"";a.useEffect(()=>{var l;if(!q||!c){v(!1);return}const t=k();if(!t){o("API URL not set."),v(!1);return}if(!((l=window.auth)!=null&&l.getAccessToken)){o("Sign in required."),v(!1);return}let i=!1;return(async()=>{try{const s=await p(`${t}/sites?id=${encodeURIComponent(c)}`);if(s.status===404||!s.ok){i||o("Site not found.");return}const r=(await s.json()).site;if(i||!r)return;_(r.url??""),J(r.title??""),U(r.description??""),N(!!r.descriptionAiGenerated),A(Array.isArray(r.tags)?r.tags:[]),E(""),W(r.scrapedContent??""),me(r.logoUrl||null),G(Array.isArray(r.categoryIds)?r.categoryIds:[]);const d=await p(`${t}/categories`);if(d.ok&&!i){const h=await d.json();pe((h.categories??[]).map(u=>({id:u.PK||u.id||"",name:u.name||u.PK||""})))}}catch(s){i||o((s==null?void 0:s.message)??"Failed to load.")}finally{i||v(!1)}})(),()=>{i=!0}},[q,c]);const xe=t=>{var l;const n=(l=t.target.files)==null?void 0:l[0];if(T(n??null),O(""),w(null),X(!1),m&&(URL.revokeObjectURL(m),P(null)),!n)return;if(n.size>Le){w("Logo must be 5 MB or smaller.");return}const i=new Image;i.onload=()=>{if(i.naturalWidth<ce||i.naturalHeight<ce){w("Logo must be at least 100×100 pixels.");return}w(null),P(URL.createObjectURL(n))},i.onerror=()=>w("Please choose a valid image file."),i.src=URL.createObjectURL(n)},fe=t=>{x.includes(t)||G([...x,t]),Z(""),Q(!1)},he=t=>{G(x.filter(n=>n!==t))},oe=()=>{const t=z.trim();t&&!y.includes(t)&&A([...y,t]),E("")},be=t=>A(y.filter(n=>n!==t)),re=Y.filter(t=>!x.includes(t.id)&&(!B.trim()||(t.name||"").toLowerCase().includes(B.toLowerCase()))),ye=async()=>{var l;const t=g.trim();if(!t){o("Enter URL first.");return}const n=k();if(!n){o("API URL not set.");return}if(!((l=window.auth)!=null&&l.getAccessToken)){o("Sign in required.");return}ne(!0),o(null);try{const s=await p(`${n}/sites/generate-description`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:t})});if(!s.ok)throw new Error(await s.text());const f=await s.json();U(f.description??""),N(!0)}catch(s){o((s==null?void 0:s.message)??"Failed to generate description.")}finally{ne(!1)}},je=async t=>{var l;if(t.preventDefault(),!c)return;const n=k();if(!n){o("API URL not set.");return}if(!((l=window.auth)!=null&&l.getAccessToken)){o("Sign in required.");return}if(!(j&&$)){ee(!0),o(null),le(null);try{let s=null;if(j){const d=await p(`${n}/sites/logo-upload`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({siteId:c,contentType:j.type||"image/png"})});if(!d.ok)throw new Error("Logo upload request failed");const{uploadUrl:h,key:u}=await d.json();if(!(await fetch(h,{method:"PUT",headers:{"Content-Type":j.type||"image/png"},body:j})).ok)throw new Error("Logo upload failed");s=u}else if(D.trim()){const d=await p(`${n}/sites/logo-from-url`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({siteId:c,imageUrl:D.trim()})});if(!d.ok){const u=await d.json().catch(()=>({}));throw new Error(u.error||await d.text())}const h=await d.json();h.key&&(s=h.key)}const f={id:c,url:g.trim(),title:L.trim()||g.trim(),description:K.trim(),descriptionAiGenerated:R,categoryIds:x,tags:y,scrapedContent:H.trim()||void 0};I?f.deleteLogo=!0:s&&(f.logoKey=s);const r=await p(`${n}/sites`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(f)});if(!r.ok)throw new Error(await r.text());le("Site updated."),m&&URL.revokeObjectURL(m),T(null),P(null),O(""),setTimeout(()=>M(`/websites/${encodeURIComponent(c)}`),1200)}catch(s){o((s==null?void 0:s.message)??"Failed to update site.")}finally{ee(!1)}}},we=async()=>{var i;if(!c||!window.confirm("Delete this site? This cannot be undone."))return;const t=k();if(!(!t||!((i=window.auth)!=null&&i.getAccessToken))){se(!0),o(null);try{const l=await p(`${t}/sites`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:c})});if(!l.ok)throw new Error(await l.text());M("/websites")}catch(l){o((l==null?void 0:l.message)??"Failed to delete site.")}finally{se(!1)}}};return q?ue?e.jsxs("div",{className:"space-y-6",children:[e.jsx(C,{title:"Edit Site"}),e.jsx("p",{className:"text-sm text-slate-400",children:"Loading…"})]}):S&&!g&&!L?e.jsxs("div",{className:"space-y-6",children:[e.jsx(C,{title:"Edit Site"}),e.jsx("div",{className:"rounded-md border border-red-500/60 bg-red-500/10 px-3 py-2 text-sm text-red-200",children:S})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(C,{title:"Edit Site",description:"Update URL, title, description, logo, categories, and scraped content.",actions:e.jsx(ke,{to:`/websites/${encodeURIComponent(c)}`,className:"btn-secondary text-sm !px-4 !py-2",children:"View site"})}),e.jsxs("form",{className:"card p-6 space-y-4 max-w-xl",onSubmit:je,children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"URL *"}),e.jsx("input",{type:"url",value:g,onChange:t=>_(t.target.value),required:!0,className:"input-field"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"Title"}),e.jsx("input",{type:"text",value:L,onChange:t=>J(t.target.value),className:"input-field"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"Description"}),e.jsx("textarea",{value:K,onChange:t=>{U(t.target.value),N(!1)},placeholder:"Short description",rows:4,className:"input-field resize-y"}),e.jsx("button",{type:"button",onClick:ye,disabled:ae||!g.trim(),className:"mt-2 btn-secondary text-sm !px-3 !py-1.5 disabled:opacity-50",children:ae?"Generating…":"Generate AI description"}),R&&e.jsx("span",{className:"ml-2 text-xs uppercase tracking-wide text-slate-500",children:"AI summary"}),e.jsxs("label",{className:"mt-2 block inline-flex items-center gap-2 text-xs text-slate-500",children:[e.jsx("input",{type:"checkbox",checked:R,onChange:t=>N(t.target.checked)}),"AI-generated summary"]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"Logo"}),V&&!I&&!m&&e.jsxs("div",{className:"mb-2 flex items-center gap-2",children:[e.jsx("img",{src:V,alt:"Current logo",className:"h-12 w-12 rounded-lg border border-slate-700 object-cover"}),e.jsxs("label",{className:"text-xs text-slate-400",children:[e.jsx("input",{type:"checkbox",checked:I,onChange:t=>X(t.target.checked)}),e.jsx("span",{className:"ml-1",children:"Remove logo"})]})]}),e.jsx("input",{type:"file",accept:"image/png,image/jpeg,image/gif,image/webp",onChange:xe,className:"block w-full text-xs text-slate-300 file:mr-3 file:rounded-md file:border-0 file:bg-slate-800 file:px-3 file:py-1.5 file:text-slate-100"}),e.jsx("p",{className:"mt-2 text-xs text-slate-500",children:"Or paste image URL (image will be copied to S3 on save):"}),e.jsx("input",{type:"url",value:D,onChange:t=>{O(t.target.value),t.target.value.trim()&&T(null)},placeholder:"https://example.com/logo.png",className:"input-field mt-1"}),m&&e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:m,alt:"New logo",className:"h-16 w-16 rounded-lg border border-slate-700 object-cover"})}),$&&e.jsx("p",{className:"mt-1 text-xs text-red-400",children:$})]}),e.jsxs("div",{className:"relative",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"Categories"}),e.jsx("input",{type:"text",value:B,onChange:t=>Z(t.target.value),onFocus:()=>Q(!0),placeholder:"Search and select…",className:"input-field w-full",autoComplete:"off"}),ge&&e.jsx("div",{className:"absolute left-0 right-0 top-full z-10 mt-1 max-h-48 overflow-auto scrollbar-thin rounded-md border border-slate-700 bg-slate-900 shadow-lg",children:re.length?re.map(t=>e.jsx("button",{type:"button",onClick:()=>fe(t.id),className:"block w-full px-3 py-2 text-left text-sm text-slate-200 hover:bg-slate-800",children:t.name},t.id)):e.jsx("p",{className:"px-3 py-2 text-xs text-slate-500",children:"No matches"})}),e.jsx("div",{className:"mt-2 flex flex-wrap gap-1",children:x.map(t=>{const n=Y.find(i=>i.id===t);return e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-slate-800 px-2 py-0.5 text-xs text-slate-200",children:[(n==null?void 0:n.name)??t,e.jsx("button",{type:"button",onClick:()=>he(t),className:"hover:text-red-400","aria-label":"Remove",children:"×"})]},t)})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"Tags"}),e.jsx("div",{className:"flex flex-wrap gap-1 mb-2",children:y.map(t=>e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-slate-800 px-2 py-0.5 text-xs text-slate-200",children:[t,e.jsx("button",{type:"button",onClick:()=>be(t),className:"hover:text-red-400","aria-label":"Remove",children:"×"})]},t))}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:z,onChange:t=>E(t.target.value),onKeyDown:t=>t.key==="Enter"&&(t.preventDefault(),oe()),placeholder:"Add tag",className:"input-field flex-1"}),e.jsx("button",{type:"button",onClick:oe,className:"btn-secondary text-sm !px-3 !py-2",children:"Add"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"Scraped content (optional)"}),e.jsx("textarea",{value:H,onChange:t=>W(t.target.value),rows:6,placeholder:"Paste or edit scraped content (e.g. README, about page)",className:"input-field w-full font-mono resize-y"})]}),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsx("button",{type:"submit",disabled:F,className:"btn-primary disabled:opacity-50",children:F?"Saving…":"Save changes"}),e.jsx("button",{type:"button",onClick:we,disabled:te||F,className:"btn-secondary border-red-500/60 text-red-400 hover:bg-red-500/20 disabled:opacity-50",children:te?"Deleting…":"Delete entry"})]}),ie&&e.jsx("div",{className:"rounded-md border border-emerald-500/60 bg-emerald-500/10 px-3 py-2 text-sm text-emerald-200",children:ie}),S&&e.jsx("div",{className:"rounded-md border border-red-500/60 bg-red-500/10 px-3 py-2 text-sm text-red-200",children:S})]})]}):e.jsx("div",{className:"space-y-6",children:e.jsx(C,{title:"Edit Site",description:"Manager or SuperAdmin access is required."})})};export{Ie as default};
