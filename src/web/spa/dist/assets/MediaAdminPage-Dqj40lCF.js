import{d as Fe,u as Me,a as $e,r as s,h as Be,c,j as t}from"./index-BLy7dBGz.js";import{A as Ke}from"./AdminPageHeader-Cp2eWpo9.js";import{A as We}from"./AdminTabs-CFKWRmtN.js";import"./ArrowLeftIcon-Gu1dq-Pj.js";function f(){if(typeof window>"u")return null;const p=window.API_BASE_URL;return p?p.replace(/\/$/,""):null}function Je(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,p=>{const N=Math.random()*16|0;return(p==="x"?N:N&3|8).toString(16)})}const Xe=()=>{const p=Fe(),{user:N}=Me(),[E,je]=$e(),P=E.get("tab"),ve=P==="categories"?"categories":"add",[b,U]=s.useState(ve);s.useEffect(()=>{U(P==="categories"?"categories":"add")},[P]);const J=e=>{U(e);const a=new URLSearchParams(E);e==="categories"?a.set("tab","categories"):a.delete("tab"),je(a)},[y,C]=s.useState([]),[q,z]=s.useState(""),[_,H]=s.useState(""),[o,V]=s.useState(null),[m,R]=s.useState(null),[x,D]=s.useState(null),[Ne,w]=s.useState(!1),[g,A]=s.useState([]),[I,G]=s.useState(""),[L,Q]=s.useState(!1),[X,Y]=s.useState(!1),[Z,ee]=s.useState(null),[te,h]=s.useState(null),O=s.useRef(null),[Ce,S]=s.useState(!0),[ae,u]=s.useState(null),[F,se]=s.useState(""),[ie,ne]=s.useState(""),[re,le]=s.useState(!1),[oe,de]=s.useState(null),[j,ce]=s.useState(null),[k,M]=s.useState(""),[$,B]=s.useState(""),[me,ue]=s.useState(!1),[pe,K]=s.useState(null),[T,xe]=s.useState(null),v=Be(N??null,"manager");s.useEffect(()=>{if(!v)return;const e=f();e&&(async()=>{try{const a=await c(`${e}/media-categories`);if(!a.ok)return;const n=((await a.json()).categories??[]).map(i=>({id:i.PK||i.id||"",name:i.name||i.PK||"",description:i.description}));C(n)}catch{}})()},[v]),s.useEffect(()=>{function e(a){O.current&&!O.current.contains(a.target)&&Q(!1)}if(L)return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[L]);const ge=y.filter(e=>!g.includes(e.id)&&(!I.trim()||(e.name||"").toLowerCase().includes(I.toLowerCase()))),Se=e=>{var l;const a=(l=e.target.files)==null?void 0:l[0];V(a??null),D(null),h(null),m&&(URL.revokeObjectURL(m),R(null)),a&&(R(URL.createObjectURL(a)),a.type.startsWith("video/")&&w(!0))},he=s.useRef(null),ke=e=>{var l;const a=(l=e.target.files)==null?void 0:l[0];a&&a.type.startsWith("image/")&&(D(a),w(!1)),e.target.value=""},Te=e=>{g.includes(e)||A([...g,e]),G("")},Ee=e=>{A(g.filter(a=>a!==e))},fe=async()=>{var l;const e=f();if(!e){u("API URL not set."),S(!1);return}if(!((l=window.auth)!=null&&l.getAccessToken)){u("Sign in required."),S(!1);return}S(!0),u(null);try{const n=await c(`${e}/media-categories`);if(!n.ok)throw new Error(await n.text());const d=((await n.json()).categories??[]).map(r=>({id:r.PK||r.id||"",name:r.name||r.PK||"",description:r.description}));C(d)}catch(n){u((n==null?void 0:n.message)??"Failed to load media categories.")}finally{S(!1)}};s.useEffect(()=>{v&&b==="categories"&&fe()},[v,b]);const Pe=async e=>{var d;if(e.preventDefault(),!o){h("Please select an image or video file.");return}const a=f();if(!a){h("API URL not set.");return}if(!((d=window.auth)!=null&&d.getAccessToken)){h("Sign in required.");return}const n=o.type.startsWith("video/")?"video":"image",i=`MEDIA#${Je()}`;Y(!0),h(null),ee(null);try{const r=await c(`${a}/media/upload`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({mediaId:i,mediaType:n,contentType:o.type||(n==="image"?"image/png":"video/mp4")})});if(!r.ok)throw new Error("Upload request failed");const{uploadUrl:Ae,key:Ie}=await r.json(),ye=await c(`${a}/media`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:i,mediaKey:Ie,title:q.trim()||"Untitled",description:_.trim(),mediaType:n,categoryIds:g})});if(!ye.ok)throw new Error(await ye.text());if(!(await fetch(Ae,{method:"PUT",headers:{"Content-Type":o.type||(n==="image"?"image/png":"video/mp4")},body:o})).ok)throw new Error("File upload failed");if(n==="video"&&x){const we=await c(`${a}/media/thumbnail-upload`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({mediaId:i,contentType:x.type||"image/jpeg"})});if(we.ok){const{uploadUrl:Le,key:Oe}=await we.json();(await fetch(Le,{method:"PUT",headers:{"Content-Type":x.type||"image/jpeg"},body:x})).ok&&((await c(`${a}/media`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:i,thumbnailKey:Oe})})).ok||console.warn("Thumbnail uploaded but update failed"))}}ee("Media added."),z(""),H(""),V(null),D(null),m&&URL.revokeObjectURL(m),R(null),A([]),setTimeout(()=>p("/media"),1500)}catch(r){h((r==null?void 0:r.message)??"Failed to add media.")}finally{Y(!1)}},Ue=e=>{ce(e.id),M(e.name),B(e.description??"")},W=()=>{ce(null),M(""),B(""),K(null)},Re=async e=>{var n;if(e.preventDefault(),!j)return;const a=f();if(!(!a||!((n=window.auth)!=null&&n.getAccessToken))){ue(!0),K(null);try{const i=await c(`${a}/media-categories`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:j,name:k.trim(),description:$.trim()||void 0})});if(!i.ok)throw new Error(await i.text());C(d=>d.map(r=>r.id===j?{...r,name:k.trim(),description:$.trim()||void 0}:r)),W()}catch(i){K((i==null?void 0:i.message)??"Failed to update media category.")}finally{ue(!1)}}},be=async e=>{var n;if(!window.confirm("Delete this media category? Media using it will lose this category."))return;const a=f();if(!(!a||!((n=window.auth)!=null&&n.getAccessToken))){xe(e);try{const i=await c(`${a}/media-categories?id=${encodeURIComponent(e)}`,{method:"DELETE"});if(!i.ok)throw new Error(await i.text());C(d=>d.filter(r=>r.id!==e)),j===e&&W()}catch(i){u((i==null?void 0:i.message)??"Failed to delete media category.")}finally{xe(null)}}},De=async e=>{var i;e.preventDefault();const a=F.trim();if(!a)return;const l=f();if(!(!l||!((i=window.auth)!=null&&i.getAccessToken))){le(!0),de(null),u(null);try{const d=await c(`${l}/media-categories`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:a,description:ie.trim()})});if(!d.ok)throw new Error(await d.text());se(""),ne(""),de("Media category created."),fe()}catch(d){u((d==null?void 0:d.message)??"Failed to create media category.")}finally{le(!1)}}};return v?t.jsxs("div",{className:"space-y-6",children:[t.jsx(Ke,{title:"Media",description:"Add media and manage media categories."}),t.jsx(We,{tabs:[{id:"add",label:"Add Media"},{id:"categories",label:"Media Categories"}],activeId:b,onSelect:e=>J(e)}),b==="add"&&t.jsxs("form",{className:"card p-6 space-y-4 max-w-xl",onSubmit:Pe,children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"Title (optional)"}),t.jsx("input",{type:"text",value:q,onChange:e=>z(e.target.value),placeholder:"Untitled",className:"input-field"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"Description (optional)"}),t.jsx("textarea",{value:_,onChange:e=>H(e.target.value),placeholder:"Description",rows:3,className:"input-field resize-y"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"Image or video *"}),t.jsx("input",{type:"file",accept:"image/png,image/jpeg,image/gif,image/webp,video/mp4,video/webm",onChange:Se,className:"block w-full text-xs text-slate-300 file:mr-3 file:rounded-md file:border-0 file:bg-slate-800 file:px-3 file:py-1.5 file:text-slate-100"}),t.jsx("p",{className:"mt-1 text-xs text-slate-500",children:"Videos get an auto-generated thumbnail from the 3–4 sec frame. Change it when editing."}),(o==null?void 0:o.type.startsWith("video/"))&&x&&t.jsxs("p",{className:"mt-1 text-xs text-emerald-400",children:["Custom thumbnail: ",x.name," ",t.jsx("button",{type:"button",onClick:()=>w(!0),className:"text-brand-orange hover:underline",children:"Change"})]}),Ne&&(o==null?void 0:o.type.startsWith("video/"))&&t.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/60",role:"dialog","aria-modal":"true","aria-labelledby":"thumbnail-dialog-title",onClick:()=>w(!1),children:t.jsxs("div",{className:"rounded-lg border border-slate-700 bg-slate-900 p-6 shadow-xl max-w-sm w-full mx-4",onClick:e=>e.stopPropagation(),children:[t.jsx("h2",{id:"thumbnail-dialog-title",className:"text-lg font-medium text-slate-100 mb-2",children:"Add thumbnail"}),t.jsx("p",{className:"text-sm text-slate-400 mb-4",children:"Choose a custom thumbnail image for this video (optional)."}),t.jsx("input",{ref:he,type:"file",accept:"image/png,image/jpeg,image/gif,image/webp",onChange:ke,className:"hidden"}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("button",{type:"button",onClick:()=>{var e;return(e=he.current)==null?void 0:e.click()},className:"rounded-md bg-slate-700 px-3 py-2 text-sm font-medium text-slate-100 hover:bg-slate-600",children:"Choose file"}),t.jsx("button",{type:"button",onClick:()=>w(!1),className:"rounded-md border border-slate-600 px-3 py-2 text-sm font-medium text-slate-300 hover:bg-slate-800",children:"Skip"})]})]})}),m&&t.jsx("div",{className:"mt-2",children:o!=null&&o.type.startsWith("video/")?t.jsx("video",{src:m,muted:!0,controls:!0,className:"max-h-32 rounded-lg border border-slate-700"}):t.jsx("img",{src:m,alt:"Preview",className:"h-24 w-auto rounded-lg border border-slate-700 object-cover"})})]}),t.jsxs("div",{ref:O,className:"relative",children:[t.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"Media categories (optional)"}),t.jsx("input",{type:"text",value:I,onChange:e=>G(e.target.value),onFocus:()=>Q(!0),placeholder:"Search and select…",className:"input-field w-full",autoComplete:"off"}),L&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"absolute left-0 right-0 top-full z-10 mt-1 max-h-48 overflow-auto scrollbar-thin rounded-md border border-slate-700 bg-slate-900 shadow-lg",children:ge.length?ge.map(e=>t.jsx("button",{type:"button",onClick:()=>Te(e.id),className:"block w-full px-3 py-2 text-left text-sm text-slate-200 hover:bg-slate-800",children:e.name},e.id)):t.jsx("p",{className:"px-3 py-2 text-xs text-slate-500",children:"No matches"})}),y.length===0&&t.jsxs("p",{className:"mt-1 text-xs text-slate-500",children:["No categories."," ",t.jsx("button",{type:"button",onClick:()=>J("categories"),className:"text-brand-orange hover:underline",children:"Create media categories"})]})]}),t.jsx("div",{className:"mt-2 flex flex-wrap gap-1",children:g.map(e=>{const a=y.find(l=>l.id===e);return t.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-slate-800 px-2 py-0.5 text-xs text-slate-200",children:[(a==null?void 0:a.name)??e,t.jsx("button",{type:"button",onClick:()=>Ee(e),className:"hover:text-red-400","aria-label":"Remove",children:"×"})]},e)})})]}),t.jsx("button",{type:"submit",disabled:X||!o,className:"btn-primary disabled:opacity-50",children:X?"Uploading…":"Add Media"}),Z&&t.jsx("div",{className:"rounded-md border border-emerald-500/60 bg-emerald-500/10 px-3 py-2 text-sm text-emerald-200",children:Z}),te&&t.jsx("div",{className:"rounded-md border border-red-500/60 bg-red-500/10 px-3 py-2 text-sm text-red-200",children:te})]}),b==="categories"&&t.jsxs(t.Fragment,{children:[t.jsxs("form",{className:"card p-6 space-y-3 max-w-md",onSubmit:De,children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"New category name"}),t.jsx("input",{type:"text",value:F,onChange:e=>se(e.target.value),placeholder:"e.g. Tutorials",className:"input-field w-full"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"Description (optional)"}),t.jsx("input",{type:"text",value:ie,onChange:e=>ne(e.target.value),placeholder:"Optional description",className:"input-field w-full"})]}),t.jsx("button",{type:"submit",disabled:re||!F.trim(),className:"btn-primary disabled:opacity-50",children:re?"Creating…":"Create media category"}),oe&&t.jsx("div",{className:"rounded-md border border-emerald-500/60 bg-emerald-500/10 px-3 py-2 text-sm text-emerald-200",children:oe}),ae&&t.jsx("div",{className:"rounded-md border border-red-500/60 bg-red-500/10 px-3 py-2 text-sm text-red-200",children:ae})]}),t.jsxs("section",{className:"card p-6 mt-6",children:[t.jsx("h2",{className:"text-sm font-medium text-slate-300 mb-2",children:"Existing media categories"}),Ce?t.jsx("p",{className:"text-sm text-slate-500",children:"Loading…"}):y.length===0?t.jsx("p",{className:"text-sm text-slate-500",children:"No media categories yet. Create one above."}):t.jsx("ul",{className:"space-y-2",children:y.map(e=>t.jsx("li",{className:"rounded-lg border border-slate-800 bg-slate-950/60 px-3 py-2 text-sm",children:j===e.id?t.jsxs("form",{onSubmit:Re,className:"space-y-2",children:[t.jsx("input",{type:"text",value:k,onChange:a=>M(a.target.value),placeholder:"Name",required:!0,className:"input-field w-full",autoFocus:!0}),t.jsx("input",{type:"text",value:$,onChange:a=>B(a.target.value),placeholder:"Description (optional)",className:"input-field w-full"}),t.jsxs("div",{className:"flex gap-2 flex-wrap",children:[t.jsx("button",{type:"submit",disabled:me||!k.trim(),className:"btn-primary text-sm !px-3 !py-1.5 disabled:opacity-50",children:me?"Saving…":"Save"}),t.jsx("button",{type:"button",onClick:W,className:"btn-secondary text-sm !px-3 !py-1.5",children:"Cancel"}),t.jsx("button",{type:"button",onClick:()=>be(e.id),disabled:T===e.id,className:"rounded-md border border-red-500/60 px-3 py-1.5 text-xs font-medium text-red-400 hover:bg-red-500/20 disabled:opacity-50",children:T===e.id?"Deleting…":"Delete"})]}),pe&&t.jsx("p",{className:"text-xs text-red-400",children:pe})]}):t.jsxs("div",{className:"flex items-center justify-between gap-2",children:[t.jsxs("button",{type:"button",onClick:()=>Ue(e),className:"flex-1 min-w-0 text-left hover:bg-slate-800/50 rounded px-1 -mx-1 py-1 -my-1 transition-colors",children:[t.jsx("span",{className:"font-medium text-slate-200",children:e.name}),e.description&&t.jsx("span",{className:"text-slate-500 truncate max-w-xs ml-2",children:e.description})]}),t.jsx("button",{type:"button",onClick:()=>be(e.id),disabled:T===e.id,className:"rounded px-2 py-1 text-xs font-medium text-red-400 hover:bg-red-500/20 disabled:opacity-50 shrink-0","aria-label":"Delete category",children:T===e.id?"…":"Delete"})]})},e.id))})]})]})]}):t.jsxs("div",{className:"space-y-4",children:[t.jsx("h1",{className:"text-2xl font-semibold tracking-tight text-slate-50",children:"Media"}),t.jsx("p",{className:"text-sm text-slate-400",children:"Manager or SuperAdmin access is required."})]})};export{Xe as default};
