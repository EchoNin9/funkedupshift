import{d as Me,u as Oe,a as $e,r as s,h as Be,c,j as e,L as Ke}from"./index-CqR0r56c.js";import{F as We}from"./ArrowLeftIcon-NR7umhpe.js";function f(){if(typeof window>"u")return null;const x=window.API_BASE_URL;return x?x.replace(/\/$/,""):null}function Je(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,x=>{const N=Math.random()*16|0;return(x==="x"?N:N&3|8).toString(16)})}const He=()=>{const x=Me(),{user:N}=Oe(),[E,je]=$e(),P=E.get("tab"),ve=P==="categories"?"categories":"add",[p,R]=s.useState(ve);s.useEffect(()=>{R(P==="categories"?"categories":"add")},[P]);const U=t=>{R(t);const a=new URLSearchParams(E);t==="categories"?a.set("tab","categories"):a.delete("tab"),je(a)},[y,C]=s.useState([]),[q,z]=s.useState(""),[_,V]=s.useState(""),[l,G]=s.useState(null),[m,D]=s.useState(null),[g,A]=s.useState(null),[Ne,w]=s.useState(!1),[b,L]=s.useState([]),[F,H]=s.useState(""),[I,Q]=s.useState(!1),[X,Y]=s.useState(!1),[Z,ee]=s.useState(null),[te,h]=s.useState(null),M=s.useRef(null),[Ce,S]=s.useState(!0),[ae,u]=s.useState(null),[O,se]=s.useState(""),[ne,re]=s.useState(""),[oe,ie]=s.useState(!1),[le,de]=s.useState(null),[j,ce]=s.useState(null),[k,$]=s.useState(""),[B,K]=s.useState(""),[me,ue]=s.useState(!1),[xe,W]=s.useState(null),[T,pe]=s.useState(null),v=Be(N??null,"manager");s.useEffect(()=>{if(!v)return;const t=f();t&&(async()=>{try{const a=await c(`${t}/media-categories`);if(!a.ok)return;const r=((await a.json()).categories??[]).map(n=>({id:n.PK||n.id||"",name:n.name||n.PK||"",description:n.description}));C(r)}catch{}})()},[v]),s.useEffect(()=>{function t(a){M.current&&!M.current.contains(a.target)&&Q(!1)}if(I)return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[I]);const ge=y.filter(t=>!b.includes(t.id)&&(!F.trim()||(t.name||"").toLowerCase().includes(F.toLowerCase()))),Se=t=>{var i;const a=(i=t.target.files)==null?void 0:i[0];G(a??null),A(null),h(null),m&&(URL.revokeObjectURL(m),D(null)),a&&(D(URL.createObjectURL(a)),a.type.startsWith("video/")&&w(!0))},be=s.useRef(null),ke=t=>{var i;const a=(i=t.target.files)==null?void 0:i[0];a&&a.type.startsWith("image/")&&(A(a),w(!1)),t.target.value=""},Te=t=>{b.includes(t)||L([...b,t]),H("")},Ee=t=>{L(b.filter(a=>a!==t))},he=async()=>{var i;const t=f();if(!t){u("API URL not set."),S(!1);return}if(!((i=window.auth)!=null&&i.getAccessToken)){u("Sign in required."),S(!1);return}S(!0),u(null);try{const r=await c(`${t}/media-categories`);if(!r.ok)throw new Error(await r.text());const d=((await r.json()).categories??[]).map(o=>({id:o.PK||o.id||"",name:o.name||o.PK||"",description:o.description}));C(d)}catch(r){u((r==null?void 0:r.message)??"Failed to load media categories.")}finally{S(!1)}};s.useEffect(()=>{v&&p==="categories"&&he()},[v,p]);const Pe=async t=>{var d;if(t.preventDefault(),!l){h("Please select an image or video file.");return}const a=f();if(!a){h("API URL not set.");return}if(!((d=window.auth)!=null&&d.getAccessToken)){h("Sign in required.");return}const r=l.type.startsWith("video/")?"video":"image",n=`MEDIA#${Je()}`;Y(!0),h(null),ee(null);try{const o=await c(`${a}/media/upload`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({mediaId:n,mediaType:r,contentType:l.type||(r==="image"?"image/png":"video/mp4")})});if(!o.ok)throw new Error("Upload request failed");const{uploadUrl:Ae,key:Le}=await o.json(),ye=await c(`${a}/media`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:n,mediaKey:Le,title:q.trim()||"Untitled",description:_.trim(),mediaType:r,categoryIds:b})});if(!ye.ok)throw new Error(await ye.text());if(!(await fetch(Ae,{method:"PUT",headers:{"Content-Type":l.type||(r==="image"?"image/png":"video/mp4")},body:l})).ok)throw new Error("File upload failed");if(r==="video"&&g){const we=await c(`${a}/media/thumbnail-upload`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({mediaId:n,contentType:g.type||"image/jpeg"})});if(we.ok){const{uploadUrl:Fe,key:Ie}=await we.json();(await fetch(Fe,{method:"PUT",headers:{"Content-Type":g.type||"image/jpeg"},body:g})).ok&&((await c(`${a}/media`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:n,thumbnailKey:Ie})})).ok||console.warn("Thumbnail uploaded but update failed"))}}ee("Media added."),z(""),V(""),G(null),A(null),m&&URL.revokeObjectURL(m),D(null),L([]),setTimeout(()=>x("/media"),1500)}catch(o){h((o==null?void 0:o.message)??"Failed to add media.")}finally{Y(!1)}},Re=t=>{ce(t.id),$(t.name),K(t.description??"")},J=()=>{ce(null),$(""),K(""),W(null)},Ue=async t=>{var r;if(t.preventDefault(),!j)return;const a=f();if(!(!a||!((r=window.auth)!=null&&r.getAccessToken))){ue(!0),W(null);try{const n=await c(`${a}/media-categories`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:j,name:k.trim(),description:B.trim()||void 0})});if(!n.ok)throw new Error(await n.text());C(d=>d.map(o=>o.id===j?{...o,name:k.trim(),description:B.trim()||void 0}:o)),J()}catch(n){W((n==null?void 0:n.message)??"Failed to update media category.")}finally{ue(!1)}}},fe=async t=>{var r;if(!window.confirm("Delete this media category? Media using it will lose this category."))return;const a=f();if(!(!a||!((r=window.auth)!=null&&r.getAccessToken))){pe(t);try{const n=await c(`${a}/media-categories?id=${encodeURIComponent(t)}`,{method:"DELETE"});if(!n.ok)throw new Error(await n.text());C(d=>d.filter(o=>o.id!==t)),j===t&&J()}catch(n){u((n==null?void 0:n.message)??"Failed to delete media category.")}finally{pe(null)}}},De=async t=>{var n;t.preventDefault();const a=O.trim();if(!a)return;const i=f();if(!(!i||!((n=window.auth)!=null&&n.getAccessToken))){ie(!0),de(null),u(null);try{const d=await c(`${i}/media-categories`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:a,description:ne.trim()})});if(!d.ok)throw new Error(await d.text());se(""),re(""),de("Media category created."),he()}catch(d){u((d==null?void 0:d.message)??"Failed to create media category.")}finally{ie(!1)}}};return v?e.jsxs("div",{className:"space-y-6",children:[e.jsxs(Ke,{to:"/media",className:"inline-flex items-center gap-1 text-sm text-slate-400 hover:text-slate-200",children:[e.jsx(We,{className:"h-4 w-4"}),"Back to Media"]}),e.jsxs("header",{className:"space-y-2",children:[e.jsx("h1",{className:"text-2xl font-semibold tracking-tight text-slate-50",children:"Media"}),e.jsx("p",{className:"text-sm text-slate-400",children:"Add media and manage media categories."})]}),e.jsxs("div",{className:"flex gap-2 border-b border-slate-800 pb-2",children:[e.jsx("button",{type:"button",onClick:()=>U("add"),className:`px-4 py-2 rounded-md text-sm font-medium ${p==="add"?"bg-slate-800 text-slate-100":"text-slate-400 hover:text-slate-200"}`,children:"Add Media"}),e.jsx("button",{type:"button",onClick:()=>U("categories"),className:`px-4 py-2 rounded-md text-sm font-medium ${p==="categories"?"bg-slate-800 text-slate-100":"text-slate-400 hover:text-slate-200"}`,children:"Media Categories"})]}),p==="add"&&e.jsxs("form",{className:"space-y-4 max-w-xl",onSubmit:Pe,children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"Title (optional)"}),e.jsx("input",{type:"text",value:q,onChange:t=>z(t.target.value),placeholder:"Untitled",className:"w-full rounded-md border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500 focus:border-brand-orange focus:outline-none focus:ring-1 focus:ring-brand-orange"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"Description (optional)"}),e.jsx("textarea",{value:_,onChange:t=>V(t.target.value),placeholder:"Description",rows:3,className:"w-full rounded-md border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500 focus:border-brand-orange focus:outline-none focus:ring-1 focus:ring-brand-orange"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"Image or video *"}),e.jsx("input",{type:"file",accept:"image/png,image/jpeg,image/gif,image/webp,video/mp4,video/webm",onChange:Se,className:"block w-full text-xs text-slate-300 file:mr-3 file:rounded-md file:border-0 file:bg-slate-800 file:px-3 file:py-1.5 file:text-slate-100"}),e.jsx("p",{className:"mt-1 text-xs text-slate-500",children:"Videos get an auto-generated thumbnail from the 3–4 sec frame. Change it when editing."}),(l==null?void 0:l.type.startsWith("video/"))&&g&&e.jsxs("p",{className:"mt-1 text-xs text-emerald-400",children:["Custom thumbnail: ",g.name," ",e.jsx("button",{type:"button",onClick:()=>w(!0),className:"text-brand-orange hover:underline",children:"Change"})]}),Ne&&(l==null?void 0:l.type.startsWith("video/"))&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/60",role:"dialog","aria-modal":"true","aria-labelledby":"thumbnail-dialog-title",onClick:()=>w(!1),children:e.jsxs("div",{className:"rounded-lg border border-slate-700 bg-slate-900 p-6 shadow-xl max-w-sm w-full mx-4",onClick:t=>t.stopPropagation(),children:[e.jsx("h2",{id:"thumbnail-dialog-title",className:"text-lg font-medium text-slate-100 mb-2",children:"Add thumbnail"}),e.jsx("p",{className:"text-sm text-slate-400 mb-4",children:"Choose a custom thumbnail image for this video (optional)."}),e.jsx("input",{ref:be,type:"file",accept:"image/png,image/jpeg,image/gif,image/webp",onChange:ke,className:"hidden"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",onClick:()=>{var t;return(t=be.current)==null?void 0:t.click()},className:"rounded-md bg-slate-700 px-3 py-2 text-sm font-medium text-slate-100 hover:bg-slate-600",children:"Choose file"}),e.jsx("button",{type:"button",onClick:()=>w(!1),className:"rounded-md border border-slate-600 px-3 py-2 text-sm font-medium text-slate-300 hover:bg-slate-800",children:"Skip"})]})]})}),m&&e.jsx("div",{className:"mt-2",children:l!=null&&l.type.startsWith("video/")?e.jsx("video",{src:m,muted:!0,controls:!0,className:"max-h-32 rounded-lg border border-slate-700"}):e.jsx("img",{src:m,alt:"Preview",className:"h-24 w-auto rounded-lg border border-slate-700 object-cover"})})]}),e.jsxs("div",{ref:M,className:"relative",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"Media categories (optional)"}),e.jsx("input",{type:"text",value:F,onChange:t=>H(t.target.value),onFocus:()=>Q(!0),placeholder:"Search and select…",className:"w-full rounded-md border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500 focus:border-brand-orange focus:outline-none focus:ring-1 focus:ring-brand-orange"}),I&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"absolute left-0 right-0 top-full z-10 mt-1 max-h-48 overflow-auto rounded-md border border-slate-700 bg-slate-900 shadow-lg",children:ge.length?ge.map(t=>e.jsx("button",{type:"button",onClick:()=>Te(t.id),className:"block w-full px-3 py-2 text-left text-sm text-slate-200 hover:bg-slate-800",children:t.name},t.id)):e.jsx("p",{className:"px-3 py-2 text-xs text-slate-500",children:"No matches"})}),y.length===0&&e.jsxs("p",{className:"mt-1 text-xs text-slate-500",children:["No categories."," ",e.jsx("button",{type:"button",onClick:()=>U("categories"),className:"text-brand-orange hover:underline",children:"Create media categories"})]})]}),e.jsx("div",{className:"mt-2 flex flex-wrap gap-1",children:b.map(t=>{const a=y.find(i=>i.id===t);return e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-slate-800 px-2 py-0.5 text-xs text-slate-200",children:[(a==null?void 0:a.name)??t,e.jsx("button",{type:"button",onClick:()=>Ee(t),className:"hover:text-red-400","aria-label":"Remove",children:"×"})]},t)})})]}),e.jsx("button",{type:"submit",disabled:X||!l,className:"inline-flex items-center justify-center rounded-md bg-brand-orange px-4 py-2 text-sm font-semibold text-slate-950 hover:bg-orange-500 disabled:opacity-50",children:X?"Uploading…":"Add Media"}),Z&&e.jsx("div",{className:"rounded-md border border-emerald-500/60 bg-emerald-500/10 px-3 py-2 text-sm text-emerald-200",children:Z}),te&&e.jsx("div",{className:"rounded-md border border-red-500/60 bg-red-500/10 px-3 py-2 text-sm text-red-200",children:te})]}),p==="categories"&&e.jsxs(e.Fragment,{children:[e.jsxs("form",{className:"space-y-3 max-w-md",onSubmit:De,children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"New category name"}),e.jsx("input",{type:"text",value:O,onChange:t=>se(t.target.value),placeholder:"e.g. Tutorials",className:"w-full rounded-md border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500 focus:border-brand-orange focus:outline-none focus:ring-1 focus:ring-brand-orange"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"Description (optional)"}),e.jsx("input",{type:"text",value:ne,onChange:t=>re(t.target.value),placeholder:"Optional description",className:"w-full rounded-md border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500 focus:border-brand-orange focus:outline-none focus:ring-1 focus:ring-brand-orange"})]}),e.jsx("button",{type:"submit",disabled:oe||!O.trim(),className:"inline-flex items-center justify-center rounded-md bg-brand-orange px-4 py-2 text-sm font-semibold text-slate-950 hover:bg-orange-500 disabled:opacity-50",children:oe?"Creating…":"Create media category"}),le&&e.jsx("div",{className:"rounded-md border border-emerald-500/60 bg-emerald-500/10 px-3 py-2 text-sm text-emerald-200",children:le}),ae&&e.jsx("div",{className:"rounded-md border border-red-500/60 bg-red-500/10 px-3 py-2 text-sm text-red-200",children:ae})]}),e.jsxs("section",{children:[e.jsx("h2",{className:"text-sm font-medium text-slate-300 mb-2",children:"Existing media categories"}),Ce?e.jsx("p",{className:"text-sm text-slate-500",children:"Loading…"}):y.length===0?e.jsx("p",{className:"text-sm text-slate-500",children:"No media categories yet. Create one above."}):e.jsx("ul",{className:"space-y-2",children:y.map(t=>e.jsx("li",{className:"rounded-lg border border-slate-800 bg-slate-950/60 px-3 py-2 text-sm",children:j===t.id?e.jsxs("form",{onSubmit:Ue,className:"space-y-2",children:[e.jsx("input",{type:"text",value:k,onChange:a=>$(a.target.value),placeholder:"Name",required:!0,className:"w-full rounded-md border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500 focus:border-brand-orange focus:outline-none focus:ring-1 focus:ring-brand-orange",autoFocus:!0}),e.jsx("input",{type:"text",value:B,onChange:a=>K(a.target.value),placeholder:"Description (optional)",className:"w-full rounded-md border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500 focus:border-brand-orange focus:outline-none focus:ring-1 focus:ring-brand-orange"}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsx("button",{type:"submit",disabled:me||!k.trim(),className:"rounded-md bg-brand-orange px-3 py-1.5 text-xs font-medium text-slate-950 hover:bg-orange-500 disabled:opacity-50",children:me?"Saving…":"Save"}),e.jsx("button",{type:"button",onClick:J,className:"rounded-md border border-slate-700 px-3 py-1.5 text-xs font-medium text-slate-300 hover:bg-slate-800",children:"Cancel"}),e.jsx("button",{type:"button",onClick:()=>fe(t.id),disabled:T===t.id,className:"rounded-md border border-red-500/60 px-3 py-1.5 text-xs font-medium text-red-400 hover:bg-red-500/20 disabled:opacity-50",children:T===t.id?"Deleting…":"Delete"})]}),xe&&e.jsx("p",{className:"text-xs text-red-400",children:xe})]}):e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("button",{type:"button",onClick:()=>Re(t),className:"flex-1 min-w-0 text-left hover:bg-slate-800/50 rounded px-1 -mx-1 py-1 -my-1 transition-colors",children:[e.jsx("span",{className:"font-medium text-slate-200",children:t.name}),t.description&&e.jsx("span",{className:"text-slate-500 truncate max-w-xs ml-2",children:t.description})]}),e.jsx("button",{type:"button",onClick:()=>fe(t.id),disabled:T===t.id,className:"rounded px-2 py-1 text-xs font-medium text-red-400 hover:bg-red-500/20 disabled:opacity-50 shrink-0","aria-label":"Delete category",children:T===t.id?"…":"Delete"})]})},t.id))})]})]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("h1",{className:"text-2xl font-semibold tracking-tight text-slate-50",children:"Media"}),e.jsx("p",{className:"text-sm text-slate-400",children:"Manager or SuperAdmin access is required."})]})};export{He as default};
