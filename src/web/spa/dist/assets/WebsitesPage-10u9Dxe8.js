import{u as z,a as G,r as n,f as R,j as t,L as H}from"./index-CgafoLrZ.js";function E(){if(typeof window>"u")return null;const f=window.API_BASE_URL;return f?f.replace(/\/$/,""):null}const L=10,V=()=>{const{user:f}=z(),[S,C]=G(),[b,M]=n.useState([]),[c,I]=n.useState(()=>S.get("q")??""),[o,$]=n.useState(()=>{const e=S.get("categoryIds");return e?e.split(",").filter(Boolean):[]}),[d,D]=n.useState(()=>S.get("categoryMode")==="or"?"or":"and"),[A,B]=n.useState(!1),[j,U]=n.useState(""),[u,O]=n.useState("avgDesc"),[h,g]=n.useState(1),[F,P]=n.useState(!1),[T,y]=n.useState(null),_=!!f,k=n.useRef(null),[v,q]=n.useState([]);n.useEffect(()=>{const e=E();if(!e)return;let a=!1;return R(`${e}/categories`).then(r=>r.ok?r.json():Promise.reject(new Error("Failed to load categories"))).then(r=>{if(a)return;const s=(r.categories??[]).map(l=>({id:l.PK||l.id||"",name:l.name||l.PK||""}));s.sort((l,i)=>(l.name||"").localeCompare(i.name||"")),q(s)}).catch(()=>{}),()=>{a=!0}},[]);const N=n.useMemo(()=>{if(d==="or"&&v.length>0)return v;const e=new Map;b.forEach(r=>(r.categories||[]).forEach(s=>{s.id&&!e.has(s.id)&&e.set(s.id,s)}));const a=[...v];return e.forEach(r=>{a.some(s=>s.id===r.id)||a.push(r)}),a.sort((r,s)=>(r.name||"").localeCompare(s.name||"")),a},[v,d,b]),K=n.useMemo(()=>N.filter(e=>!o.includes(e.id)&&(!j.trim()||(e.name||"").toLowerCase().includes(j.toLowerCase()))),[N,o,j]),m=c.trim().length>0||o.length>0;n.useEffect(()=>{if(m){const e=new URLSearchParams;c.trim()&&e.set("q",c.trim()),o.length&&(e.set("categoryIds",o.join(",")),e.set("categoryMode",d)),C(e,{replace:!0})}else C({},{replace:!0})},[m,c,o,d,C]),n.useEffect(()=>{if(!m){M([]),g(1),P(!1),y(null);return}const e=E();if(!e){y("API URL not set. Deploy via CI or set window.API_BASE_URL in config.js.");return}let a=!1;async function r(){P(!0),y(null);try{const s=new URLSearchParams;s.set("limit","100"),c.trim()&&s.set("q",c.trim()),o.length>0&&(s.set("categoryIds",o.join(",")),s.set("categoryMode",d));const l=await R(`${e}/sites?${s.toString()}`);if(!l.ok){const x=await l.text();throw new Error(`HTTP ${l.status}: ${x}`)}const i=await l.json();if(a)return;M(i.sites??[]),g(1)}catch(s){a||y((s==null?void 0:s.message)??"Failed to load sites.")}finally{a||P(!1)}}return r(),()=>{a=!0}},[m,c,o,d]),n.useEffect(()=>{function e(a){k.current&&!k.current.contains(a.target)&&B(!1)}if(A)return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[A]);const p=n.useMemo(()=>{const e=[...b];return e.sort((a,r)=>{const s=(a.title||a.url||a.PK||"").toLowerCase(),l=(r.title||r.url||r.PK||"").toLowerCase(),i=typeof a.averageRating=="number"?a.averageRating:0,x=typeof r.averageRating=="number"?r.averageRating:0;return u==="avgDesc"?x!==i?x-i:s.localeCompare(l):u==="avgAsc"?i!==x?i-x:s.localeCompare(l):u==="alphaAsc"?s.localeCompare(l):u==="alphaDesc"?l.localeCompare(s):0}),e},[b,u]),w=Math.max(1,Math.ceil(p.length/L)),W=p.slice((h-1)*L,h*L),Z=async(e,a)=>{const r=E();if(!r)return;const s=window;if(!s.auth||typeof s.auth.getAccessToken!="function")return;const l=await new Promise(i=>{s.auth.getAccessToken(x=>i(x))});l&&await R(`${r}/stars`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},body:JSON.stringify({siteId:e,rating:a})}).catch(()=>{})};return t.jsxs("div",{className:"space-y-6",children:[t.jsxs("header",{className:"space-y-2",children:[t.jsx("h1",{className:"text-2xl font-semibold tracking-tight text-slate-50",children:"Websites"}),t.jsx("p",{className:"text-sm text-slate-400",children:"Browse curated sites, see ratings, and jump straight into the interesting corners of the internet."})]}),t.jsxs("section",{className:"rounded-xl border border-slate-800 bg-slate-950/60 p-4 space-y-4","aria-label":"Search and filter",children:[t.jsxs("form",{className:"flex flex-col gap-3 sm:flex-row sm:items-center",onSubmit:e=>{e.preventDefault(),I(c.trim())},children:[t.jsx("input",{type:"text",value:c,onChange:e=>I(e.target.value),placeholder:"Search sites (title, URL, description)…",className:"input-field flex-1"}),t.jsx("button",{type:"submit",className:"btn-primary min-h-[44px] !px-4 !py-2 text-sm",children:"Search"})]}),t.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-start gap-4 sm:gap-6",children:[t.jsxs("div",{ref:k,className:"relative flex-shrink-0 min-w-0 max-w-sm",children:[t.jsx("label",{htmlFor:"website-category-filter",className:"block text-xs font-medium text-slate-400 mb-1",children:"Categories (filter by)"}),t.jsx("input",{id:"website-category-filter",type:"text",value:j,onChange:e=>U(e.target.value),onFocus:()=>B(!0),placeholder:"Search and select categories…",className:"input-field w-full",autoComplete:"off"}),A&&t.jsx("div",{className:"absolute left-0 top-full z-10 mt-1 w-full max-h-48 overflow-auto scrollbar-thin rounded-md border border-slate-700 bg-slate-900 shadow-lg",role:"listbox","aria-label":"Category options",children:K.length>0?K.map(e=>t.jsx("button",{type:"button",role:"option",onClick:()=>{$(a=>a.includes(e.id)?a:[...a,e.id]),U("")},className:"block w-full min-h-[44px] flex items-center px-3 py-2 text-left text-sm text-slate-200 hover:bg-slate-800",children:e.name},e.id)):t.jsx("p",{className:"px-3 py-2 text-xs text-slate-500",children:N.length===0?"No categories yet.":"No matches or all selected."})}),t.jsx("div",{className:"mt-2 flex flex-wrap gap-1",children:o.map(e=>{const a=N.find(r=>r.id===e);return t.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-slate-800 px-2 py-0.5 text-xs text-slate-200",children:[(a==null?void 0:a.name)??e,t.jsx("button",{type:"button",onClick:()=>$(r=>r.filter(s=>s!==e)),className:"hover:text-red-400","aria-label":"Remove category filter",children:"×"})]},e)})}),o.length>0&&t.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[t.jsx("span",{className:"text-xs text-slate-500",children:"Match:"}),t.jsxs("div",{className:"inline-flex rounded-md border border-slate-700 bg-slate-950 p-0.5",children:[t.jsx("button",{type:"button",onClick:()=>D("and"),className:`rounded px-2 py-0.5 text-xs font-medium ${d==="and"?"bg-brand-orange text-slate-950":"text-slate-400 hover:text-slate-200"}`,children:"AND"}),t.jsx("button",{type:"button",onClick:()=>D("or"),className:`rounded px-2 py-0.5 text-xs font-medium ${d==="or"?"bg-brand-orange text-slate-950":"text-slate-400 hover:text-slate-200"}`,children:"OR"})]})]})]}),t.jsxs("div",{className:"flex flex-wrap gap-3 items-center text-xs text-slate-400",children:[t.jsx("span",{className:"font-medium text-slate-200",children:"Sort:"}),t.jsxs("select",{value:u,onChange:e=>{O(e.target.value),g(1)},className:"rounded-md border border-slate-700 bg-slate-950 px-2 py-1 text-xs text-slate-50 focus:border-brand-orange focus:outline-none focus:ring-1 focus:ring-brand-orange",children:[t.jsx("option",{value:"avgDesc",children:"Avg stars (high first)"}),t.jsx("option",{value:"avgAsc",children:"Avg stars (low first)"}),t.jsx("option",{value:"alphaAsc",children:"Title A–Z"}),t.jsx("option",{value:"alphaDesc",children:"Title Z–A"})]}),t.jsx("span",{className:"text-slate-500",children:m?p.length===0?"No sites found.":`${p.length} sites`:""})]})]})]}),T&&t.jsx("div",{className:"rounded-md border border-red-500/60 bg-red-500/10 px-3 py-2 text-xs text-red-200",children:T}),m?F?t.jsx("div",{className:"text-sm text-slate-400",children:"Loading sites…"}):t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"rounded-md border border-slate-800 bg-slate-950/60 px-3 py-2 text-sm text-slate-400",children:p.length===0?"No results":`${p.length} results`}),t.jsx("ul",{className:"space-y-2 mt-2",children:W.map(e=>{const a=e.title||e.url||e.PK||"Untitled",r=e.logoUrl;return t.jsxs("li",{className:"flex gap-3 rounded-xl border border-slate-800 bg-slate-950/60 p-3",children:[t.jsx("div",{className:"h-12 w-12 flex-shrink-0 overflow-hidden rounded-lg border border-slate-700 bg-slate-900",children:r?t.jsx("img",{src:r,alt:"",className:"h-full w-full object-cover",onError:s=>{s.currentTarget.style.visibility="hidden"}}):null}),t.jsxs("div",{className:"min-w-0 flex-1 space-y-1",children:[t.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[t.jsx("h2",{className:"truncate text-sm font-semibold text-slate-50",children:t.jsx(H,{to:`/websites/${encodeURIComponent(e.PK)}`,className:"hover:text-brand-orange",children:a})}),typeof e.averageRating=="number"&&t.jsxs("span",{className:"inline-flex items-center rounded-full bg-slate-900 px-2 py-0.5 text-[11px] text-amber-300",children:[e.averageRating.toFixed(1),"★"]})]}),e.url&&t.jsx("a",{href:e.url,target:"_blank",rel:"noopener noreferrer",className:"block truncate text-xs text-slate-400 hover:text-slate-200",children:e.url}),e.description&&t.jsxs("p",{className:"text-xs text-slate-300 line-clamp-3",children:[e.description,e.descriptionAiGenerated&&t.jsx("span",{className:"ml-1 text-[11px] uppercase tracking-wide text-slate-500",children:"AI summary"})]}),e.categories&&e.categories.length>0&&t.jsx("div",{className:"flex flex-wrap gap-1 pt-1",children:e.categories.map(s=>t.jsx("span",{className:"rounded-full bg-slate-900 px-2 py-0.5 text-[11px] text-slate-300",children:s.name},s.id))}),_&&t.jsx("div",{className:"pt-1",children:t.jsxs("label",{className:"inline-flex items-center gap-1 text-[11px] text-slate-400",children:[t.jsx("span",{children:"Rate:"}),t.jsxs("select",{className:"rounded border border-slate-700 bg-slate-950 px-1 py-0.5 text-[11px] text-slate-50",onChange:s=>{const l=Number(s.target.value);l>=1&&l<=5&&Z(e.PK,l)},defaultValue:"",children:[t.jsx("option",{value:"",children:"--"}),t.jsx("option",{value:"1",children:"1"}),t.jsx("option",{value:"2",children:"2"}),t.jsx("option",{value:"3",children:"3"}),t.jsx("option",{value:"4",children:"4"}),t.jsx("option",{value:"5",children:"5"})]})]})})]})]},e.PK)})})]}):t.jsx("div",{className:"flex items-center justify-center min-h-[280px]",children:t.jsx("p",{className:"text-2xl sm:text-3xl font-light text-slate-500/80 tracking-wide animate-pulse",children:"Enter search term or select categories"})}),m&&w>1&&t.jsxs("div",{className:"mt-2 flex flex-wrap items-center justify-center gap-2 text-xs",children:[t.jsx("button",{type:"button",disabled:h<=1,onClick:()=>g(e=>Math.max(1,e-1)),className:"min-h-[44px] flex items-center rounded-md border border-slate-700 bg-slate-950 px-4 py-2 text-slate-200 disabled:opacity-40",children:"Prev"}),t.jsxs("span",{className:"text-slate-500",children:["Page ",h," of ",w]}),t.jsx("button",{type:"button",disabled:h>=w,onClick:()=>g(e=>Math.min(w,e+1)),className:"min-h-[44px] flex items-center rounded-md border border-slate-700 bg-slate-950 px-4 py-2 text-slate-200 disabled:opacity-40",children:"Next"})]})]})};export{V as default};
