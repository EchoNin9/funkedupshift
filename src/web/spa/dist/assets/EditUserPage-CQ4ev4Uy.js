import{d as de,a as me,u as ue,r as o,h as xe,j as e,L as O,c as f}from"./index-CqR0r56c.js";import{F as pe}from"./ArrowLeftIcon-NR7umhpe.js";const H={admin:"SuperAdmin",manager:"Manager",user:"User"},_=[{value:-8,label:"UTC-8"},{value:-5,label:"UTC-5"},{value:0,label:"UTC+0/GMT"}];function z(){if(typeof window>"u")return null;const n=window.API_BASE_URL;return n?n.replace(/\/$/,""):null}function he(n,x,a){if(!n&&!a)return"—";if(!n)return a?`from ${a}`:"—";try{const y=new Date(n);if(isNaN(y.getTime()))return n+(a?` from ${a}`:"");const E=y.getTime()+(x||0)*36e5,u=new Date(E),b=p=>p<10?"0"+p:""+p,j=u.getUTCFullYear(),T=b(u.getUTCMonth()+1),N=b(u.getUTCDate()),l=b(u.getUTCHours()),R=b(u.getUTCMinutes()),w=_.find(p=>p.value===x),k=w?w.label:x<0?"UTC"+x:"UTC+"+x;let h=`${j}-${T}-${N} ${l}:${R} ${k}`;return a&&(h+=` from ${a}`),h}catch{return n+(a?` from ${a}`:"")}}const ge=n=>n==="admin"?"bg-amber-500/20 text-amber-200":n==="manager"?"bg-blue-500/20 text-blue-200":n==="user"?"bg-slate-600/30 text-slate-300":"bg-emerald-500/20 text-emerald-200",Ne=()=>{var Q;const n=de(),[x]=me(),a=x.get("username")??"",y=x.get("email")??"",E=x.get("status")??"",{user:u}=ue(),[b,j]=o.useState(!0),[T,N]=o.useState(null),[l,R]=o.useState(null),[w,k]=o.useState([]),[h,p]=o.useState([]),[C,G]=o.useState([]),[A,B]=o.useState(""),[ee,$]=o.useState(!1),[I,M]=o.useState(!1),[q,P]=o.useState(null),[J,Y]=o.useState(!1),[K,W]=o.useState(-8),D=xe(u??null,"manager"),U=((Q=u==null?void 0:u.groups)==null?void 0:Q.includes("admin"))??!1,te=U?["admin","manager","user"]:["user"],se=async()=>{var g;if(!a)return;const t=z();if(!t){N("API URL not set."),j(!1);return}if(!((g=window.auth)!=null&&g.getAccessToken)){N("Sign in required."),j(!1);return}j(!0),N(null);try{const[i,d]=await Promise.all([f(`${t}/admin/users/${encodeURIComponent(a)}/groups`),f(`${t}/admin/groups`)]);if(!i.ok){const v=await i.json().catch(()=>({}));throw new Error(v.error||"Failed to load user")}const c=await i.json(),F=((await d.json()).groups??[]).map(v=>v.name??(v.PK??"").replace("GROUP#","")).filter(Boolean);R({email:c.username??a,status:E,lastLoginAt:c.lastLoginAt??"",lastLoginIp:c.lastLoginIp??"",cognitoGroups:c.cognitoGroups??[],customGroups:c.customGroups??[]}),p([...c.cognitoGroups??[]]),G([...c.customGroups??[]]),k(F)}catch(i){N((i==null?void 0:i.message)??"Failed to load user")}finally{j(!1)}};o.useEffect(()=>{const t=parseInt(sessionStorage.getItem("funkedupshift_lastlogin_tz")??"-8",10);!isNaN(t)&&_.some(s=>s.value===t)&&W(t)},[]),o.useEffect(()=>{D&&a&&se()},[D,a]);const ae=t=>{t&&!h.includes(t)&&p(s=>[...s,t])},re=t=>{p(s=>s.filter(g=>g!==t))},le=t=>{t&&!C.includes(t)&&(G(s=>[...s,t]),B(""),$(!1))},ne=t=>{G(s=>s.filter(g=>g!==t))},Z=w.filter(t=>C.includes(t)?!1:A.trim()?t.toLowerCase().includes(A.toLowerCase().trim()):!0),oe=async t=>{var V;if(t.preventDefault(),!a)return;const s=z();if(!s||!((V=window.auth)!=null&&V.getAccessToken))return;const i=(l==null?void 0:l.cognitoGroups)??[],d=(l==null?void 0:l.customGroups)??[];let c=h.filter(r=>!i.includes(r)),L=i.filter(r=>!h.includes(r));U||(c=c.filter(r=>r==="user"),L=L.filter(r=>r==="user"));const F=C.filter(r=>!d.includes(r)),v=d.filter(r=>!C.includes(r));M(!0),P(null);try{const r=encodeURIComponent,S=[];c.forEach(m=>S.push(f(`${s}/admin/users/${r(a)}/groups`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({groupName:m})}))),L.forEach(m=>S.push(f(`${s}/admin/users/${r(a)}/groups/${r(m)}`,{method:"DELETE"}))),F.forEach(m=>S.push(f(`${s}/admin/users/${r(a)}/groups`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({groupName:m})}))),v.forEach(m=>S.push(f(`${s}/admin/users/${r(a)}/groups/${r(m)}`,{method:"DELETE"})));const X=(await Promise.all(S)).find(m=>!m.ok);if(X){const m=await X.json().catch(()=>({}));throw new Error(m.error||"Failed to save")}window.alert("Changes saved"),n("/admin/membership")}catch(r){P((r==null?void 0:r.message)??"Failed to save")}finally{M(!1)}},ie=t=>{const s=parseInt(t.target.value,10);W(s),sessionStorage.setItem("funkedupshift_lastlogin_tz",String(s))},ce=async()=>{var i;const t=y||(l==null?void 0:l.email)||a;if(!window.confirm(`Delete user "${t}"? This cannot be undone.`))return;const s=z();if(!(!s||!((i=window.auth)!=null&&i.getAccessToken))){Y(!0);try{const d=await f(`${s}/admin/users/${encodeURIComponent(a)}`,{method:"DELETE"});if(!d.ok){const c=await d.json().catch(()=>({}));throw new Error(c.error||"Failed to delete user")}n("/admin/membership")}catch(d){P((d==null?void 0:d.message)??"Failed to delete user")}finally{Y(!1)}}};return D?a?b?e.jsxs("div",{className:"space-y-4",children:[e.jsx("h1",{className:"text-2xl font-semibold tracking-tight text-slate-50",children:"Edit User"}),e.jsx("p",{className:"text-sm text-slate-500",children:"Loading…"})]}):T||!l?e.jsxs("div",{className:"space-y-4",children:[e.jsx("h1",{className:"text-2xl font-semibold tracking-tight text-slate-50",children:"Edit User"}),e.jsx("div",{className:"rounded-md border border-red-500/60 bg-red-500/10 px-3 py-2 text-sm text-red-200",children:T??"Failed to load user"})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs(O,{to:"/admin/membership",className:"inline-flex items-center gap-1 text-sm text-slate-400 hover:text-slate-200",children:[e.jsx(pe,{className:"h-4 w-4"}),"Back to users"]}),e.jsxs("header",{className:"space-y-2",children:[e.jsx("h1",{className:"text-2xl font-semibold tracking-tight text-slate-50",children:"Edit User"}),e.jsx("p",{className:"text-sm text-slate-400",children:"Adjust system roles and custom groups."}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("label",{htmlFor:"tz-select",className:"text-slate-500",children:"Last login timezone:"}),e.jsx("select",{id:"tz-select",value:K,onChange:ie,className:"rounded border border-slate-700 bg-slate-950 px-2 py-1 text-slate-200 text-sm",children:_.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))})]})]}),e.jsxs("form",{onSubmit:oe,className:"space-y-6 max-w-2xl",children:[e.jsxs("div",{className:"rounded-lg border border-slate-800 bg-slate-950/60 p-4",children:[e.jsx("h2",{className:"text-sm font-medium text-slate-300 mb-3",children:"User info"}),e.jsx("table",{className:"text-sm",children:e.jsxs("tbody",{children:[e.jsxs("tr",{children:[e.jsx("td",{className:"py-1 pr-4 font-medium text-slate-400 w-28",children:"Email"}),e.jsx("td",{className:"py-1 text-slate-200",children:y||l.email})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"py-1 pr-4 font-medium text-slate-400",children:"Status"}),e.jsx("td",{className:"py-1 text-slate-200",children:E||l.status||"—"})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"py-1 pr-4 font-medium text-slate-400",children:"Last login"}),e.jsx("td",{className:"py-1 text-slate-200",children:he(l.lastLoginAt,K,l.lastLoginIp)})]})]})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-200",children:"System roles"}),e.jsxs("select",{className:"rounded border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-200 w-full max-w-xs",onChange:t=>{const s=t.target.value;s&&ae(s),t.target.value=""},children:[e.jsx("option",{value:"",children:"Select role to add…"}),te.filter(t=>!h.includes(t)).map(t=>e.jsx("option",{value:t,children:H[t]??t},t))]}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:h.map(t=>{const s=U||t==="user";return e.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-1 rounded text-sm ${ge(t)}`,children:[H[t]??t,s&&e.jsx("button",{type:"button",onClick:()=>re(t),className:"ml-0.5 hover:text-red-300","aria-label":"Remove",children:"×"})]},t)})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-200",children:"Custom groups"}),w.length===0?e.jsxs("p",{className:"text-sm text-slate-500",children:["No custom groups. ",e.jsx(O,{to:"/admin/membership?tab=groups",className:"text-brand-orange hover:underline",children:"Create groups"}),"."]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative max-w-xs",children:[e.jsx("input",{type:"text",value:A,onChange:t=>{B(t.target.value),$(!0)},onFocus:()=>$(!0),placeholder:"Search or select groups…",className:"w-full rounded border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-200 placeholder:text-slate-500"}),ee&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-10",onClick:()=>$(!1),"aria-hidden":"true"}),e.jsx("div",{className:"absolute top-full left-0 right-0 mt-1 max-h-48 overflow-y-auto rounded border border-slate-700 bg-slate-900 shadow-lg z-20",children:Z.length===0?e.jsx("div",{className:"px-3 py-2 text-sm text-slate-500",children:"No matches"}):Z.map(t=>e.jsx("button",{type:"button",className:"w-full px-3 py-2 text-left text-sm text-slate-200 hover:bg-slate-800",onClick:()=>le(t),children:t},t))})]})]}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:C.map(t=>e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 rounded text-sm bg-emerald-500/20 text-emerald-200",children:[t,e.jsx("button",{type:"button",onClick:()=>ne(t),className:"ml-0.5 hover:text-red-300","aria-label":"Remove",children:"×"})]},t))})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-3 items-center",children:[e.jsx("button",{type:"submit",disabled:I,className:"rounded-md bg-brand-orange px-4 py-2 text-sm font-semibold text-slate-950 hover:bg-orange-500 disabled:opacity-50",children:I?"Saving…":"Save"}),e.jsx(O,{to:"/admin/membership",className:"rounded-md border border-slate-700 px-4 py-2 text-sm font-medium text-slate-300 hover:bg-slate-800",children:"Cancel"}),U&&e.jsx("button",{type:"button",onClick:ce,disabled:J||I,className:"rounded-md border border-red-500/60 bg-red-500/10 px-4 py-2 text-sm font-medium text-red-200 hover:bg-red-500/20 disabled:opacity-50",children:J?"Deleting…":"Delete user"})]}),q&&e.jsx("p",{className:"text-sm text-red-400",children:q})]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("h1",{className:"text-2xl font-semibold tracking-tight text-slate-50",children:"Edit User"}),e.jsx("p",{className:"text-sm text-slate-400",children:"Missing username in URL."})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("h1",{className:"text-2xl font-semibold tracking-tight text-slate-50",children:"Edit User"}),e.jsx("p",{className:"text-sm text-slate-400",children:"Manager or SuperAdmin access is required."})]})};export{Ne as default};
