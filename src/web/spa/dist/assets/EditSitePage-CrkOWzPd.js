import{b as ve,d as Se,u as ke,r as a,h as Ce,c as x,j as e,L as q}from"./index-CgafoLrZ.js";import{F as M}from"./ArrowLeftIcon-BQxqvtWq.js";function k(){if(typeof window>"u")return null;const h=window.API_BASE_URL;return h?h.replace(/\/$/,""):null}const de=100,Le=5*1024*1024,Ie=()=>{const{id:h}=ve(),_=Se(),{user:ue}=ke(),[me,N]=a.useState(!0),[g,J]=a.useState(""),[C,K]=a.useState(""),[W,L]=a.useState(""),[R,v]=a.useState(!1),[y,U]=a.useState([]),[z,A]=a.useState(""),[H,X]=a.useState(""),[Y,xe]=a.useState(null),[I,Z]=a.useState(!1),[w,T]=a.useState(null),[E,D]=a.useState(""),[m,O]=a.useState(null),[P,j]=a.useState(null),[Q,ge]=a.useState([]),[p,B]=a.useState([]),[$,V]=a.useState(""),[pe,ee]=a.useState(!1),[G,te]=a.useState(!1),[se,ae]=a.useState(!1),[re,ne]=a.useState(!1),[oe,le]=a.useState(null),[S,l]=a.useState(null),F=Ce(ue??null,"manager"),c=h?decodeURIComponent(h):"";a.useEffect(()=>{var o;if(!F||!c){N(!1);return}const t=k();if(!t){l("API URL not set."),N(!1);return}if(!((o=window.auth)!=null&&o.getAccessToken)){l("Sign in required."),N(!1);return}let n=!1;return(async()=>{try{const s=await x(`${t}/sites?id=${encodeURIComponent(c)}`);if(s.status===404||!s.ok){n||l("Site not found.");return}const i=(await s.json()).site;if(n||!i)return;J(i.url??""),K(i.title??""),L(i.description??""),v(!!i.descriptionAiGenerated),U(Array.isArray(i.tags)?i.tags:[]),A(""),X(i.scrapedContent??""),xe(i.logoUrl||null),B(Array.isArray(i.categoryIds)?i.categoryIds:[]);const d=await x(`${t}/categories`);if(d.ok&&!n){const b=await d.json();ge((b.categories??[]).map(u=>({id:u.PK||u.id||"",name:u.name||u.PK||""})))}}catch(s){n||l((s==null?void 0:s.message)??"Failed to load.")}finally{n||N(!1)}})(),()=>{n=!0}},[F,c]);const fe=t=>{var o;const r=(o=t.target.files)==null?void 0:o[0];if(T(r??null),D(""),j(null),Z(!1),m&&(URL.revokeObjectURL(m),O(null)),!r)return;if(r.size>Le){j("Logo must be 5 MB or smaller.");return}const n=new Image;n.onload=()=>{if(n.naturalWidth<de||n.naturalHeight<de){j("Logo must be at least 100×100 pixels.");return}j(null),O(URL.createObjectURL(r))},n.onerror=()=>j("Please choose a valid image file."),n.src=URL.createObjectURL(r)},be=t=>{p.includes(t)||B([...p,t]),V(""),ee(!1)},he=t=>{B(p.filter(r=>r!==t))},ie=()=>{const t=z.trim();t&&!y.includes(t)&&U([...y,t]),A("")},ye=t=>U(y.filter(r=>r!==t)),ce=Q.filter(t=>!p.includes(t.id)&&(!$.trim()||(t.name||"").toLowerCase().includes($.toLowerCase()))),we=async()=>{var o;const t=g.trim();if(!t){l("Enter URL first.");return}const r=k();if(!r){l("API URL not set.");return}if(!((o=window.auth)!=null&&o.getAccessToken)){l("Sign in required.");return}ne(!0),l(null);try{const s=await x(`${r}/sites/generate-description`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:t})});if(!s.ok)throw new Error(await s.text());const f=await s.json();L(f.description??""),v(!0)}catch(s){l((s==null?void 0:s.message)??"Failed to generate description.")}finally{ne(!1)}},je=async t=>{var o;if(t.preventDefault(),!c)return;const r=k();if(!r){l("API URL not set.");return}if(!((o=window.auth)!=null&&o.getAccessToken)){l("Sign in required.");return}if(!(w&&P)){te(!0),l(null),le(null);try{let s=null;if(w){const d=await x(`${r}/sites/logo-upload`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({siteId:c,contentType:w.type||"image/png"})});if(!d.ok)throw new Error("Logo upload request failed");const{uploadUrl:b,key:u}=await d.json();if(!(await fetch(b,{method:"PUT",headers:{"Content-Type":w.type||"image/png"},body:w})).ok)throw new Error("Logo upload failed");s=u}else if(E.trim()){const d=await x(`${r}/sites/logo-from-url`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({siteId:c,imageUrl:E.trim()})});if(!d.ok){const u=await d.json().catch(()=>({}));throw new Error(u.error||await d.text())}const b=await d.json();b.key&&(s=b.key)}const f={id:c,url:g.trim(),title:C.trim()||g.trim(),description:W.trim(),descriptionAiGenerated:R,categoryIds:p,tags:y,scrapedContent:H.trim()||void 0};I?f.deleteLogo=!0:s&&(f.logoKey=s);const i=await x(`${r}/sites`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(f)});if(!i.ok)throw new Error(await i.text());le("Site updated."),m&&URL.revokeObjectURL(m),T(null),O(null),D(""),setTimeout(()=>_(`/websites/${encodeURIComponent(c)}`),1200)}catch(s){l((s==null?void 0:s.message)??"Failed to update site.")}finally{te(!1)}}},Ne=async()=>{var n;if(!c||!window.confirm("Delete this site? This cannot be undone."))return;const t=k();if(!(!t||!((n=window.auth)!=null&&n.getAccessToken))){ae(!0),l(null);try{const o=await x(`${t}/sites`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:c})});if(!o.ok)throw new Error(await o.text());_("/websites")}catch(o){l((o==null?void 0:o.message)??"Failed to delete site.")}finally{ae(!1)}}};return F?me?e.jsxs("div",{className:"space-y-4",children:[e.jsxs(q,{to:"/websites",className:"inline-flex items-center gap-1 text-sm text-slate-400 hover:text-slate-200",children:[e.jsx(M,{className:"h-4 w-4"}),"Back to Websites"]}),e.jsx("p",{className:"text-sm text-slate-400",children:"Loading…"})]}):S&&!g&&!C?e.jsxs("div",{className:"space-y-4",children:[e.jsxs(q,{to:"/websites",className:"inline-flex items-center gap-1 text-sm text-slate-400 hover:text-slate-200",children:[e.jsx(M,{className:"h-4 w-4"}),"Back to Websites"]}),e.jsx("div",{className:"rounded-md border border-red-500/60 bg-red-500/10 px-3 py-2 text-sm text-red-200",children:S})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs(q,{to:`/websites/${encodeURIComponent(c)}`,className:"inline-flex items-center gap-1 text-sm text-slate-400 hover:text-slate-200",children:[e.jsx(M,{className:"h-4 w-4"}),"Back to site"]}),e.jsxs("header",{className:"space-y-2",children:[e.jsx("h1",{className:"text-2xl font-semibold tracking-tight text-slate-50",children:"Edit Site"}),e.jsx("p",{className:"text-sm text-slate-400",children:"Update URL, title, description, logo, categories, and scraped content."})]}),e.jsxs("form",{className:"space-y-4 max-w-xl",onSubmit:je,children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"URL *"}),e.jsx("input",{type:"url",value:g,onChange:t=>J(t.target.value),required:!0,className:"w-full rounded-md border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 focus:border-brand-orange focus:outline-none focus:ring-1 focus:ring-brand-orange"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"Title"}),e.jsx("input",{type:"text",value:C,onChange:t=>K(t.target.value),className:"w-full rounded-md border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 focus:border-brand-orange focus:outline-none focus:ring-1 focus:ring-brand-orange"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"Description"}),e.jsx("textarea",{value:W,onChange:t=>{L(t.target.value),v(!1)},placeholder:"Short description",rows:4,className:"w-full rounded-md border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500 focus:border-brand-orange focus:outline-none focus:ring-1 focus:ring-brand-orange"}),e.jsx("button",{type:"button",onClick:we,disabled:re||!g.trim(),className:"mt-2 rounded-md border border-slate-700 bg-slate-800 px-3 py-1.5 text-xs font-medium text-slate-200 hover:bg-slate-700 disabled:opacity-50",children:re?"Generating…":"Generate AI description"}),R&&e.jsx("span",{className:"ml-2 text-xs uppercase tracking-wide text-slate-500",children:"AI summary"}),e.jsxs("label",{className:"mt-2 block inline-flex items-center gap-2 text-xs text-slate-500",children:[e.jsx("input",{type:"checkbox",checked:R,onChange:t=>v(t.target.checked)}),"AI-generated summary"]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"Logo"}),Y&&!I&&!m&&e.jsxs("div",{className:"mb-2 flex items-center gap-2",children:[e.jsx("img",{src:Y,alt:"Current logo",className:"h-12 w-12 rounded-lg border border-slate-700 object-cover"}),e.jsxs("label",{className:"text-xs text-slate-400",children:[e.jsx("input",{type:"checkbox",checked:I,onChange:t=>Z(t.target.checked)}),e.jsx("span",{className:"ml-1",children:"Remove logo"})]})]}),e.jsx("input",{type:"file",accept:"image/png,image/jpeg,image/gif,image/webp",onChange:fe,className:"block w-full text-xs text-slate-300 file:mr-3 file:rounded-md file:border-0 file:bg-slate-800 file:px-3 file:py-1.5 file:text-slate-100"}),e.jsx("p",{className:"mt-2 text-xs text-slate-500",children:"Or paste image URL (image will be copied to S3 on save):"}),e.jsx("input",{type:"url",value:E,onChange:t=>{D(t.target.value),t.target.value.trim()&&T(null)},placeholder:"https://example.com/logo.png",className:"mt-1 w-full rounded-md border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500 focus:border-brand-orange focus:outline-none focus:ring-1 focus:ring-brand-orange"}),m&&e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:m,alt:"New logo",className:"h-16 w-16 rounded-lg border border-slate-700 object-cover"})}),P&&e.jsx("p",{className:"mt-1 text-xs text-red-400",children:P})]}),e.jsxs("div",{className:"relative",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"Categories"}),e.jsx("input",{type:"text",value:$,onChange:t=>V(t.target.value),onFocus:()=>ee(!0),placeholder:"Search and select…",className:"w-full rounded-md border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 focus:border-brand-orange focus:outline-none focus:ring-1 focus:ring-brand-orange"}),pe&&e.jsx("div",{className:"absolute left-0 right-0 top-full z-10 mt-1 max-h-48 overflow-auto scrollbar-thin rounded-md border border-slate-700 bg-slate-900 shadow-lg",children:ce.length?ce.map(t=>e.jsx("button",{type:"button",onClick:()=>be(t.id),className:"block w-full px-3 py-2 text-left text-sm text-slate-200 hover:bg-slate-800",children:t.name},t.id)):e.jsx("p",{className:"px-3 py-2 text-xs text-slate-500",children:"No matches"})}),e.jsx("div",{className:"mt-2 flex flex-wrap gap-1",children:p.map(t=>{const r=Q.find(n=>n.id===t);return e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-slate-800 px-2 py-0.5 text-xs text-slate-200",children:[(r==null?void 0:r.name)??t,e.jsx("button",{type:"button",onClick:()=>he(t),className:"hover:text-red-400","aria-label":"Remove",children:"×"})]},t)})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"Tags"}),e.jsx("div",{className:"flex flex-wrap gap-1 mb-2",children:y.map(t=>e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-slate-800 px-2 py-0.5 text-xs text-slate-200",children:[t,e.jsx("button",{type:"button",onClick:()=>ye(t),className:"hover:text-red-400","aria-label":"Remove",children:"×"})]},t))}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:z,onChange:t=>A(t.target.value),onKeyDown:t=>t.key==="Enter"&&(t.preventDefault(),ie()),placeholder:"Add tag",className:"flex-1 rounded-md border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 focus:border-brand-orange focus:outline-none focus:ring-1 focus:ring-brand-orange"}),e.jsx("button",{type:"button",onClick:ie,className:"rounded-md border border-slate-700 bg-slate-800 px-3 py-2 text-sm text-slate-200 hover:bg-slate-700",children:"Add"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"Scraped content (optional)"}),e.jsx("textarea",{value:H,onChange:t=>X(t.target.value),rows:6,placeholder:"Paste or edit scraped content (e.g. README, about page)",className:"w-full rounded-md border border-slate-700 bg-slate-950 px-3 py-2 text-sm font-mono text-slate-50 focus:border-brand-orange focus:outline-none focus:ring-1 focus:ring-brand-orange"})]}),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsx("button",{type:"submit",disabled:G,className:"inline-flex items-center justify-center rounded-md bg-brand-orange px-4 py-2 text-sm font-semibold text-slate-950 hover:bg-orange-500 disabled:opacity-50",children:G?"Saving…":"Save changes"}),e.jsx("button",{type:"button",onClick:Ne,disabled:se||G,className:"rounded-md border border-red-500/60 px-4 py-2 text-sm font-medium text-red-400 hover:bg-red-500/20 disabled:opacity-50",children:se?"Deleting…":"Delete entry"})]}),oe&&e.jsx("div",{className:"rounded-md border border-emerald-500/60 bg-emerald-500/10 px-3 py-2 text-sm text-emerald-200",children:oe}),S&&e.jsx("div",{className:"rounded-md border border-red-500/60 bg-red-500/10 px-3 py-2 text-sm text-red-200",children:S})]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("h1",{className:"text-2xl font-semibold tracking-tight text-slate-50",children:"Edit Site"}),e.jsx("p",{className:"text-sm text-slate-400",children:"Manager or SuperAdmin access is required."})]})};export{Ie as default};
