import{b as _,d as D,u as O,r as n,s as J,t as q,j as e,L as u,c as g}from"./index-CgafoLrZ.js";import{A as W}from"./AddTagInput-fAy3XhgR.js";import{S as z}from"./ShareMemeBox-CKu0HVlC.js";import{F as h}from"./ArrowLeftIcon-BQxqvtWq.js";import"./LinkIcon-DmpC1Ftm.js";function y(){if(typeof window>"u")return null;const i=window.API_BASE_URL;return i?i.replace(/\/$/,""):null}const Y=()=>{const{id:i}=_(),U=D(),{user:m}=O(),[s,N]=n.useState(null),[f,w]=n.useState([]),[p,S]=n.useState(!1),[R,j]=n.useState(!0),[I,P]=n.useState(!1),[d,o]=n.useState(null),[C,M]=n.useState([]),x=i?decodeURIComponent(i):"",A=!!(m&&(J(m)||q(m)));n.useEffect(()=>{const a=y();if(!a||!x){o(x?"API URL not set.":"Missing meme id."),j(!1);return}let t=!1;async function l(){var c,T;j(!0),o(null);try{const[r,$]=await Promise.all([g(`${a}/memes?id=${encodeURIComponent(x)}`),g(`${a}/memes/tags`)]);if(r.status===404||!r.ok){t||N(null);return}const v=await r.json(),L=await $.json();if(t)return;N(v.meme??null),w(((c=v.meme)==null?void 0:c.tags)??[]),S(((T=v.meme)==null?void 0:T.isPrivate)??!1),M((L.tags??[]).sort((F,K)=>F.localeCompare(K)))}catch(r){t||o((r==null?void 0:r.message)??"Failed to load meme.")}finally{t||j(!1)}}return l(),()=>{t=!0}},[x]);const b=n.useRef(null);n.useEffect(()=>{s&&b.current===null&&(b.current=s.isPrivate??!1)},[s]);const B=async()=>{const a=y();if(!(!a||!s)){P(!0),o(null);try{const t=await g(`${a}/memes`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:s.PK,tags:f,isPrivate:p})});if(!t.ok){const c=await t.json();throw new Error(c.error||"Failed to save")}const l=b.current===(p??!1);try{sessionStorage.setItem("memes_my_cache_invalidate",JSON.stringify({memeId:s.PK,tagOnly:l,tags:f}))}catch{}U(`/memes/${encodeURIComponent(s.PK)}`)}catch(t){o((t==null?void 0:t.message)??"Failed to save")}finally{P(!1)}}};if(!m||!A)return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(u,{to:"/memes",className:"inline-flex items-center gap-1 text-sm text-slate-400 hover:text-slate-200",children:[e.jsx(h,{className:"h-4 w-4"}),"Back to Memes"]}),e.jsx("div",{className:"rounded-md border border-slate-700 bg-slate-900/60 px-4 py-3 text-slate-200",children:"Sign in and join Memes group to edit."})]});if(R)return e.jsxs("div",{className:"space-y-4",children:[e.jsxs(u,{to:"/memes",className:"inline-flex items-center gap-1 text-sm text-slate-400 hover:text-slate-200",children:[e.jsx(h,{className:"h-4 w-4"}),"Back to Memes"]}),e.jsx("div",{className:"text-sm text-slate-400",children:"Loading…"})]});if(d||!s)return e.jsxs("div",{className:"space-y-4",children:[e.jsxs(u,{to:"/memes",className:"inline-flex items-center gap-1 text-sm text-slate-400 hover:text-slate-200",children:[e.jsx(h,{className:"h-4 w-4"}),"Back to Memes"]}),e.jsx("div",{className:"rounded-md border border-slate-700 bg-slate-900/60 px-4 py-3 text-slate-200",children:d||"Meme not found."})]});const k=s.mediaUrl||s.thumbnailUrl,E=s.title||s.PK||"Untitled";return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("header",{className:"flex items-center gap-4",children:[e.jsxs(u,{to:`/memes/${encodeURIComponent(s.PK)}`,className:"inline-flex items-center gap-1 text-sm text-slate-400 hover:text-slate-200",children:[e.jsx(h,{className:"h-4 w-4"}),"Back to Meme"]}),e.jsx("h1",{className:"text-xl font-semibold text-slate-50",children:"Edit meme"})]}),e.jsx("div",{className:"rounded-xl border border-slate-800 bg-slate-950/60 overflow-hidden min-h-[200px] flex items-center justify-center p-4",children:k?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:k,alt:E,className:"w-full max-w-2xl mx-auto block object-contain max-h-[70vh]",onError:a=>{a.currentTarget.style.display="none";const t=a.currentTarget.nextElementSibling;t&&t.classList.remove("hidden")}}),e.jsx("div",{className:"hidden py-12 text-slate-500","aria-hidden":!0,children:"Image failed to load"})]}):e.jsx("div",{className:"py-12 text-slate-500",children:"No image"})}),e.jsx(z,{memeId:s.PK,title:E}),e.jsxs("div",{className:"rounded-xl border border-slate-800 bg-slate-950/60 p-4 space-y-4 max-w-xl",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-slate-400 mb-1",children:"Tags"}),e.jsx(W,{tags:f,onTagsChange:w,allTags:C,fetchTags:async a=>{const t=y();if(!t)return[];const l=await g(`${t}/memes/tags?q=${encodeURIComponent(a)}`);return l.ok?(await l.json()).tags??[]:[]},placeholder:"Type to suggest or create tag, Tab to autocomplete"})]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm text-slate-300",children:[e.jsx("input",{type:"checkbox",checked:p,onChange:a=>S(a.target.checked),className:"rounded border-slate-600"}),"Private (only you can see)"]}),d&&e.jsx("div",{className:"rounded-md border border-red-500/60 bg-red-500/10 px-3 py-2 text-xs text-red-200",children:d}),e.jsx("button",{type:"button",onClick:B,disabled:I,className:"rounded-md bg-brand-orange px-4 py-2 text-sm font-semibold text-slate-950 hover:bg-orange-500 disabled:opacity-50",children:I?"Saving…":"Save"})]})]})};export{Y as default};
