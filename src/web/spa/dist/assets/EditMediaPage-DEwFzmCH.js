import{b as pe,d as xe,u as ge,r as i,h as fe,c as h,j as e,L as $}from"./index-CgafoLrZ.js";import{F as E}from"./ArrowLeftIcon-BQxqvtWq.js";function f(){if(typeof window>"u")return null;const b=window.API_BASE_URL;return b?b.replace(/\/$/,""):null}const we=()=>{const{id:b}=pe(),D=xe(),{user:te}=ge(),[ae,j]=i.useState(!0),[N,B]=i.useState(""),[S,M]=i.useState(""),[A,se]=i.useState(null),[U,v]=i.useState(null),[L,ne]=i.useState("image"),[F,O]=i.useState(!1),[z,J]=i.useState(!1),[q,G]=i.useState(!1),[K,re]=i.useState([]),[g,C]=i.useState([]),[R,W]=i.useState(""),[ie,_]=i.useState(!1),[P,Y]=i.useState(!1),[H,Q]=i.useState(!1),[V,p]=i.useState(null),[T,o]=i.useState(null),I=fe(te??null,"manager"),l=b?decodeURIComponent(b):"";i.useEffect(()=>{var a;if(!I||!l){j(!1);return}const t=f();if(!t){o("API URL not set."),j(!1);return}if(!((a=window.auth)!=null&&a.getAccessToken)){o("Sign in required."),j(!1);return}let s=!1;return(async()=>{try{const n=await h(`${t}/media?id=${encodeURIComponent(l)}`);if(n.status===404||!n.ok){s||o("Media not found.");return}const d=await n.json(),c=Array.isArray(d.media)?d.media[0]:d.media;if(s||!c)return;const m=c;B(m.title??""),M(m.description??""),se(m.mediaUrl||null),v(m.thumbnailUrl||null),ne(m.mediaType||"image"),C(Array.isArray(m.categoryIds)?m.categoryIds:[]);const u=await h(`${t}/media-categories`);if(u.ok&&!s){const x=await u.json();re((x.categories??[]).map(y=>({id:y.PK||y.id||"",name:y.name||y.PK||""})))}}catch(n){s||o((n==null?void 0:n.message)??"Failed to load.")}finally{s||j(!1)}})(),()=>{s=!0}},[I,l]);const oe=t=>{g.includes(t)||C([...g,t]),W(""),_(!1)},le=t=>{C(g.filter(r=>r!==t))},X=K.filter(t=>!g.includes(t.id)&&(!R.trim()||(t.name||"").toLowerCase().includes(R.toLowerCase()))),de=async t=>{var a;if(t.preventDefault(),!l)return;const r=f();if(!r){o("API URL not set.");return}const s=window;if(!((a=s.auth)!=null&&a.getAccessToken)){o("Sign in required.");return}Y(!0),o(null),p(null);try{const n=await new Promise(c=>s.auth.getAccessToken(c)),d=await h(`${r}/media`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({id:l,title:N.trim()||"Untitled",description:S.trim(),categoryIds:g})});if(!d.ok)throw new Error(await d.text());p("Media updated."),setTimeout(()=>D("/media"),1200)}catch(n){o((n==null?void 0:n.message)??"Failed to update media.")}finally{Y(!1)}},ce=async t=>{var n,d;const r=(n=t.target.files)==null?void 0:n[0];if(!r||!l)return;if(!r.type.startsWith("image/")){o("Please choose an image (PNG, JPEG, GIF, WebP).");return}const s=f();if(!s)return;const a=window;if((d=a.auth)!=null&&d.getAccessToken){J(!0),o(null),p(null);try{const c=await new Promise(w=>a.auth.getAccessToken(w)),m=await h(`${s}/media/thumbnail-upload`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`},body:JSON.stringify({mediaId:l,contentType:r.type||"image/png"})});if(!m.ok)throw new Error("Upload request failed");const{uploadUrl:u,key:x}=await m.json();if(!(await fetch(u,{method:"PUT",headers:{"Content-Type":r.type||"image/png"},body:r})).ok)throw new Error("File upload failed");const Z=await h(`${s}/media`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`},body:JSON.stringify({id:l,thumbnailKey:x})});if(!Z.ok)throw new Error(await Z.text());const ee=await h(`${s}/media?id=${encodeURIComponent(l)}`);if(ee.ok){const w=await ee.json(),k=Array.isArray(w.media)?w.media[0]:w.media;k!=null&&k.thumbnailUrl&&v(k.thumbnailUrl)}p("Logo/thumbnail updated.")}catch(c){o((c==null?void 0:c.message)??"Failed to upload thumbnail.")}finally{J(!1),t.target.value=""}}},me=async()=>{var s;if(!l||!window.confirm("Remove the custom logo/thumbnail? You can regenerate from video or upload a new one."))return;const t=f();if(!t)return;const r=window;if((s=r.auth)!=null&&s.getAccessToken){G(!0),o(null),p(null);try{const a=await new Promise(d=>r.auth.getAccessToken(d)),n=await h(`${t}/media`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({id:l,deleteThumbnail:!0})});if(!n.ok)throw new Error(await n.text());v(null),p("Logo/thumbnail removed.")}catch(a){o((a==null?void 0:a.message)??"Failed to remove thumbnail.")}finally{G(!1)}}},ue=async()=>{var s;if(!l)return;const t=f();if(!t)return;const r=window;if((s=r.auth)!=null&&s.getAccessToken){O(!0),o(null),p(null);try{const a=await new Promise(c=>r.auth.getAccessToken(c)),n=await h(`${t}/media/regenerate-thumbnail`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({mediaId:l})});if(!n.ok)throw new Error(await n.text());p("Thumbnail regeneration started. New thumbnail will appear in 30–60 seconds.");const d=async c=>{if(c>6)return;await new Promise(u=>setTimeout(u,1e4));const m=await h(`${t}/media?id=${encodeURIComponent(l)}`);if(m.ok){const u=await m.json(),x=Array.isArray(u.media)?u.media[0]:u.media;if(x!=null&&x.thumbnailUrl){v(x.thumbnailUrl),p("Thumbnail updated.");return}}d(c+1)};d(1)}catch(a){o((a==null?void 0:a.message)??"Failed to regenerate thumbnail.")}finally{O(!1)}}},he=async()=>{var s;if(!l||!window.confirm("Delete this media item? This cannot be undone."))return;const t=f();if(!t)return;const r=window;if((s=r.auth)!=null&&s.getAccessToken){Q(!0),o(null);try{const a=await new Promise(d=>r.auth.getAccessToken(d)),n=await h(`${t}/media?id=${encodeURIComponent(l)}`,{method:"DELETE",headers:{Authorization:`Bearer ${a}`}});if(!n.ok)throw new Error(await n.text());D("/media")}catch(a){o((a==null?void 0:a.message)??"Failed to delete media.")}finally{Q(!1)}}};return I?ae?e.jsxs("div",{className:"space-y-4",children:[e.jsxs($,{to:"/media",className:"inline-flex items-center gap-1 text-sm text-slate-400 hover:text-slate-200",children:[e.jsx(E,{className:"h-4 w-4"}),"Back to Media"]}),e.jsx("p",{className:"text-sm text-slate-400",children:"Loading…"})]}):T&&!N&&!S?e.jsxs("div",{className:"space-y-4",children:[e.jsxs($,{to:"/media",className:"inline-flex items-center gap-1 text-sm text-slate-400 hover:text-slate-200",children:[e.jsx(E,{className:"h-4 w-4"}),"Back to Media"]}),e.jsx("div",{className:"rounded-md border border-red-500/60 bg-red-500/10 px-3 py-2 text-sm text-red-200",children:T})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs($,{to:"/media",className:"inline-flex items-center gap-1 text-sm text-slate-400 hover:text-slate-200",children:[e.jsx(E,{className:"h-4 w-4"}),"Back to Media"]}),e.jsxs("header",{className:"space-y-2",children:[e.jsx("h1",{className:"text-2xl font-semibold tracking-tight text-slate-50",children:"Edit Media"}),e.jsx("p",{className:"text-sm text-slate-400",children:"Update title, description, and categories. The file itself cannot be changed here."})]}),A&&e.jsxs("section",{className:"rounded-xl border border-slate-800 bg-slate-950/60 overflow-hidden max-w-2xl",children:[e.jsx("p",{className:"px-4 py-2 text-xs font-medium text-slate-400 border-b border-slate-800",children:"Current media"}),e.jsx("div",{className:"p-4 flex justify-center items-center bg-slate-900/40 min-h-[160px]",children:L==="video"?e.jsx("video",{src:A,controls:!0,className:"max-w-full max-h-[50vh] rounded-lg border border-slate-700",playsInline:!0}):e.jsx("img",{src:A,alt:N||"Media",className:"max-w-full max-h-[50vh] w-auto h-auto object-contain rounded-lg border border-slate-700"})}),L==="video"&&e.jsxs("div",{className:"px-4 py-3 border-t border-slate-800 space-y-2",children:[e.jsx("p",{className:"text-xs font-medium text-slate-400",children:"Logo / Thumbnail"}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[U&&e.jsx("img",{src:U,alt:"Thumbnail",className:"h-16 w-auto rounded border border-slate-700 object-cover"}),e.jsx("button",{type:"button",onClick:ue,disabled:F,className:"rounded-md border border-slate-600 px-3 py-1.5 text-sm font-medium text-slate-200 hover:bg-slate-800 disabled:opacity-50",children:F?"Regenerating…":"Take screenshot"}),e.jsxs("label",{className:"cursor-pointer rounded-md border border-slate-600 px-3 py-1.5 text-sm font-medium text-slate-200 hover:bg-slate-800",children:[z?"Uploading…":"Add logo",e.jsx("input",{type:"file",accept:"image/png,image/jpeg,image/gif,image/webp",className:"hidden",onChange:ce,disabled:z})]}),U&&e.jsx("button",{type:"button",onClick:me,disabled:q,className:"rounded-md border border-red-500/60 px-3 py-1.5 text-sm font-medium text-red-400 hover:bg-red-500/20 disabled:opacity-50",children:q?"Removing…":"Delete logo"})]})]})]}),e.jsxs("form",{className:"space-y-4 max-w-xl",onSubmit:de,children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"Title"}),e.jsx("input",{type:"text",value:N,onChange:t=>B(t.target.value),className:"w-full rounded-md border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 focus:border-brand-orange focus:outline-none focus:ring-1 focus:ring-brand-orange"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"Description"}),e.jsx("textarea",{value:S,onChange:t=>M(t.target.value),rows:4,className:"w-full rounded-md border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 focus:border-brand-orange focus:outline-none focus:ring-1 focus:ring-brand-orange"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"Media categories"}),e.jsx("input",{type:"text",value:R,onChange:t=>W(t.target.value),onFocus:()=>_(!0),placeholder:"Search and select…",className:"w-full rounded-md border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 focus:border-brand-orange focus:outline-none focus:ring-1 focus:ring-brand-orange"}),ie&&e.jsx("div",{className:"absolute left-0 right-0 top-full z-10 mt-1 max-h-48 overflow-auto scrollbar-thin rounded-md border border-slate-700 bg-slate-900 shadow-lg",children:X.length?X.map(t=>e.jsx("button",{type:"button",onClick:()=>oe(t.id),className:"block w-full px-3 py-2 text-left text-sm text-slate-200 hover:bg-slate-800",children:t.name},t.id)):e.jsx("p",{className:"px-3 py-2 text-xs text-slate-500",children:"No matches"})}),e.jsx("div",{className:"mt-2 flex flex-wrap gap-1",children:g.map(t=>{const r=K.find(s=>s.id===t);return e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-slate-800 px-2 py-0.5 text-xs text-slate-200",children:[(r==null?void 0:r.name)??t,e.jsx("button",{type:"button",onClick:()=>le(t),className:"hover:text-red-400","aria-label":"Remove",children:"×"})]},t)})})]}),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsx("button",{type:"submit",disabled:P,className:"inline-flex items-center justify-center rounded-md bg-brand-orange px-4 py-2 text-sm font-semibold text-slate-950 hover:bg-orange-500 disabled:opacity-50",children:P?"Saving…":"Save changes"}),e.jsx("button",{type:"button",onClick:he,disabled:H||P,className:"rounded-md border border-red-500/60 px-4 py-2 text-sm font-medium text-red-400 hover:bg-red-500/20 disabled:opacity-50",children:H?"Deleting…":"Delete entry"})]}),V&&e.jsx("div",{className:"rounded-md border border-emerald-500/60 bg-emerald-500/10 px-3 py-2 text-sm text-emerald-200",children:V}),T&&e.jsx("div",{className:"rounded-md border border-red-500/60 bg-red-500/10 px-3 py-2 text-sm text-red-200",children:T})]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("h1",{className:"text-2xl font-semibold tracking-tight text-slate-50",children:"Edit Media"}),e.jsx("p",{className:"text-sm text-slate-400",children:"Manager or SuperAdmin access is required."})]})};export{we as default};
