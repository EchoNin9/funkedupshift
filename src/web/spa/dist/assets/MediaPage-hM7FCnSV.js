import{u as H,a as J,r as n,h as W,f as k,j as t,L as E}from"./index-BLy7dBGz.js";import{F as Q}from"./PencilSquareIcon-BWgNnpF7.js";function I(){if(typeof window>"u")return null;const h=window.API_BASE_URL;return h?h.replace(/\/$/,""):null}const L=10,ee=()=>{const{user:h}=H(),[C,S]=J(),[b,M]=n.useState([]),[d,$]=n.useState(()=>C.get("q")??""),[c,T]=n.useState(()=>{const e=C.get("categoryIds");return e?e.split(",").filter(Boolean):[]}),[x,D]=n.useState(()=>C.get("categoryMode")==="or"?"or":"and"),[P,U]=n.useState(!1),[j,B]=n.useState(""),[u,O]=n.useState("avgDesc"),[f,g]=n.useState(1),[_,A]=n.useState(!1),[F,y]=n.useState(null),q=!!h,Z=W(h??null,"manager"),R=n.useRef(null),[v,z]=n.useState([]);n.useEffect(()=>{const e=I();if(!e)return;let a=!1;return k(`${e}/media-categories`).then(r=>r.ok?r.json():Promise.reject(new Error("Failed to load categories"))).then(r=>{if(a)return;const s=(r.categories??[]).map(l=>({id:l.PK||l.id||"",name:l.name||l.PK||""}));s.sort((l,o)=>(l.name||"").localeCompare(o.name||"")),z(s)}).catch(()=>{}),()=>{a=!0}},[]);const N=n.useMemo(()=>{if(x==="or"&&v.length>0)return v;const e=new Map;b.forEach(r=>(r.categories||[]).forEach(s=>{s.id&&!e.has(s.id)&&e.set(s.id,s)}));const a=[...v];return e.forEach(r=>{a.some(s=>s.id===r.id)||a.push(r)}),a.sort((r,s)=>(r.name||"").localeCompare(s.name||"")),a},[v,x,b]),K=n.useMemo(()=>N.filter(e=>!c.includes(e.id)&&(!j.trim()||(e.name||"").toLowerCase().includes(j.toLowerCase()))),[N,c,j]),m=d.trim().length>0||c.length>0;n.useEffect(()=>{if(m){const e=new URLSearchParams;d.trim()&&e.set("q",d.trim()),c.length&&(e.set("categoryIds",c.join(",")),e.set("categoryMode",x)),S(e,{replace:!0})}else S({},{replace:!0})},[m,d,c,x,S]),n.useEffect(()=>{if(!m){M([]),g(1),A(!1),y(null);return}const e=I();if(!e){y("API URL not set. Deploy via CI or set window.API_BASE_URL in config.js.");return}let a=!1;async function r(){A(!0),y(null);try{const s=new URLSearchParams;s.set("limit","100"),d.trim()&&s.set("q",d.trim()),c.length>0&&(s.set("categoryIds",c.join(",")),s.set("categoryMode",x));const l=await k(`${e}/media?${s.toString()}`);if(!l.ok){const i=await l.text();throw new Error(`HTTP ${l.status}: ${i}`)}const o=await l.json();if(a)return;M(o.media??[]),g(1)}catch(s){a||y((s==null?void 0:s.message)??"Failed to load media.")}finally{a||A(!1)}}return r(),()=>{a=!0}},[m,d,c,x]),n.useEffect(()=>{function e(a){R.current&&!R.current.contains(a.target)&&U(!1)}if(P)return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[P]);const p=n.useMemo(()=>{const e=[...b];return e.sort((a,r)=>{const s=(a.title||a.PK||"").toLowerCase(),l=(r.title||r.PK||"").toLowerCase(),o=typeof a.averageRating=="number"?a.averageRating:0,i=typeof r.averageRating=="number"?r.averageRating:0;return u==="avgDesc"?i!==o?i-o:s.localeCompare(l):u==="avgAsc"?o!==i?o-i:s.localeCompare(l):u==="alphaAsc"?s.localeCompare(l):u==="alphaDesc"?l.localeCompare(s):0}),e},[b,u]),w=Math.max(1,Math.ceil(p.length/L)),V=p.slice((f-1)*L,f*L),G=async(e,a)=>{const r=I();if(!r)return;const s=window;if(!s.auth||typeof s.auth.getAccessToken!="function")return;const l=await new Promise(o=>{s.auth.getAccessToken(i=>o(i))});l&&await k(`${r}/media/stars`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},body:JSON.stringify({mediaId:e,rating:a})}).catch(()=>{})};return t.jsxs("div",{className:"space-y-6",children:[t.jsxs("header",{className:"space-y-2",children:[t.jsx("h1",{className:"text-2xl font-semibold tracking-tight text-slate-50",children:"Media"}),t.jsx("p",{className:"text-sm text-slate-400",children:"Images and videos attached to sites and experiments across Funkedupshift."})]}),t.jsxs("section",{className:"rounded-xl border border-slate-800 bg-slate-950/60 p-4 space-y-4","aria-label":"Search and filter",children:[t.jsxs("form",{className:"flex flex-col gap-3 sm:flex-row sm:items-center",onSubmit:e=>{e.preventDefault(),$(d.trim())},children:[t.jsx("input",{type:"text",value:d,onChange:e=>$(e.target.value),placeholder:"Search media by title or descriptionâ€¦",className:"input-field flex-1"}),t.jsx("button",{type:"submit",className:"btn-primary min-h-[44px] !px-4 !py-2 text-sm",children:"Search"})]}),t.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-start gap-4 sm:gap-6",children:[t.jsxs("div",{ref:R,className:"relative flex-shrink-0 min-w-0 max-w-sm",children:[t.jsx("label",{htmlFor:"media-category-filter",className:"block text-xs font-medium text-slate-400 mb-1",children:"Categories (filter by)"}),t.jsx("input",{id:"media-category-filter",type:"text",value:j,onChange:e=>B(e.target.value),onFocus:()=>U(!0),placeholder:"Search and select categoriesâ€¦",className:"input-field w-full",autoComplete:"off"}),P&&t.jsx("div",{className:"absolute left-0 top-full z-10 mt-1 w-full max-h-48 overflow-auto scrollbar-thin rounded-md border border-slate-700 bg-slate-900 shadow-lg",role:"listbox","aria-label":"Category options",children:K.length>0?K.map(e=>t.jsx("button",{type:"button",role:"option",onClick:()=>{T(a=>a.includes(e.id)?a:[...a,e.id]),B("")},className:"block w-full min-h-[44px] flex items-center px-3 py-2 text-left text-sm text-slate-200 hover:bg-slate-800",children:e.name},e.id)):t.jsx("p",{className:"px-3 py-2 text-xs text-slate-500",children:N.length===0?"No categories yet.":"No matches or all selected."})}),t.jsx("div",{className:"mt-2 flex flex-wrap gap-1",children:c.map(e=>{const a=N.find(r=>r.id===e);return t.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-slate-800 px-2 py-0.5 text-xs text-slate-200",children:[(a==null?void 0:a.name)??e,t.jsx("button",{type:"button",onClick:()=>T(r=>r.filter(s=>s!==e)),className:"hover:text-red-400","aria-label":"Remove category filter",children:"Ã—"})]},e)})}),c.length>0&&t.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[t.jsx("span",{className:"text-xs text-slate-500",children:"Match:"}),t.jsxs("div",{className:"inline-flex rounded-md border border-slate-700 bg-slate-950 p-0.5",children:[t.jsx("button",{type:"button",onClick:()=>D("and"),className:`rounded px-2 py-0.5 text-xs font-medium ${x==="and"?"bg-brand-orange text-slate-950":"text-slate-400 hover:text-slate-200"}`,children:"AND"}),t.jsx("button",{type:"button",onClick:()=>D("or"),className:`rounded px-2 py-0.5 text-xs font-medium ${x==="or"?"bg-brand-orange text-slate-950":"text-slate-400 hover:text-slate-200"}`,children:"OR"})]})]})]}),t.jsxs("div",{className:"flex flex-wrap gap-3 items-center text-xs text-slate-400",children:[t.jsx("span",{className:"font-medium text-slate-200",children:"Sort:"}),t.jsxs("select",{value:u,onChange:e=>{O(e.target.value),g(1)},className:"rounded-md border border-slate-700 bg-slate-950 px-2 py-1 text-xs text-slate-50 focus:border-brand-orange focus:outline-none focus:ring-1 focus:ring-brand-orange",children:[t.jsx("option",{value:"avgDesc",children:"Avg stars (high first)"}),t.jsx("option",{value:"avgAsc",children:"Avg stars (low first)"}),t.jsx("option",{value:"alphaAsc",children:"Title Aâ€“Z"}),t.jsx("option",{value:"alphaDesc",children:"Title Zâ€“A"})]}),t.jsx("span",{className:"text-slate-500",children:m?p.length===0?"No media found.":`${p.length} items`:""})]})]})]}),F&&t.jsx("div",{className:"rounded-md border border-red-500/60 bg-red-500/10 px-3 py-2 text-xs text-red-200",children:F}),m?_?t.jsx("div",{className:"text-sm text-slate-400",children:"Loading mediaâ€¦"}):t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"rounded-md border border-slate-800 bg-slate-950/60 px-3 py-2 text-sm text-slate-400",children:p.length===0?"No results":`${p.length} results`}),t.jsx("ul",{className:"space-y-3 mt-2",children:V.map(e=>{const a=e.thumbnailUrl||(e.mediaType==="image"?e.mediaUrl:void 0),r=e.title||e.PK||"Untitled",s=e.mediaType==="video"?"Video":"Image",l=`/media/${encodeURIComponent(e.PK)}`;return t.jsxs("li",{className:"flex gap-3 rounded-xl border border-slate-800 bg-slate-950/60 p-3",children:[t.jsx(E,{to:l,className:"h-16 w-24 flex-shrink-0 overflow-hidden rounded-lg border border-slate-700 bg-slate-900 flex items-center justify-center text-xl hover:border-slate-600",children:a?t.jsx("img",{src:a,alt:"",className:"h-full w-full object-cover",onError:o=>{o.currentTarget.style.visibility="hidden"}}):t.jsx("span",{children:e.mediaType==="video"?"â–¶":"ðŸ“·"})}),t.jsxs("div",{className:"min-w-0 flex-1 space-y-1",children:[t.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[t.jsx("h2",{className:"truncate text-sm font-semibold text-slate-50",children:t.jsx(E,{to:l,className:"hover:text-brand-orange",children:r})}),typeof e.averageRating=="number"&&t.jsxs("span",{className:"inline-flex items-center rounded-full bg-slate-900 px-2 py-0.5 text-[11px] text-amber-300",children:[e.averageRating.toFixed(1),"â˜…"]}),t.jsx("span",{className:"inline-flex items-center rounded-full bg-slate-900 px-2 py-0.5 text-[10px] uppercase tracking-wide text-slate-400",children:s})]}),e.description&&t.jsx("p",{className:"text-xs text-slate-300 line-clamp-3",children:e.description}),e.categories&&e.categories.length>0&&t.jsx("div",{className:"flex flex-wrap gap-1 pt-1",children:e.categories.map(o=>t.jsx("span",{className:"rounded-full bg-slate-900 px-2 py-0.5 text-[11px] text-slate-300",children:o.name},o.id))}),Z&&t.jsx("div",{className:"pt-1",children:t.jsxs(E,{to:`/admin/media/edit/${encodeURIComponent(e.PK)}`,className:"inline-flex items-center gap-1 text-[11px] text-slate-400 hover:text-slate-200",children:[t.jsx(Q,{className:"h-3.5 w-3.5"}),"Edit"]})}),q&&t.jsx("div",{className:"pt-1",children:t.jsxs("label",{className:"inline-flex items-center gap-1 text-[11px] text-slate-400",children:[t.jsx("span",{children:"Rate:"}),t.jsxs("select",{className:"rounded border border-slate-700 bg-slate-950 px-1 py-0.5 text-[11px] text-slate-50",onChange:o=>{const i=Number(o.target.value);i>=1&&i<=5&&G(e.PK,i)},defaultValue:"",children:[t.jsx("option",{value:"",children:"--"}),t.jsx("option",{value:"1",children:"1"}),t.jsx("option",{value:"2",children:"2"}),t.jsx("option",{value:"3",children:"3"}),t.jsx("option",{value:"4",children:"4"}),t.jsx("option",{value:"5",children:"5"})]})]})})]})]},e.PK)})})]}):t.jsx("div",{className:"flex items-center justify-center min-h-[280px]",children:t.jsx("p",{className:"text-2xl sm:text-3xl font-light text-slate-500/80 tracking-wide animate-pulse",children:"Enter search term or select categories"})}),m&&w>1&&t.jsxs("div",{className:"mt-2 flex flex-wrap items-center justify-center gap-2 text-xs",children:[t.jsx("button",{type:"button",disabled:f<=1,onClick:()=>g(e=>Math.max(1,e-1)),className:"min-h-[44px] flex items-center rounded-md border border-slate-700 bg-slate-950 px-4 py-2 text-slate-200 disabled:opacity-40",children:"Prev"}),t.jsxs("span",{className:"text-slate-500",children:["Page ",f," of ",w]}),t.jsx("button",{type:"button",disabled:f>=w,onClick:()=>g(e=>Math.min(w,e+1)),className:"min-h-[44px] flex items-center rounded-md border border-slate-700 bg-slate-950 px-4 py-2 text-slate-200 disabled:opacity-40",children:"Next"})]})]})};export{ee as default};
