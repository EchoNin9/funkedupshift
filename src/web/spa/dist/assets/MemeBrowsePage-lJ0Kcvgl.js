import{r as l,j as e,s as re,u as ne,a as le,t as oe,v as W,w as ce,f as O,x as ie,L as B}from"./index-Bal_br-M.js";import{F as H}from"./LinkIcon-B5a8-xkK.js";import{F as de}from"./PencilSquareIcon-D5UQwCMm.js";function me(o){return typeof window>"u"?o:`${window.location.origin}${o.startsWith("/")?o:`/${o}`}`}const xe=({memeId:o,title:h="",trigger:j,className:d=""})=>{const[y,m]=l.useState(!1),[u,S]=l.useState(!1),c=l.useRef(null),R=me(`/memes/${encodeURIComponent(o)}`),f=encodeURIComponent(R),E=encodeURIComponent(h||"Meme"),k=async()=>{try{await navigator.clipboard.writeText(R),S(!0),setTimeout(()=>S(!1),2e3)}catch{}};return l.useEffect(()=>{function w(N){c.current&&!c.current.contains(N.target)&&m(!1)}if(y)return document.addEventListener("mousedown",w),()=>document.removeEventListener("mousedown",w)},[y]),e.jsxs("div",{className:`relative inline-block ${d}`,ref:c,children:[e.jsx("button",{type:"button",onClick:()=>m(w=>!w),className:"inline-flex items-center gap-1 text-[11px] text-slate-400 hover:text-slate-200",children:j}),y&&e.jsxs("div",{className:"absolute left-0 top-full z-20 mt-1 min-w-[180px] rounded-lg border border-slate-700 bg-slate-900 p-2 shadow-xl",children:[e.jsxs("div",{className:"flex items-center gap-1.5 px-2 py-1 mb-2 text-xs font-medium text-slate-500 uppercase",children:[e.jsx(H,{className:"h-3.5 w-3.5"}),"Share"]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsxs("button",{type:"button",onClick:k,className:"flex items-center gap-2 rounded px-2 py-1.5 text-left text-sm text-slate-200 hover:bg-slate-800",children:[e.jsx(re,{className:"h-4 w-4 text-slate-500"}),"Copy link",u&&e.jsx("span",{className:"text-emerald-400 text-xs",children:"âœ“"})]}),e.jsx("a",{href:"https://www.instagram.com/",target:"_blank",rel:"noopener noreferrer",title:"Open Instagram",className:"flex items-center gap-2 rounded px-2 py-1.5 text-left text-sm text-slate-200 hover:bg-slate-800",onClick:()=>m(!1),children:"Instagram"}),e.jsx("a",{href:`https://www.facebook.com/sharer/sharer.php?u=${f}`,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2 rounded px-2 py-1.5 text-left text-sm text-slate-200 hover:bg-slate-800",onClick:()=>m(!1),children:"Facebook"}),e.jsx("a",{href:`https://bsky.app/intent/compose?text=${f}`,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2 rounded px-2 py-1.5 text-left text-sm text-slate-200 hover:bg-slate-800",onClick:()=>m(!1),children:"Bluesky"}),e.jsx("a",{href:`https://www.reddit.com/submit?url=${f}&title=${E}`,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2 rounded px-2 py-1.5 text-left text-sm text-slate-200 hover:bg-slate-800",onClick:()=>m(!1),children:"Reddit"})]})]})]})};function _(){if(typeof window>"u")return null;const o=window.API_BASE_URL;return o?o.replace(/\/$/,""):null}const Z="memes_my_cache_invalidate",he=()=>{const{user:o}=ne(),[h,j]=le(),d=(h.get("tab")||"all")==="mine"?"mine":"all",[y,m]=l.useState([]),[u,S]=l.useState(()=>h.get("q")??""),[c,R]=l.useState(()=>{const t=h.get("tagIds");return t?t.split(",").filter(Boolean):[]}),[f,E]=l.useState(()=>h.get("tagMode")==="and"?"and":"or"),[k,w]=l.useState(!1),[N,K]=l.useState(""),[g,G]=l.useState("newest"),[D,$]=l.useState(!1),[Y,I]=l.useState(null),L=l.useRef(null),[q,Q]=l.useState([]),M=l.useRef(null),[J,T]=l.useState(!1),X=oe(o),ee=W(o),te=ce(o),C=o&&W(o),se=t=>te||ee&&t.userId===(o==null?void 0:o.userId),A=u.trim().length>0||c.length>0;l.useEffect(()=>{try{const t=sessionStorage.getItem(Z);if(!t)return;sessionStorage.removeItem(Z);const s=JSON.parse(t);if(s.tagOnly&&s.memeId&&s.tags){const n=(M.current??[]).map(r=>r.PK===s.memeId?{...r,tags:s.tags}:r);if(M.current=n,d==="mine"){let r=n;c.length>0&&(r=f==="and"?n.filter(a=>c.every(i=>(a.tags??[]).includes(i))):n.filter(a=>c.some(i=>(a.tags??[]).includes(i)))),m(r)}}else T(!0)}catch{}},[]),l.useEffect(()=>{const t=_();if(!t)return;let s=!1;return O(`${t}/memes/tags`).then(n=>n.ok?n.json():Promise.reject(new Error("Failed to load tags"))).then(n=>{s||Q((n.tags??[]).sort((r,a)=>r.localeCompare(a)))}).catch(()=>{}),()=>{s=!0}},[]),l.useEffect(()=>{const t=new URLSearchParams;d==="mine"&&t.set("tab","mine"),A&&(u.trim()&&t.set("q",u.trim()),c.length&&(t.set("tagIds",c.join(",")),t.set("tagMode",f))),j(t,{replace:!0})},[d,A,u,c,f,j]),l.useEffect(()=>{const t=_();if(!t){I("API URL not set.");return}let s=!1;if(d==="mine"&&C){const r=M.current,a=c.length>0;if(r&&!J&&!u.trim()){T(!1);let i=r;a&&(f==="and"?i=r.filter(x=>c.every(b=>(x.tags??[]).includes(b))):i=r.filter(x=>c.some(b=>(x.tags??[]).includes(b)))),m(i),$(!1);return}}async function n(){$(!0),I(null);const r=d==="mine"&&C;try{const a=new URLSearchParams;a.set("limit",r?"100":"20"),r&&a.set("mine","1"),u.trim()&&a.set("q",u.trim()),c.length>0&&!r&&(a.set("tagIds",c.join(",")),a.set("tagMode",f));const x=await O(`${t}${o?"/memes":"/memes/cache"}?${a.toString()}`);if(!x.ok){const p=await x.text();throw new Error(`HTTP ${x.status}: ${p}`)}const b=await x.json();if(s)return;const v=b.memes??[];if(r)if(M.current=v,T(!1),c.length>0){const p=f==="and"?v.filter(U=>c.every(F=>(U.tags??[]).includes(F))):v.filter(U=>c.some(F=>(U.tags??[]).includes(F)));m(p)}else m(v);else m(v)}catch(a){s||I((a==null?void 0:a.message)??"Failed to load memes.")}finally{s||$(!1)}}return n(),()=>{s=!0}},[d,u,c,f,J,C,o]),l.useEffect(()=>{function t(s){L.current&&!L.current.contains(s.target)&&w(!1)}if(k)return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[k]);const z=l.useMemo(()=>q.filter(t=>!c.includes(t)&&(!N.trim()||t.toLowerCase().includes(N.toLowerCase()))),[q,c,N]),P=l.useMemo(()=>{const t=[...y];return t.sort((s,n)=>{const r=(s.title||s.PK||"").toLowerCase(),a=(n.title||n.PK||"").toLowerCase(),i=typeof s.averageRating=="number"?s.averageRating:0,x=typeof n.averageRating=="number"?n.averageRating:0,b=s.createdAt||"",v=n.createdAt||"";if(g==="newest"){const p=v.localeCompare(b);return p!==0?p:r.localeCompare(a)}if(g==="oldest"){const p=b.localeCompare(v);return p!==0?p:r.localeCompare(a)}return g==="avgDesc"?x!==i?x-i:r.localeCompare(a):g==="avgAsc"?i!==x?i-x:r.localeCompare(a):g==="alphaAsc"?r.localeCompare(a):g==="alphaDesc"?a.localeCompare(r):0}),t},[y,g]),ae=async(t,s)=>{const n=_();if(n)try{await O(`${n}/memes/stars`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({memeId:t,rating:s})}),m(r=>r.map(a=>a.PK===t?{...a,averageRating:s}:a))}catch{}};if(o&&!ie(o))return e.jsxs("div",{className:"space-y-6",children:[e.jsx("h1",{className:"text-2xl font-semibold tracking-tight text-slate-50",children:"Memes"}),e.jsx("div",{className:"rounded-md border border-slate-700 bg-slate-900/60 px-4 py-3 text-slate-200",children:"You do not have access to Memes. Join the Memes custom group or contact an admin."})]});const V=t=>{const s=new URLSearchParams(h);t==="mine"?s.set("tab","mine"):s.delete("tab"),j(s,{replace:!0})};return l.useEffect(()=>{d==="mine"&&!C&&j(t=>{const s=new URLSearchParams(t);return s.delete("tab"),s},{replace:!0})},[d,C,j]),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("header",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h1",{className:"text-2xl font-semibold tracking-tight text-slate-50",children:"Memes"}),C&&e.jsxs("div",{className:"flex rounded-lg border border-slate-700 bg-slate-900/60 p-0.5",children:[e.jsx("button",{type:"button",onClick:()=>V("all"),className:`rounded-md px-3 py-1 text-sm font-medium transition-colors ${d==="all"?"bg-slate-700 text-slate-50":"text-slate-400 hover:text-slate-200"}`,children:"All"}),e.jsx("button",{type:"button",onClick:()=>V("mine"),className:`rounded-md px-3 py-1 text-sm font-medium transition-colors ${d==="mine"?"bg-slate-700 text-slate-50":"text-slate-400 hover:text-slate-200"}`,children:"My Memes"})]})]}),e.jsx("p",{className:"text-sm text-slate-400",children:d==="mine"?"Your memes, newest first. Filter by tags below.":o?"Browse and rate memes. Latest 20 shown by default.":"The latest user created memes. Sign in to rate or create."})]}),o&&e.jsxs("section",{className:"rounded-xl border border-slate-800 bg-slate-950/60 p-4 space-y-4","aria-label":"Search and filter",children:[e.jsxs("form",{className:"flex flex-col gap-3 sm:flex-row sm:items-center",onSubmit:t=>{t.preventDefault(),S(u.trim())},children:[e.jsx("input",{type:"text",value:u,onChange:t=>S(t.target.value),placeholder:"Search memes (title, description)â€¦",className:"flex-1 rounded-md border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500 focus:border-brand-orange focus:outline-none focus:ring-1 focus:ring-brand-orange"}),e.jsx("button",{type:"submit",className:"inline-flex items-center justify-center rounded-md bg-brand-orange px-4 py-2 text-sm font-semibold text-slate-950 hover:bg-orange-500",children:"Search"})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-start gap-4 sm:gap-6",children:[e.jsxs("div",{ref:L,className:"relative flex-shrink-0 min-w-0 max-w-sm",children:[e.jsx("label",{htmlFor:"meme-tag-filter",className:"block text-xs font-medium text-slate-400 mb-1",children:"Tags (filter by)"}),e.jsx("input",{id:"meme-tag-filter",type:"text",value:N,onChange:t=>K(t.target.value),onFocus:()=>w(!0),placeholder:"Search and select tagsâ€¦",className:"w-full rounded-md border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500 focus:border-brand-orange focus:outline-none focus:ring-1 focus:ring-brand-orange",autoComplete:"off"}),k&&e.jsx("div",{className:"absolute left-0 top-full z-10 mt-1 w-full max-h-48 overflow-auto scrollbar-thin rounded-md border border-slate-700 bg-slate-900 shadow-lg",role:"listbox",children:z.length>0?z.map(t=>e.jsx("button",{type:"button",role:"option",onClick:()=>{R(s=>s.includes(t)?s:[...s,t]),K("")},className:"block w-full text-left px-3 py-2 text-sm text-slate-200 hover:bg-slate-800",children:t},t)):e.jsx("div",{className:"px-3 py-2 text-xs text-slate-500",children:"No matching tags"})}),c.length>0&&e.jsxs("div",{className:"mt-2 flex flex-wrap gap-1",children:[c.map(t=>e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-slate-800 px-2 py-0.5 text-xs text-slate-300",children:[t,e.jsx("button",{type:"button",onClick:()=>R(s=>s.filter(n=>n!==t)),className:"hover:text-slate-100","aria-label":`Remove ${t}`,children:"Ã—"})]},t)),e.jsxs("select",{value:f,onChange:t=>E(t.target.value),className:"rounded border border-slate-700 bg-slate-950 px-2 py-0.5 text-[11px] text-slate-400",children:[e.jsx("option",{value:"or",children:"OR"}),e.jsx("option",{value:"and",children:"AND"})]})]})]}),e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsx("label",{className:"text-xs font-medium text-slate-400",children:"Sort"}),e.jsxs("select",{value:g,onChange:t=>G(t.target.value),className:"rounded-md border border-slate-700 bg-slate-950 px-2 py-1 text-xs text-slate-50 focus:border-brand-orange focus:outline-none focus:ring-1 focus:ring-brand-orange",children:[e.jsx("option",{value:"newest",children:"Newest first"}),e.jsx("option",{value:"oldest",children:"Oldest first"}),e.jsx("option",{value:"avgDesc",children:"Avg stars (high first)"}),e.jsx("option",{value:"avgAsc",children:"Avg stars (low first)"}),e.jsx("option",{value:"alphaAsc",children:"Title Aâ€“Z"}),e.jsx("option",{value:"alphaDesc",children:"Title Zâ€“A"})]}),e.jsx("span",{className:"text-slate-500",children:P.length===0?"No memes":`${P.length} memes`})]})]})]}),Y&&e.jsx("div",{className:"rounded-md border border-red-500/60 bg-red-500/10 px-3 py-2 text-xs text-red-200",children:Y}),D?e.jsx("div",{className:"text-sm text-slate-400",children:"Loading memesâ€¦"}):e.jsxs(e.Fragment,{children:[e.jsx("ul",{className:"space-y-3 mt-2",children:P.map(t=>{const s=t.thumbnailUrl||t.mediaUrl,n=t.title||t.PK||"Untitled",r=`/memes/${encodeURIComponent(t.PK)}`;return e.jsxs("li",{className:"flex gap-3 rounded-xl border border-slate-800 bg-slate-950/60 p-3",children:[e.jsx(B,{to:r,className:"h-16 w-24 flex-shrink-0 overflow-hidden rounded-lg border border-slate-700 bg-slate-900 flex items-center justify-center text-xl hover:border-slate-600",children:s?e.jsx("img",{src:s,alt:"",className:"h-full w-full object-cover",onError:a=>{a.currentTarget.style.visibility="hidden"}}):e.jsx("span",{children:"ðŸ–¼"})}),e.jsxs("div",{className:"min-w-0 flex-1 space-y-1",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("h2",{className:"truncate text-sm font-semibold text-slate-50",children:e.jsx(B,{to:r,className:"hover:text-brand-orange",children:n})}),t.isPrivate&&e.jsx("span",{className:"inline-flex rounded-full bg-slate-900 px-2 py-0.5 text-[10px] uppercase text-slate-500",children:"Private"}),typeof t.averageRating=="number"&&e.jsxs("span",{className:"inline-flex rounded-full bg-slate-900 px-2 py-0.5 text-[11px] text-amber-300",children:[t.averageRating.toFixed(1),"â˜…"]})]}),t.description&&e.jsx("p",{className:"text-xs text-slate-300 line-clamp-3",children:t.description}),t.tags&&t.tags.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1 pt-1",children:t.tags.map(a=>e.jsx("span",{className:"rounded-full bg-slate-900 px-2 py-0.5 text-[11px] text-slate-300",children:a},a))}),e.jsxs("div",{className:"pt-1 flex items-center gap-3 flex-wrap",children:[e.jsx(xe,{memeId:t.PK,title:n,trigger:e.jsxs(e.Fragment,{children:[e.jsx(H,{className:"h-3.5 w-3.5"}),"Share"]})}),se(t)&&e.jsxs(B,{to:`/memes/${encodeURIComponent(t.PK)}/edit`,className:"inline-flex items-center gap-1 text-[11px] text-slate-400 hover:text-slate-200",children:[e.jsx(de,{className:"h-3.5 w-3.5"}),"Edit"]}),X&&e.jsxs("label",{className:"inline-flex items-center gap-1 text-[11px] text-slate-400",children:[e.jsx("span",{children:"Rate:"}),e.jsxs("select",{className:"rounded border border-slate-700 bg-slate-950 px-1 py-0.5 text-[11px] text-slate-50",onChange:a=>{const i=Number(a.target.value);i>=1&&i<=5&&ae(t.PK,i)},defaultValue:"",children:[e.jsx("option",{value:"",children:"--"}),e.jsx("option",{value:"5",children:"5"}),e.jsx("option",{value:"4",children:"4"}),e.jsx("option",{value:"3",children:"3"}),e.jsx("option",{value:"2",children:"2"}),e.jsx("option",{value:"1",children:"1"})]})]})]})]})]},t.PK)})}),P.length===0&&!D&&e.jsx("div",{className:"flex items-center justify-center min-h-[200px]",children:e.jsx("p",{className:"text-lg text-slate-500",children:d==="mine"?A?"No memes match the selected tags.":"You haven't created any memes yet. Create one!":A?"No memes found.":"No memes yet. Create one!"})})]})]})};export{he as default};
