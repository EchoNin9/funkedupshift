import{u as ce,d as me,r,v as xe,j as e,L as ge,c as S}from"./index-BLy7dBGz.js";import{A as ue}from"./AddTagInput-Dd8yDX1v.js";import{F as pe}from"./ArrowLeftIcon-Gu1dq-Pj.js";const H=["Impact","Arial Black","Comic Sans MS","Georgia","Verdana","Times New Roman","Courier New"],R=[{id:"top-left",x:.05,y:.05,align:"left"},{id:"top-center",x:.5,y:.05,align:"center"},{id:"top-right",x:.95,y:.05,align:"right"},{id:"center",x:.5,y:.5,align:"center"},{id:"bottom-left",x:.05,y:.95,align:"left"},{id:"bottom-center",x:.5,y:.95,align:"center"},{id:"bottom-right",x:.95,y:.95,align:"right"}],I=500,he=2048,fe=10*1024*1024;function T(){if(typeof window>"u")return null;const b=window.API_BASE_URL;return b?b.replace(/\/$/,""):null}const we=()=>{const{user:b}=ce(),V=me(),M=r.useRef(null),p=r.useRef([]),[v,E]=r.useState(null),[be,A]=r.useState(null),[B,U]=r.useState(""),[O,k]=r.useState([]),[K,$]=r.useState(null),[z,F]=r.useState(""),[_,Y]=r.useState(""),[L,Q]=r.useState(!1),[j,D]=r.useState("resize"),[G,J]=r.useState(!1),[Z,d]=r.useState(null),[X,q]=r.useState(!1),[W,ee]=r.useState([]),[te,ae]=r.useState([]),se=t=>{const a=p.current;if(a.some(o=>o.zoneId===t))return;const s=[...a,{zoneId:t,text:"",font:H[0],color:"#ffffff",size:32}];p.current=s,k(s),$(t)},re=t=>{const s=p.current.filter(o=>o.zoneId!==t);p.current=s,k(s),K===t&&$(null)},C=(t,a)=>{const o=p.current.map(n=>n.zoneId===t?{...n,...a}:n);p.current=o,k(o)},ne=t=>{if(t.size>fe){d("File too large (max 10MB)");return}if(!["image/jpeg","image/png","image/gif","image/webp","image/bmp"].includes(t.type)){d("Invalid image type");return}d(null);const s=new FileReader;s.onload=()=>E(s.result),s.readAsDataURL(t),A(t),U("")},oe=async()=>{const t=B.trim();if(t){d(null);try{const s=await(await S(`${T()}/memes/import-from-url`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:t})})).json();if(!s.presignedUrl){d(s.error||"Failed to load image from URL");return}E(s.presignedUrl),A(null)}catch(a){d((a==null?void 0:a.message)??"Failed to load image from URL")}}},le=async()=>{const t=T();if(t){q(!0),d(null);try{const s=await(await S(`${t}/memes/generate-title`,{method:"POST"})).json();s.title&&F(s.title)}catch{F(`Meme ${Date.now().toString(36)}`)}finally{q(!1)}}},P=r.useCallback(()=>{const t=M.current;if(!t||!v)return Promise.resolve();const a=t.getContext("2d");return a?new Promise((s,o)=>{const n=new Image;n.crossOrigin="anonymous",n.onload=()=>{const h=t.width,y=t.height;a.clearRect(0,0,h,y);let i=0,g=0,c=h,u=y;if(j==="resize")a.drawImage(n,0,0,h,y);else{const l=Math.min(h/n.width,y/n.height);c=n.width*l,u=n.height*l,i=(h-c)/2,g=(y-u)/2,a.drawImage(n,i,g,c,u)}const N=j==="original"?Math.min(c,u)/I:1;p.current.forEach(l=>{const w=R.find(f=>f.id===l.zoneId);if(!w||!l.text)return;a.font=`${Math.round(l.size*N)}px ${l.font}`,a.fillStyle=l.color,a.textAlign=w.align,a.textBaseline=w.y<.5?"top":"bottom";const m=i+w.x*c,x=g+w.y*u;a.fillText(l.text,m,x)}),s()},n.onerror=()=>{d("Failed to load image"),o(new Error("Failed to load image"))},n.src=v}):Promise.resolve()},[v,O,j]);r.useEffect(()=>{P().catch(()=>{})},[P]),r.useEffect(()=>{const t=T();if(!t)return;let a=!1;return fetch(`${t}/memes/tags`).then(s=>s.ok?s.json():Promise.reject(new Error("Failed to load tags"))).then(s=>{a||ae((s.tags??[]).sort((o,n)=>o.localeCompare(n)))}).catch(()=>{}),()=>{a=!0}},[]);const ie=async()=>{if(!v){d("Add an image first");return}const t=T();if(!t){d("API not configured");return}J(!0),d(null);try{let a;if(j==="original"){const i=await new Promise((m,x)=>{const f=new Image;f.crossOrigin="anonymous",f.onload=()=>m(f),f.onerror=()=>x(new Error("Failed to load image")),f.src=v}),g=Math.min(1,he/Math.max(i.width,i.height)),c=Math.round(i.width*g),u=Math.round(i.height*g),N=document.createElement("canvas");N.width=c,N.height=u;const l=N.getContext("2d");l.drawImage(i,0,0,c,u);const w=Math.min(c,u)/I;p.current.forEach(m=>{const x=R.find(f=>f.id===m.zoneId);!x||!m.text||(l.font=`${Math.round(m.size*w)}px ${m.font}`,l.fillStyle=m.color,l.textAlign=x.align,l.textBaseline=x.y<.5?"top":"bottom",l.fillText(m.text,x.x*c,x.y*u))}),a=await new Promise(m=>{N.toBlob(x=>m(x),"image/png",.95)})}else{const i=M.current;if(!i)throw new Error("Canvas not available");await P(),await new Promise(g=>requestAnimationFrame(g)),a=await new Promise(g=>{i.toBlob(c=>g(c),"image/png",.95)})}if(!a)throw new Error("Failed to export canvas");const o=await(await S(`${t}/memes/upload`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contentType:"image/png"})})).json();if(!o.uploadUrl||!o.key)throw new Error(o.error||"Failed to get upload URL");const n=o.key;await fetch(o.uploadUrl,{method:"PUT",body:a,headers:{"Content-Type":"image/png"}});const h=await S(`${t}/memes`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({mediaKey:n,title:z.trim()||void 0,description:_.trim()||void 0,isPrivate:L,textBoxes:p.current,sizeMode:j,tags:W})});if(!h.ok){const i=await h.json();throw new Error(i.error||"Failed to save meme")}const y=await h.json();try{sessionStorage.setItem("memes_my_cache_invalidate",JSON.stringify({tagOnly:!1}))}catch{}V(y.id?`/memes/${encodeURIComponent(y.id)}`:"/memes")}catch(a){d((a==null?void 0:a.message)??"Failed to save meme")}finally{J(!1)}},de=xe(b)||!!(b!=null&&b.impersonated);return b?de?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("header",{className:"flex items-center gap-4",children:[e.jsxs(ge,{to:"/memes",className:"inline-flex items-center gap-1 text-sm text-slate-400 hover:text-slate-200",children:[e.jsx(pe,{className:"h-4 w-4"}),"Back to Memes"]}),e.jsx("h1",{className:"text-2xl font-semibold tracking-tight text-slate-50",children:"Meme Generator"})]}),e.jsxs("div",{className:"grid gap-6 lg:grid-cols-[1fr,320px]",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded-xl border border-slate-800 bg-slate-950/60 p-4",children:[e.jsx("label",{className:"block text-xs font-medium text-slate-400 mb-2",children:"Image"}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("input",{type:"file",accept:"image/jpeg,image/png,image/gif,image/webp,image/bmp",onChange:t=>{var a;return((a=t.target.files)==null?void 0:a[0])&&ne(t.target.files[0])},className:"text-sm text-slate-300 file:mr-2 file:rounded file:border-0 file:bg-brand-orange file:px-3 file:py-1 file:text-slate-950"}),e.jsx("span",{className:"text-xs text-slate-500",children:"or"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"url",value:B,onChange:t=>U(t.target.value),placeholder:"Paste image URL",className:"flex-1 rounded-md border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500"}),e.jsx("button",{type:"button",onClick:oe,className:"rounded-md bg-slate-700 px-3 py-2 text-sm text-slate-200 hover:bg-slate-600",children:"Load"})]})]})]}),v&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"rounded-xl border border-slate-800 bg-slate-950/60 p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("label",{className:"text-xs font-medium text-slate-400",children:"Preview"}),e.jsxs("div",{className:"flex rounded-md border border-slate-700 overflow-hidden",children:[e.jsx("button",{type:"button",onClick:()=>D("resize"),className:`px-3 py-1 text-xs transition-colors ${j==="resize"?"bg-brand-orange text-slate-950 font-medium":"bg-slate-950 text-slate-400 hover:text-slate-200"}`,children:"Resize to fit"}),e.jsx("button",{type:"button",onClick:()=>D("original"),className:`px-3 py-1 text-xs transition-colors ${j==="original"?"bg-brand-orange text-slate-950 font-medium":"bg-slate-950 text-slate-400 hover:text-slate-200"}`,children:"Original"})]})]}),e.jsx("canvas",{ref:M,width:I,height:I,className:"w-full max-w-[500px] border border-slate-700 rounded-lg bg-slate-900"})]}),e.jsxs("div",{className:"rounded-xl border border-slate-800 bg-slate-950/60 p-4",children:[e.jsx("label",{className:"block text-xs font-medium text-slate-400 mb-2",children:"Text boxes (fixed zones)"}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-2",children:R.map(t=>{const a=O.find(s=>s.zoneId===t.id);return e.jsxs("div",{className:"rounded border border-slate-700 p-2",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-xs text-slate-400",children:t.id}),a?e.jsx("button",{type:"button",onClick:()=>re(t.id),className:"text-red-400 hover:text-red-300 text-xs",children:"Remove"}):e.jsx("button",{type:"button",onClick:()=>se(t.id),className:"text-brand-orange hover:text-orange-400 text-xs",children:"Add"})]}),a&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("input",{type:"text",value:a.text,onChange:s=>C(t.id,{text:s.target.value}),placeholder:"Text",className:"w-full rounded border border-slate-700 bg-slate-950 px-2 py-1 text-xs text-slate-50"}),e.jsx("select",{value:a.font,onChange:s=>C(t.id,{font:s.target.value}),className:"w-full rounded border border-slate-700 bg-slate-950 px-2 py-1 text-[11px] text-slate-300",children:H.map(s=>e.jsx("option",{value:s,children:s},s))}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx("input",{type:"color",value:a.color,onChange:s=>C(t.id,{color:s.target.value}),className:"h-6 w-8 cursor-pointer rounded border border-slate-700"}),e.jsx("input",{type:"number",value:a.size,onChange:s=>C(t.id,{size:Number(s.target.value)||32}),min:12,max:72,className:"w-14 rounded border border-slate-700 bg-slate-950 px-1 py-0.5 text-[11px] text-slate-50"})]})]})]},t.id)})})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded-xl border border-slate-800 bg-slate-950/60 p-4 space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-slate-400 mb-1",children:"Title (optional)"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:z,onChange:t=>F(t.target.value),placeholder:"Generate or type",className:"flex-1 rounded-md border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500"}),e.jsx("button",{type:"button",onClick:le,disabled:X,className:"rounded-md bg-brand-orange px-3 py-2 text-sm font-medium text-slate-950 disabled:opacity-50",children:X?"…":"Generate"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-slate-400 mb-1",children:"Description (optional)"}),e.jsx("textarea",{value:_,onChange:t=>Y(t.target.value),placeholder:"Optional description",rows:3,className:"w-full rounded-md border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-slate-400 mb-1",children:"Tags"}),e.jsx(ue,{tags:W,onTagsChange:ee,allTags:te,fetchTags:async t=>{const a=T();if(!a)return[];const s=await S(`${a}/memes/tags?q=${encodeURIComponent(t)}`);return s.ok?(await s.json()).tags??[]:[]},placeholder:"Type to suggest or create tag, Tab to autocomplete"})]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm text-slate-300",children:[e.jsx("input",{type:"checkbox",checked:L,onChange:t=>Q(t.target.checked),className:"rounded border-slate-600"}),"Private (only you can see)"]})]}),Z&&e.jsx("div",{className:"rounded-md border border-red-500/60 bg-red-500/10 px-3 py-2 text-xs text-red-200",children:Z}),e.jsx("button",{type:"button",onClick:ie,disabled:!v||G,className:"w-full rounded-md bg-brand-orange px-4 py-3 text-sm font-semibold text-slate-950 hover:bg-orange-500 disabled:opacity-50 disabled:cursor-not-allowed",children:G?"Saving…":"Save meme"})]})]})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("h1",{className:"text-2xl font-semibold text-slate-50",children:"Meme Generator"}),e.jsx("div",{className:"rounded-md border border-slate-700 bg-slate-900/60 px-4 py-3 text-slate-200",children:"Meme creator access required (user + Memes group). Join the Memes custom group or contact an admin."})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("h1",{className:"text-2xl font-semibold text-slate-50",children:"Meme Generator"}),e.jsx("div",{className:"rounded-md border border-slate-700 bg-slate-900/60 px-4 py-3 text-slate-200",children:"Sign in to create memes."})]})};export{we as default};
