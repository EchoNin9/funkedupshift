import{u as we,p as Se,r as n,c as L,j as e,q as Ee}from"./index-DYvV5D9I.js";import{A as Fe}from"./AdminTabs-D8VMsYk5.js";function C(){if(typeof window>"u")return null;const d=window.API_BASE_URL;return d?d.replace(/\/$/,""):null}function Le(d){if(!d)return"—";try{const u=new Date(d+"T12:00:00Z");if(isNaN(u.getTime()))return d;const v=u.getUTCFullYear(),g=["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"][u.getUTCMonth()],N=String(u.getUTCDate()).padStart(2,"0");return`${v}-${g}-${N}`}catch{return d||"—"}}function Ce(d,u){const v=d.fuelPrice??0,g=d.fuelLitres??0,N=d.odometerKm??0,i=(u==null?void 0:u.odometerKm)??N,b=Math.max(0,N-i),A=g>0?v/g:null,y=b>0&&g>0?g/b*100:null,D=y!=null&&y>0?235.215/y:null;return{pricePerLitre:A,distanceKm:b,lPer100km:y,mpg:D}}const Ve=()=>{const{user:d}=we(),u=Se(d),v=n.useRef(null),[g,N]=n.useState([]),[i,b]=n.useState(null),[A,y]=n.useState([]),[D,O]=n.useState(!0),[ae,H]=n.useState(!1),[W,h]=n.useState(null),[P,w]=n.useState(!1),[G,T]=n.useState(!1),[K,X]=n.useState(""),[p,k]=n.useState({date:new Date().toISOString().slice(0,10),fuelPrice:"",fuelLitres:"",odometerKm:""}),[q,Z]=n.useState(!1),[z,Q]=n.useState(null),[ee,ie]=n.useState(!1),U=n.useCallback(async()=>{var l;const t=C();if(t){O(!0),h(null);try{const s=await L(`${t}/vehicles-expenses`);if(!s.ok){const c=await s.json().catch(()=>({}));throw new Error(c.error||"Failed to load vehicles")}const a=(await s.json()).vehicles??[];N(a),a.length>0&&!i&&b(a[0].id),i&&!a.find(c=>c.id===i)&&b(((l=a[0])==null?void 0:l.id)??null)}catch(s){h(s instanceof Error?s.message:"Failed to load vehicles"),N([])}finally{O(!1)}}},[i]),_=n.useCallback(async t=>{const l=C();if(l){H(!0);try{const s=await L(`${l}/vehicles-expenses/${encodeURIComponent(t)}/fuel`);if(!s.ok)throw new Error("Failed to load fuel entries");const a=(await s.json()).entries??[];a.sort((c,S)=>(S.date||"").localeCompare(c.date||"")),y(a)}catch{y([])}finally{H(!1)}}},[]);n.useEffect(()=>{u?U():O(!1)},[u,U]),n.useEffect(()=>{i?_(i):y([])},[i,_]);const ne=async()=>{const t=K.trim();if(!t)return;const l=C();if(l){w(!0),h(null);try{const s=await L(`${l}/vehicles-expenses`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t})});if(!s.ok){const a=await s.json().catch(()=>({}));throw new Error(a.error||"Failed to create")}const m=await s.json();N(a=>[...a,m]),b(m.id),X(""),T(!1)}catch(s){h(s instanceof Error?s.message:"Failed to create vehicle")}finally{w(!1)}}},oe=async()=>{if(!i)return;const t=C();if(!t)return;const l=parseFloat(p.fuelPrice),s=parseFloat(p.fuelLitres),m=parseFloat(p.odometerKm);if(!(isNaN(l)||isNaN(s)||isNaN(m))){w(!0),h(null);try{const a=await L(`${t}/vehicles-expenses/${encodeURIComponent(i)}/fuel`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({date:p.date,fuelPrice:l,fuelLitres:s,odometerKm:m})});if(!a.ok){const c=await a.json().catch(()=>({}));throw new Error(c.error||"Failed to add")}k({date:new Date().toISOString().slice(0,10),fuelPrice:"",fuelLitres:"",odometerKm:""}),_(i)}catch(a){h(a instanceof Error?a.message:"Failed to add fuel entry")}finally{w(!1)}}},ce=async t=>{if(!i||!window.confirm("Delete this fuel entry?"))return;const l=C();if(l){w(!0),h(null);try{if(!(await L(`${l}/vehicles-expenses/${encodeURIComponent(i)}/fuel/${encodeURIComponent(t)}`,{method:"DELETE"})).ok)throw new Error("Failed to delete");_(i)}catch(s){h(s instanceof Error?s.message:"Failed to delete")}finally{w(!1)}}},de=async t=>{var s,m,a;const l=(s=t.target.files)==null?void 0:s[0];if(l){Z(!0),Q(null),h(null);try{const c=await Ee(()=>import("./xlsx-D_0l8YDs.js"),[]),S=await l.arrayBuffer(),R=c.read(S,{type:"array",raw:!0}),te=R.SheetNames[0];if(!te)throw new Error("Excel file has no sheets");const se=R.Sheets[te];if(!se)throw new Error("Could not read first sheet");const V=c.utils.sheet_to_json(se,{header:1,raw:!0,defval:""});if(!V.length)throw new Error("Excel sheet is empty");const xe=!!((a=(m=R.Workbook)==null?void 0:m.WBProps)!=null&&a.date1904)?24107:25569,M=[],f={},le=V[0];for(let o=0;o<le.length;o++){const r=String(le[o]??"").toLowerCase().trim();r&&(r.includes("date")?f.date=o:r.includes("litre")||r.includes("liter")||r.includes("volume")?f.fuelLitres=o:r.includes("price")||r.includes("cost")||r.includes("fuel")&&!r.includes("litre")?f.fuelPrice=o:r.includes("odometer")||r.includes("mileage")||r.includes("km")&&!r.includes("l/100")?f.odometerKm=o:r.includes("vehicle")&&(f.vehicle=o))}const pe=f.date??0,he=f.fuelPrice??1,fe=f.fuelLitres??2,ge=f.odometerKm??3,be=f.vehicle??4,I={};for(let o=1;o<V.length;o++){const r=V[o];if(!Array.isArray(r))continue;const x=r[pe],j=r[he],E=r[fe],F=r[ge],Ne=r[be];if(x==null&&j==null&&E==null&&F==null||x===""&&j===""&&E===""&&F==="")continue;let Y="";typeof x=="number"&&!isNaN(x)&&x>0?Y=new Date((x-xe)*86400*1e3).toISOString().slice(0,10):Y=String(x??"").trim().slice(0,10);const ye=typeof j=="number"&&!isNaN(j)?j:parseFloat(String(j??"").replace(/,/g,""))||0,je=typeof E=="number"&&!isNaN(E)?E:parseFloat(String(E??"").replace(/,/g,""))||0,ve=typeof F=="number"&&!isNaN(F)?F:parseFloat(String(F??"").replace(/,/g,""))||0,J=String(Ne??"").trim()||"Vehicle";I[J]||(I[J]=[]),I[J].push({date:Y,fuelPrice:ye,fuelLitres:je,odometerKm:ve})}for(const[o,r]of Object.entries(I))r.length>0&&M.push({vehicleName:o,entries:r});if(M.length===0)throw new Error("No valid data rows found. Ensure columns: Date, Fuel Price, Fuel Litres, Odometer (km), Vehicle.");const re=C();if(!re)throw new Error("API URL not set");const $=await L(`${re}/vehicles-expenses/import`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({imports:M})});if(!$.ok){const o=await $.json().catch(()=>({})),r=o.error,x=o.errors,j=r||(x!=null&&x.length?x.join("; "):null)||`Import failed (${$.status})`;throw new Error(j)}const B=await $.json();Q(`Imported ${B.created??0} entries.${(B.errors??[]).length?` Errors: ${B.errors.join("; ")}`:""}`),U(),i&&_(i)}catch(c){h(c instanceof Error?c.message:"Import failed")}finally{Z(!1),t.target.value=""}}};if(!d)return e.jsxs("div",{className:"space-y-4",children:[e.jsx("h1",{className:"text-2xl font-display font-bold text-slate-100",children:"Vehicles Expenses"}),e.jsx("p",{className:"text-slate-400",children:"Sign in to access your vehicle expenses."})]});if(!u)return e.jsxs("div",{className:"space-y-4",children:[e.jsx("h1",{className:"text-2xl font-display font-bold text-slate-100",children:"Vehicles Expenses"}),e.jsx("p",{className:"text-slate-400",children:"You need to be in the expenses group to access this section. Contact an admin to be added."})]});const me=[...g.map(t=>({id:t.id,label:t.name||"Unnamed"})),{id:"__add__",label:"+ Add vehicle"}],ue=G?"__add__":i??"__add__";return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-display font-bold text-slate-100",children:"Vehicles Expenses"}),e.jsx("p",{className:"text-slate-400 mt-1",children:"Track fuel costs per vehicle. Data is private to you."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{ref:v,type:"file",accept:".xlsx,.xls",className:"hidden",onChange:de}),e.jsx("button",{onClick:()=>{var t;return(t=v.current)==null?void 0:t.click()},disabled:q,className:"rounded-md border border-slate-600 bg-slate-800 px-4 py-2 text-sm text-slate-200 hover:bg-slate-700 disabled:opacity-50",children:q?"Importing…":"Import from Excel"}),e.jsx("button",{type:"button",onClick:()=>ie(t=>!t),className:"text-sm text-slate-400 hover:text-slate-200",children:ee?"Hide format":"Import format"})]})]}),ee&&e.jsxs("div",{className:"rounded-lg border border-slate-700 bg-slate-900/50 p-4 text-sm text-slate-300 space-y-2",children:[e.jsx("p",{className:"font-medium text-slate-200",children:"Excel import format"}),e.jsxs("p",{children:["Use columns: ",e.jsx("strong",{children:"Date"})," (YYYY-MM-DD), ",e.jsx("strong",{children:"Fuel Price"})," ($), ",e.jsx("strong",{children:"Fuel Litres"}),", ",e.jsx("strong",{children:"Odometer (km)"}),", ",e.jsx("strong",{children:"Vehicle"}),". First row = headers. See docs/vehicles-expenses-import.md for details."]})]}),W&&e.jsx("div",{className:"rounded-md border border-red-500/60 bg-red-500/10 px-3 py-2 text-sm text-red-200",children:W}),z&&e.jsx("div",{className:"rounded-md border border-green-500/60 bg-green-500/10 px-3 py-2 text-sm text-green-200",children:z}),e.jsx(Fe,{tabs:me,activeId:ue,onSelect:t=>{t==="__add__"?(T(!0),b(null)):(T(!1),b(t))}}),G?e.jsxs("div",{className:"rounded-lg border border-slate-700 bg-slate-900/50 p-4",children:[e.jsx("h2",{className:"text-sm font-semibold text-slate-300 mb-3",children:"Add vehicle"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",placeholder:"Vehicle name",value:K,onChange:t=>X(t.target.value),className:"rounded-md border border-slate-600 bg-slate-800 px-3 py-2 text-slate-100 placeholder-slate-500 flex-1"}),e.jsx("button",{onClick:ne,disabled:P||!K.trim(),className:"rounded-md bg-primary-500 px-4 py-2 text-sm font-medium text-white hover:bg-primary-600 disabled:opacity-50",children:P?"Adding…":"Add"})]})]}):i?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"rounded-lg border border-slate-700 bg-slate-900/50 p-4",children:[e.jsx("h2",{className:"text-sm font-semibold text-slate-300 mb-3",children:"Add fuel expense"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3",children:[e.jsx("input",{type:"date",value:p.date,onChange:t=>k(l=>({...l,date:t.target.value})),className:"rounded-md border border-slate-600 bg-slate-800 px-3 py-2 text-slate-100"}),e.jsx("input",{type:"number",step:"0.01",placeholder:"Fuel price ($)",value:p.fuelPrice,onChange:t=>k(l=>({...l,fuelPrice:t.target.value})),className:"rounded-md border border-slate-600 bg-slate-800 px-3 py-2 text-slate-100 placeholder-slate-500"}),e.jsx("input",{type:"number",step:"0.001",placeholder:"Fuel litres",value:p.fuelLitres,onChange:t=>k(l=>({...l,fuelLitres:t.target.value})),className:"rounded-md border border-slate-600 bg-slate-800 px-3 py-2 text-slate-100 placeholder-slate-500"}),e.jsx("input",{type:"number",step:"1",placeholder:"Odometer (km)",value:p.odometerKm,onChange:t=>k(l=>({...l,odometerKm:t.target.value})),className:"rounded-md border border-slate-600 bg-slate-800 px-3 py-2 text-slate-100 placeholder-slate-500"})]}),e.jsx("button",{onClick:oe,disabled:P||!p.fuelPrice||!p.fuelLitres||!p.odometerKm,className:"mt-3 rounded-md bg-primary-500 px-4 py-2 text-sm font-medium text-white hover:bg-primary-600 disabled:opacity-50",children:P?"Adding…":"Add fuel entry"})]}),e.jsxs("div",{className:"rounded-lg border border-slate-700 bg-slate-900/50 overflow-hidden",children:[e.jsx("h2",{className:"text-sm font-semibold text-slate-300 px-4 py-3 border-b border-slate-700",children:"Fuel expenses (newest first)"}),ae?e.jsx("div",{className:"p-8 text-center text-slate-500",children:"Loading…"}):A.length===0?e.jsx("div",{className:"p-8 text-center text-slate-500",children:"No fuel entries yet. Add one above."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-slate-700",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase",children:"Date"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase",children:"Fuel price"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase",children:"Volume"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase",children:"$/L"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase",children:"L/100km"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase",children:"MPG"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase",children:"Odometer"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase",children:"Distance"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-slate-700",children:A.map((t,l)=>{const s=A[l+1]??null,{pricePerLitre:m,distanceKm:a,lPer100km:c,mpg:S}=Ce(t,s);return e.jsxs("tr",{className:"hover:bg-slate-800/50",children:[e.jsx("td",{className:"px-4 py-3 text-sm text-slate-200",children:Le(t.date)}),e.jsxs("td",{className:"px-4 py-3 text-sm text-right text-slate-300",children:["$",(t.fuelPrice??0).toLocaleString(void 0,{minimumFractionDigits:2})]}),e.jsxs("td",{className:"px-4 py-3 text-sm text-right text-slate-300",children:[(t.fuelLitres??0).toLocaleString(void 0,{minimumFractionDigits:3}),"L"]}),e.jsx("td",{className:"px-4 py-3 text-sm text-right text-slate-300",children:m!=null?`$${m.toLocaleString(void 0,{minimumFractionDigits:4})}/L`:"—"}),e.jsx("td",{className:"px-4 py-3 text-sm text-right text-slate-300",children:c!=null?c.toFixed(2):"—"}),e.jsx("td",{className:"px-4 py-3 text-sm text-right text-slate-300",children:S!=null?S.toFixed(1):"—"}),e.jsxs("td",{className:"px-4 py-3 text-sm text-right text-slate-300",children:[(t.odometerKm??0).toLocaleString()," km"]}),e.jsx("td",{className:"px-4 py-3 text-sm text-right text-slate-300",children:a>0?`${a.toLocaleString()} km`:"—"}),e.jsx("td",{className:"px-4 py-3 text-right",children:e.jsx("button",{onClick:()=>ce(t.id),disabled:P,className:"text-red-400 hover:text-red-300 text-sm",children:"Delete"})})]},t.id)})})]})})]})]}):D?e.jsx("div",{className:"p-8 text-center text-slate-500",children:"Loading vehicles…"}):g.length===0?e.jsx("div",{className:"rounded-lg border border-slate-700 bg-slate-900/50 p-8 text-center text-slate-500",children:'No vehicles yet. Click "+ Add vehicle" to create one.'}):null]})};export{Ve as default};
