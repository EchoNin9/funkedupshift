import{b as pe,d as he,u as fe,r,h as ge,c as p,j as e,L as xe}from"./index-Bal_br-M.js";import{A as $}from"./AdminPageHeader-DZ00d26O.js";import"./ArrowLeftIcon-DBoqJR81.js";function x(){if(typeof window>"u")return null;const b=window.API_BASE_URL;return b?b.replace(/\/$/,""):null}const je=()=>{const{id:b}=pe(),E=he(),{user:ee}=fe(),[te,j]=r.useState(!0),[v,D]=r.useState(""),[S,B]=r.useState(""),[A,ae]=r.useState(null),[C,N]=r.useState(null),[L,se]=r.useState("image"),[M,F]=r.useState(!1),[O,z]=r.useState(!1),[J,q]=r.useState(!1),[G,ne]=r.useState([]),[g,U]=r.useState([]),[R,K]=r.useState(""),[ie,W]=r.useState(!1),[P,_]=r.useState(!1),[H,V]=r.useState(!1),[Y,h]=r.useState(null),[T,o]=r.useState(null),I=ge(ee??null,"manager"),l=b?decodeURIComponent(b):"";r.useEffect(()=>{var a;if(!I||!l){j(!1);return}const t=x();if(!t){o("API URL not set."),j(!1);return}if(!((a=window.auth)!=null&&a.getAccessToken)){o("Sign in required."),j(!1);return}let s=!1;return(async()=>{try{const n=await p(`${t}/media?id=${encodeURIComponent(l)}`);if(n.status===404||!n.ok){s||o("Media not found.");return}const d=await n.json(),c=Array.isArray(d.media)?d.media[0]:d.media;if(s||!c)return;const m=c;D(m.title??""),B(m.description??""),ae(m.mediaUrl||null),N(m.thumbnailUrl||null),se(m.mediaType||"image"),U(Array.isArray(m.categoryIds)?m.categoryIds:[]);const u=await p(`${t}/media-categories`);if(u.ok&&!s){const f=await u.json();ne((f.categories??[]).map(y=>({id:y.PK||y.id||"",name:y.name||y.PK||""})))}}catch(n){s||o((n==null?void 0:n.message)??"Failed to load.")}finally{s||j(!1)}})(),()=>{s=!0}},[I,l]);const re=t=>{g.includes(t)||U([...g,t]),K(""),W(!1)},oe=t=>{U(g.filter(i=>i!==t))},Q=G.filter(t=>!g.includes(t.id)&&(!R.trim()||(t.name||"").toLowerCase().includes(R.toLowerCase()))),le=async t=>{var a;if(t.preventDefault(),!l)return;const i=x();if(!i){o("API URL not set.");return}const s=window;if(!((a=s.auth)!=null&&a.getAccessToken)){o("Sign in required.");return}_(!0),o(null),h(null);try{const n=await new Promise(c=>s.auth.getAccessToken(c)),d=await p(`${i}/media`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({id:l,title:v.trim()||"Untitled",description:S.trim(),categoryIds:g})});if(!d.ok)throw new Error(await d.text());h("Media updated."),setTimeout(()=>E("/media"),1200)}catch(n){o((n==null?void 0:n.message)??"Failed to update media.")}finally{_(!1)}},de=async t=>{var n,d;const i=(n=t.target.files)==null?void 0:n[0];if(!i||!l)return;if(!i.type.startsWith("image/")){o("Please choose an image (PNG, JPEG, GIF, WebP).");return}const s=x();if(!s)return;const a=window;if((d=a.auth)!=null&&d.getAccessToken){z(!0),o(null),h(null);try{const c=await new Promise(w=>a.auth.getAccessToken(w)),m=await p(`${s}/media/thumbnail-upload`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`},body:JSON.stringify({mediaId:l,contentType:i.type||"image/png"})});if(!m.ok)throw new Error("Upload request failed");const{uploadUrl:u,key:f}=await m.json();if(!(await fetch(u,{method:"PUT",headers:{"Content-Type":i.type||"image/png"},body:i})).ok)throw new Error("File upload failed");const X=await p(`${s}/media`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`},body:JSON.stringify({id:l,thumbnailKey:f})});if(!X.ok)throw new Error(await X.text());const Z=await p(`${s}/media?id=${encodeURIComponent(l)}`);if(Z.ok){const w=await Z.json(),k=Array.isArray(w.media)?w.media[0]:w.media;k!=null&&k.thumbnailUrl&&N(k.thumbnailUrl)}h("Logo/thumbnail updated.")}catch(c){o((c==null?void 0:c.message)??"Failed to upload thumbnail.")}finally{z(!1),t.target.value=""}}},ce=async()=>{var s;if(!l||!window.confirm("Remove the custom logo/thumbnail? You can regenerate from video or upload a new one."))return;const t=x();if(!t)return;const i=window;if((s=i.auth)!=null&&s.getAccessToken){q(!0),o(null),h(null);try{const a=await new Promise(d=>i.auth.getAccessToken(d)),n=await p(`${t}/media`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({id:l,deleteThumbnail:!0})});if(!n.ok)throw new Error(await n.text());N(null),h("Logo/thumbnail removed.")}catch(a){o((a==null?void 0:a.message)??"Failed to remove thumbnail.")}finally{q(!1)}}},me=async()=>{var s;if(!l)return;const t=x();if(!t)return;const i=window;if((s=i.auth)!=null&&s.getAccessToken){F(!0),o(null),h(null);try{const a=await new Promise(c=>i.auth.getAccessToken(c)),n=await p(`${t}/media/regenerate-thumbnail`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({mediaId:l})});if(!n.ok)throw new Error(await n.text());h("Thumbnail regeneration started. New thumbnail will appear in 30–60 seconds.");const d=async c=>{if(c>6)return;await new Promise(u=>setTimeout(u,1e4));const m=await p(`${t}/media?id=${encodeURIComponent(l)}`);if(m.ok){const u=await m.json(),f=Array.isArray(u.media)?u.media[0]:u.media;if(f!=null&&f.thumbnailUrl){N(f.thumbnailUrl),h("Thumbnail updated.");return}}d(c+1)};d(1)}catch(a){o((a==null?void 0:a.message)??"Failed to regenerate thumbnail.")}finally{F(!1)}}},ue=async()=>{var s;if(!l||!window.confirm("Delete this media item? This cannot be undone."))return;const t=x();if(!t)return;const i=window;if((s=i.auth)!=null&&s.getAccessToken){V(!0),o(null);try{const a=await new Promise(d=>i.auth.getAccessToken(d)),n=await p(`${t}/media?id=${encodeURIComponent(l)}`,{method:"DELETE",headers:{Authorization:`Bearer ${a}`}});if(!n.ok)throw new Error(await n.text());E("/media")}catch(a){o((a==null?void 0:a.message)??"Failed to delete media.")}finally{V(!1)}}};return I?te?e.jsxs("div",{className:"space-y-6",children:[e.jsx($,{title:"Edit Media"}),e.jsx("p",{className:"text-sm text-slate-400",children:"Loading…"})]}):T&&!v&&!S?e.jsxs("div",{className:"space-y-6",children:[e.jsx($,{title:"Edit Media"}),e.jsx("div",{className:"rounded-md border border-red-500/60 bg-red-500/10 px-3 py-2 text-sm text-red-200",children:T})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsx($,{title:"Edit Media",description:"Update title, description, and categories. The file itself cannot be changed here.",actions:e.jsx(xe,{to:`/media/${encodeURIComponent(l)}`,className:"btn-secondary text-sm !px-4 !py-2",children:"View media"})}),A&&e.jsxs("section",{className:"card overflow-hidden max-w-2xl",children:[e.jsx("p",{className:"px-4 py-2 text-xs font-medium text-slate-400 border-b border-slate-800",children:"Current media"}),e.jsx("div",{className:"p-4 flex justify-center items-center bg-slate-900/40 min-h-[160px]",children:L==="video"?e.jsx("video",{src:A,controls:!0,className:"max-w-full max-h-[50vh] rounded-lg border border-slate-700",playsInline:!0}):e.jsx("img",{src:A,alt:v||"Media",className:"max-w-full max-h-[50vh] w-auto h-auto object-contain rounded-lg border border-slate-700"})}),L==="video"&&e.jsxs("div",{className:"px-4 py-3 border-t border-slate-800 space-y-2",children:[e.jsx("p",{className:"text-xs font-medium text-slate-400",children:"Logo / Thumbnail"}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[C&&e.jsx("img",{src:C,alt:"Thumbnail",className:"h-16 w-auto rounded border border-slate-700 object-cover"}),e.jsx("button",{type:"button",onClick:me,disabled:M,className:"rounded-md border border-slate-600 px-3 py-1.5 text-sm font-medium text-slate-200 hover:bg-slate-800 disabled:opacity-50",children:M?"Regenerating…":"Take screenshot"}),e.jsxs("label",{className:"cursor-pointer rounded-md border border-slate-600 px-3 py-1.5 text-sm font-medium text-slate-200 hover:bg-slate-800",children:[O?"Uploading…":"Add logo",e.jsx("input",{type:"file",accept:"image/png,image/jpeg,image/gif,image/webp",className:"hidden",onChange:de,disabled:O})]}),C&&e.jsx("button",{type:"button",onClick:ce,disabled:J,className:"rounded-md border border-red-500/60 px-3 py-1.5 text-sm font-medium text-red-400 hover:bg-red-500/20 disabled:opacity-50",children:J?"Removing…":"Delete logo"})]})]})]}),e.jsxs("form",{className:"card p-6 space-y-4 max-w-xl",onSubmit:le,children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"Title"}),e.jsx("input",{type:"text",value:v,onChange:t=>D(t.target.value),className:"input-field"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"Description"}),e.jsx("textarea",{value:S,onChange:t=>B(t.target.value),rows:4,className:"input-field resize-y"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"Media categories"}),e.jsx("input",{type:"text",value:R,onChange:t=>K(t.target.value),onFocus:()=>W(!0),placeholder:"Search and select…",className:"input-field w-full",autoComplete:"off"}),ie&&e.jsx("div",{className:"absolute left-0 right-0 top-full z-10 mt-1 max-h-48 overflow-auto scrollbar-thin rounded-md border border-slate-700 bg-slate-900 shadow-lg",children:Q.length?Q.map(t=>e.jsx("button",{type:"button",onClick:()=>re(t.id),className:"block w-full px-3 py-2 text-left text-sm text-slate-200 hover:bg-slate-800",children:t.name},t.id)):e.jsx("p",{className:"px-3 py-2 text-xs text-slate-500",children:"No matches"})}),e.jsx("div",{className:"mt-2 flex flex-wrap gap-1",children:g.map(t=>{const i=G.find(s=>s.id===t);return e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-slate-800 px-2 py-0.5 text-xs text-slate-200",children:[(i==null?void 0:i.name)??t,e.jsx("button",{type:"button",onClick:()=>oe(t),className:"hover:text-red-400","aria-label":"Remove",children:"×"})]},t)})})]}),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsx("button",{type:"submit",disabled:P,className:"btn-primary disabled:opacity-50",children:P?"Saving…":"Save changes"}),e.jsx("button",{type:"button",onClick:ue,disabled:H||P,className:"btn-secondary border-red-500/60 text-red-400 hover:bg-red-500/20 disabled:opacity-50",children:H?"Deleting…":"Delete entry"})]}),Y&&e.jsx("div",{className:"rounded-md border border-emerald-500/60 bg-emerald-500/10 px-3 py-2 text-sm text-emerald-200",children:Y}),T&&e.jsx("div",{className:"rounded-md border border-red-500/60 bg-red-500/10 px-3 py-2 text-sm text-red-200",children:T})]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("h1",{className:"text-2xl font-semibold tracking-tight text-slate-50",children:"Edit Media"}),e.jsx("p",{className:"text-sm text-slate-400",children:"Manager or SuperAdmin access is required."})]})};export{je as default};
