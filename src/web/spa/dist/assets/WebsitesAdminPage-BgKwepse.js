import{d as Me,u as We,a as Je,r as a,h as Ke,c,j as e,L as _e}from"./index-CgafoLrZ.js";import{F as ze}from"./ArrowLeftIcon-BQxqvtWq.js";function p(){if(typeof window>"u")return null;const N=window.API_BASE_URL;return N?N.replace(/\/$/,""):null}const Te=100,He=5*1024*1024,Qe=()=>{const N=Me(),{user:Ue}=We(),[Y,Ae]=Je(),T=Y.get("tab"),De=T==="categories"?"categories":"add",[x,U]=a.useState(De);a.useEffect(()=>{U(T==="categories"?"categories":"add")},[T]);const A=t=>{U(t);const s=new URLSearchParams(Y);t==="categories"?s.set("tab","categories"):s.delete("tab"),Ae(s)},[f,v]=a.useState([]),[S,Z]=a.useState(""),[Q,V]=a.useState(""),[ee,D]=a.useState(""),[te,R]=a.useState(!1),[h,P]=a.useState(null),[g,I]=a.useState(null),[O,y]=a.useState(null),[B,se]=a.useState(""),[b,F]=a.useState([]),[$,ae]=a.useState(""),[G,re]=a.useState(!1),[oe,ne]=a.useState(!1),[ie,le]=a.useState(null),[de,d]=a.useState(null),[ce,ue]=a.useState(!1),q=a.useRef(null),[Re,C]=a.useState(!0),[me,u]=a.useState(null),[M,pe]=a.useState(""),[xe,ge]=a.useState(""),[be,fe]=a.useState(!1),[he,ye]=a.useState(null),[w,we]=a.useState(null),[k,W]=a.useState(""),[J,K]=a.useState(""),[je,Ne]=a.useState(!1),[ve,_]=a.useState(null),[L,Se]=a.useState(null),j=Ke(Ue??null,"manager");a.useEffect(()=>{var n;if(!j)return;const t=p();if(!t)return;const s=window;(n=s.auth)!=null&&n.getAccessToken&&(async()=>{if(!await new Promise(l=>s.auth.getAccessToken(l)))return;const i=await c(`${t}/categories`);if(!i.ok)return;const o=((await i.json()).categories??[]).map(l=>({id:l.PK||l.id||"",name:l.name||l.PK||"",description:l.description}));v(o)})()},[j]),a.useEffect(()=>{function t(s){q.current&&!q.current.contains(s.target)&&re(!1)}if(G)return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[G]);const Ce=f.filter(t=>!b.includes(t.id)&&(!$.trim()||(t.name||"").toLowerCase().includes($.toLowerCase()))),Pe=t=>{var i;const s=(i=t.target.files)==null?void 0:i[0];if(P(s??null),s&&se(""),y(null),g&&(URL.revokeObjectURL(g),I(null)),!s)return;if(s.size>He){y("Logo must be 5 MB or smaller.");return}const n=new Image;n.onload=()=>{if(n.naturalWidth<Te||n.naturalHeight<Te){y("Logo must be at least 100×100 pixels.");return}y(null),I(URL.createObjectURL(s))},n.onerror=()=>y("Please choose a valid image file."),n.src=URL.createObjectURL(s)},Ie=t=>{b.includes(t)||F([...b,t]),ae("")},Oe=t=>{F(b.filter(s=>s!==t))},ke=async()=>{var n;const t=p();if(!t){u("API URL not set."),C(!1);return}if(!((n=window.auth)!=null&&n.getAccessToken)){u("Sign in required."),C(!1);return}C(!0),u(null);try{const i=await c(`${t}/categories`);if(!i.ok)throw new Error(await i.text());const o=((await i.json()).categories??[]).map(l=>({id:l.PK||l.id||"",name:l.name||l.PK||"",description:l.description}));v(o)}catch(i){u((i==null?void 0:i.message)??"Failed to load categories.")}finally{C(!1)}};a.useEffect(()=>{j&&x==="categories"&&ke()},[j,x]);const Be=async()=>{var i;const t=S.trim();if(!t){d("Enter URL first.");return}const s=p();if(!s){d("API URL not set.");return}if(!((i=window.auth)!=null&&i.getAccessToken)){d("Sign in required.");return}ue(!0),d(null);try{const r=await c(`${s}/sites/generate-description`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:t})});if(!r.ok)throw new Error(await r.text());const o=await r.json();D(o.description??""),R(!0)}catch(r){d((r==null?void 0:r.message)??"Failed to generate description.")}finally{ue(!1)}},Fe=async t=>{var r;t.preventDefault();const s=S.trim();if(!s){d("URL is required.");return}const n=p();if(!n){d("API URL not set.");return}if(!((r=window.auth)!=null&&r.getAccessToken)){d("Sign in required.");return}if(!(h&&O)){ne(!0),d(null),le(null);try{let o=null;if(B.trim()){const m=await c(`${n}/sites/logo-from-url`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({siteId:"new",imageUrl:B.trim()})});if(!m.ok){const X=await m.json().catch(()=>({}));throw new Error(X.error||await m.text())}const E=await m.json();E.key&&(o=E.key)}else if(h){const m=await c(`${n}/sites/logo-upload`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({siteId:"new",contentType:h.type||"image/png"})});if(!m.ok)throw new Error("Logo upload request failed");const{uploadUrl:E,key:X}=await m.json();if(!(await fetch(E,{method:"PUT",headers:{"Content-Type":h.type||"image/png"},body:h})).ok)throw new Error("Logo upload failed");o=X}const l={url:s,title:Q.trim()||s,description:ee.trim(),categoryIds:b};te&&(l.descriptionAiGenerated=!0),o&&(l.logoKey=o);const H=await c(`${n}/sites`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)});if(!H.ok)throw new Error(await H.text());const Ee=await H.json();le(`Site added: ${Ee.title||Ee.url||s}`),Z(""),V(""),D(""),R(!1),P(null),g&&URL.revokeObjectURL(g),I(null),F([]),setTimeout(()=>N("/websites"),1500)}catch(o){d((o==null?void 0:o.message)??"Failed to add site.")}finally{ne(!1)}}},$e=t=>{we(t.id),W(t.name),K(t.description??"")},z=()=>{we(null),W(""),K(""),_(null)},Ge=async t=>{var i;if(t.preventDefault(),!w)return;const s=p();if(!(!s||!((i=window.auth)!=null&&i.getAccessToken))){Ne(!0),_(null);try{const r=await c(`${s}/categories`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:w,name:k.trim(),description:J.trim()||void 0})});if(!r.ok)throw new Error(await r.text());v(o=>o.map(l=>l.id===w?{...l,name:k.trim(),description:J.trim()||void 0}:l)),z()}catch(r){_((r==null?void 0:r.message)??"Failed to update category.")}finally{Ne(!1)}}},Le=async t=>{var i;if(!window.confirm("Delete this category? Sites using it will lose this category."))return;const s=p();if(!(!s||!((i=window.auth)!=null&&i.getAccessToken))){Se(t);try{const r=await c(`${s}/categories?id=${encodeURIComponent(t)}`,{method:"DELETE"});if(!r.ok)throw new Error(await r.text());v(o=>o.filter(l=>l.id!==t)),w===t&&z()}catch(r){u((r==null?void 0:r.message)??"Failed to delete category.")}finally{Se(null)}}},qe=async t=>{var r;t.preventDefault();const s=M.trim();if(!s)return;const n=p();if(!(!n||!((r=window.auth)!=null&&r.getAccessToken))){fe(!0),ye(null),u(null);try{const o=await c(`${n}/categories`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:s,description:xe.trim()})});if(!o.ok)throw new Error(await o.text());pe(""),ge(""),ye("Category created."),ke()}catch(o){u((o==null?void 0:o.message)??"Failed to create category.")}finally{fe(!1)}}};return j?e.jsxs("div",{className:"space-y-6",children:[e.jsxs(_e,{to:"/websites",className:"inline-flex items-center gap-1 text-sm text-slate-400 hover:text-slate-200",children:[e.jsx(ze,{className:"h-4 w-4"}),"Back to Websites"]}),e.jsxs("header",{className:"space-y-2",children:[e.jsx("h1",{className:"text-2xl font-semibold tracking-tight text-slate-50",children:"Websites"}),e.jsx("p",{className:"text-sm text-slate-400",children:"Add sites and manage website categories."})]}),e.jsxs("div",{className:"flex gap-2 border-b border-slate-800 pb-2",children:[e.jsx("button",{type:"button",onClick:()=>A("add"),className:`px-4 py-2 rounded-md text-sm font-medium ${x==="add"?"bg-slate-800 text-slate-100":"text-slate-400 hover:text-slate-200"}`,children:"Add Site"}),e.jsx("button",{type:"button",onClick:()=>A("categories"),className:`px-4 py-2 rounded-md text-sm font-medium ${x==="categories"?"bg-slate-800 text-slate-100":"text-slate-400 hover:text-slate-200"}`,children:"Website Categories"})]}),x==="add"&&e.jsxs("form",{className:"space-y-4 max-w-xl",onSubmit:Fe,children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"URL *"}),e.jsx("input",{type:"url",value:S,onChange:t=>Z(t.target.value),placeholder:"https://example.com",required:!0,className:"w-full rounded-md border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500 focus:border-brand-orange focus:outline-none focus:ring-1 focus:ring-brand-orange"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"Title (optional)"}),e.jsx("input",{type:"text",value:Q,onChange:t=>V(t.target.value),placeholder:"Display title",className:"w-full rounded-md border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500 focus:border-brand-orange focus:outline-none focus:ring-1 focus:ring-brand-orange"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"Description (optional)"}),e.jsx("textarea",{value:ee,onChange:t=>{D(t.target.value),R(!1)},placeholder:"Short description",rows:4,className:"w-full rounded-md border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500 focus:border-brand-orange focus:outline-none focus:ring-1 focus:ring-brand-orange"}),e.jsx("button",{type:"button",onClick:Be,disabled:ce||!S.trim(),className:"mt-2 rounded-md border border-slate-700 bg-slate-800 px-3 py-1.5 text-xs font-medium text-slate-200 hover:bg-slate-700 disabled:opacity-50",children:ce?"Generating…":"Generate AI description"}),te&&e.jsx("span",{className:"ml-2 text-xs uppercase tracking-wide text-slate-500",children:"AI summary"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"Logo (optional, min 100×100, max 5 MB)"}),e.jsx("input",{type:"file",accept:"image/png,image/jpeg,image/gif,image/webp",onChange:Pe,className:"block w-full text-xs text-slate-300 file:mr-3 file:rounded-md file:border-0 file:bg-slate-800 file:px-3 file:py-1.5 file:text-slate-100"}),e.jsx("p",{className:"mt-2 text-xs text-slate-500",children:"Or paste image URL (image will be copied to S3 on save):"}),e.jsx("input",{type:"url",value:B,onChange:t=>{se(t.target.value),t.target.value.trim()&&P(null)},placeholder:"https://example.com/logo.png",className:"mt-1 w-full rounded-md border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500 focus:border-brand-orange focus:outline-none focus:ring-1 focus:ring-brand-orange"}),g&&e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:g,alt:"Preview",className:"h-16 w-16 rounded-lg border border-slate-700 object-cover"})}),O&&e.jsx("p",{className:"mt-1 text-xs text-red-400",children:O})]}),e.jsxs("div",{ref:q,className:"relative",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"Categories (optional)"}),e.jsx("input",{type:"text",value:$,onChange:t=>ae(t.target.value),onFocus:()=>re(!0),placeholder:"Search and select…",className:"w-full rounded-md border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500 focus:border-brand-orange focus:outline-none focus:ring-1 focus:ring-brand-orange"}),G&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"absolute left-0 right-0 top-full z-10 mt-1 max-h-48 overflow-auto scrollbar-thin rounded-md border border-slate-700 bg-slate-900 shadow-lg",children:Ce.length?Ce.map(t=>e.jsx("button",{type:"button",onClick:()=>Ie(t.id),className:"block w-full px-3 py-2 text-left text-sm text-slate-200 hover:bg-slate-800",children:t.name},t.id)):e.jsx("p",{className:"px-3 py-2 text-xs text-slate-500",children:"No matches"})}),f.length===0&&e.jsxs("p",{className:"mt-1 text-xs text-slate-500",children:["No categories."," ",e.jsx("button",{type:"button",onClick:()=>A("categories"),className:"text-brand-orange hover:underline",children:"Create categories"})]})]}),e.jsx("div",{className:"mt-2 flex flex-wrap gap-1",children:b.map(t=>{const s=f.find(n=>n.id===t);return e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-slate-800 px-2 py-0.5 text-xs text-slate-200",children:[(s==null?void 0:s.name)??t,e.jsx("button",{type:"button",onClick:()=>Oe(t),className:"hover:text-red-400","aria-label":"Remove",children:"×"})]},t)})})]}),e.jsx("button",{type:"submit",disabled:oe,className:"inline-flex items-center justify-center rounded-md bg-brand-orange px-4 py-2 text-sm font-semibold text-slate-950 hover:bg-orange-500 disabled:opacity-50",children:oe?"Adding…":"Add Site"}),ie&&e.jsx("div",{className:"rounded-md border border-emerald-500/60 bg-emerald-500/10 px-3 py-2 text-sm text-emerald-200",children:ie}),de&&e.jsx("div",{className:"rounded-md border border-red-500/60 bg-red-500/10 px-3 py-2 text-sm text-red-200",children:de})]}),x==="categories"&&e.jsxs(e.Fragment,{children:[e.jsxs("form",{className:"space-y-3 max-w-md",onSubmit:qe,children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"New category name"}),e.jsx("input",{type:"text",value:M,onChange:t=>pe(t.target.value),placeholder:"e.g. Developer tools",className:"w-full rounded-md border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500 focus:border-brand-orange focus:outline-none focus:ring-1 focus:ring-brand-orange"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-200 mb-1",children:"Description (optional)"}),e.jsx("input",{type:"text",value:xe,onChange:t=>ge(t.target.value),placeholder:"Optional description",className:"w-full rounded-md border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500 focus:border-brand-orange focus:outline-none focus:ring-1 focus:ring-brand-orange"})]}),e.jsx("button",{type:"submit",disabled:be||!M.trim(),className:"inline-flex items-center justify-center rounded-md bg-brand-orange px-4 py-2 text-sm font-semibold text-slate-950 hover:bg-orange-500 disabled:opacity-50",children:be?"Creating…":"Create category"}),he&&e.jsx("div",{className:"rounded-md border border-emerald-500/60 bg-emerald-500/10 px-3 py-2 text-sm text-emerald-200",children:he}),me&&e.jsx("div",{className:"rounded-md border border-red-500/60 bg-red-500/10 px-3 py-2 text-sm text-red-200",children:me})]}),e.jsxs("section",{children:[e.jsx("h2",{className:"text-sm font-medium text-slate-300 mb-2",children:"Existing categories"}),Re?e.jsx("p",{className:"text-sm text-slate-500",children:"Loading…"}):f.length===0?e.jsx("p",{className:"text-sm text-slate-500",children:"No categories yet. Create one above."}):e.jsx("ul",{className:"space-y-2",children:f.map(t=>e.jsx("li",{className:"rounded-lg border border-slate-800 bg-slate-950/60 px-3 py-2 text-sm",children:w===t.id?e.jsxs("form",{onSubmit:Ge,className:"space-y-2",children:[e.jsx("input",{type:"text",value:k,onChange:s=>W(s.target.value),placeholder:"Name",required:!0,className:"w-full rounded-md border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500 focus:border-brand-orange focus:outline-none focus:ring-1 focus:ring-brand-orange",autoFocus:!0}),e.jsx("input",{type:"text",value:J,onChange:s=>K(s.target.value),placeholder:"Description (optional)",className:"w-full rounded-md border border-slate-700 bg-slate-950 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500 focus:border-brand-orange focus:outline-none focus:ring-1 focus:ring-brand-orange"}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsx("button",{type:"submit",disabled:je||!k.trim(),className:"rounded-md bg-brand-orange px-3 py-1.5 text-xs font-medium text-slate-950 hover:bg-orange-500 disabled:opacity-50",children:je?"Saving…":"Save"}),e.jsx("button",{type:"button",onClick:z,className:"rounded-md border border-slate-700 px-3 py-1.5 text-xs font-medium text-slate-300 hover:bg-slate-800",children:"Cancel"}),e.jsx("button",{type:"button",onClick:()=>Le(t.id),disabled:L===t.id,className:"rounded-md border border-red-500/60 px-3 py-1.5 text-xs font-medium text-red-400 hover:bg-red-500/20 disabled:opacity-50",children:L===t.id?"Deleting…":"Delete"})]}),ve&&e.jsx("p",{className:"text-xs text-red-400",children:ve})]}):e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("button",{type:"button",onClick:()=>$e(t),className:"flex-1 min-w-0 text-left hover:bg-slate-800/50 rounded px-1 -mx-1 py-1 -my-1 transition-colors",children:[e.jsx("span",{className:"font-medium text-slate-200",children:t.name}),t.description&&e.jsx("span",{className:"text-slate-500 truncate max-w-xs ml-2",children:t.description})]}),e.jsx("button",{type:"button",onClick:()=>Le(t.id),disabled:L===t.id,className:"rounded px-2 py-1 text-xs font-medium text-red-400 hover:bg-red-500/20 disabled:opacity-50 shrink-0","aria-label":"Delete category",children:L===t.id?"…":"Delete"})]})},t.id))})]})]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("h1",{className:"text-2xl font-semibold tracking-tight text-slate-50",children:"Websites"}),e.jsx("p",{className:"text-sm text-slate-400",children:"Manager or SuperAdmin access is required."})]})};export{Qe as default};
